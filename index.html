<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Toob</title>
    <link rel="icon" type="image/x-icon" href="./toob.svg">
    <link rel="manifest" href="manifest.json" />
    <style>
        :root {
            --highlight: #36b;
            /* #3088D4 */
        }

        @media (prefers-color-scheme: light) {
            :root {
                --color: #333;
                --bg: #eee;
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color: #eee;
                --bg: #333;
            }
        }

        body {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: small;
            max-width: 800;
            margin: auto;
            background-color: var(--bg);
            color: var(--color);
        }

        body>div {
            display: none;
            margin-top: 38px;
            margin-left: 36px;
        }

        #topnav {
            position: fixed;
            z-index: 1;
            display: block;
            width: calc(800px - 32px);
            margin-left: 35px;
            max-width: calc(100% - 36px);
            top: 0px;
            background-color: var(--bg);
            box-shadow: 0 3px 3px var(--color);
        }

        #topnav h4 {
            margin: .4em;
        }

        #sidenav {
            position: fixed;
            top: 0px;
            width: 32px;
            height: 100%;
            background-color: var(--bg);
            box-shadow: 3px 0px 2px var(--color);
            overflow-y: scroll;
            scrollbar-width: none;
        }

        #sidenav::-webkit-scrollbar {
            display: none;
        }

        #sidenav svg {
            margin-top: .5em;
        }

        #sidenav a svg,
        .link a svg {
            color: var(--color);
        }

        #sidenav a.active svg {
            color: var(--highlight);
        }

        @keyframes new {
            0% {
                background-color: var(--bg);
                color: var(--highlight);
            }

            50% {
                background-color: var(--highlight);
                color: var(--bg);
            }

            100% {
                background-color: var(--bg);
                color: var(--highlight);
            }
        }

        #sidenav a.new svg {
            animation-name: new;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            border-radius: .3em;
        }

        a {
            color: var(--highlight);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .status {
            border: 1px solid var(--color);
            border-radius: .3em;
            margin: .2em;
            padding: .2em;
            overflow: hidden;
        }

        button,
        label.button,
        select {
            border: none;
            color: #eee;
            background-color: var(--highlight);
            border: var(--highlight) 1px solid;
            padding: 4px 8px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1.2em;
            border-radius: .5em;
            cursor: pointer;
        }

        button.outline {
            background-color: var(--bg);
            color: var(--highlight)
        }

        select {
            vertical-align: middle;
            height: 32px;
        }

        input[type="file"] {
            display: none;
        }

        .author {
            float: left;
        }

        .author .account {
            font-size: smaller;
        }

        .sm-avatar {
            max-width: 20;
        }

        .notif {
            border-bottom: 1px solid var(--color);
        }

        .boost img {
            max-width: 15;
        }

        .boost {
            font-size: smaller;
        }

        .text {
            clear: both;
            overflow: auto;
        }

        .text p a span.invisible {
            display: none;
        }

        .text p a span.ellipsis::after {
            content: 'â€¦';
        }

        .text p {
            text-align: justify;
        }

        .media {
            text-align: center;
            margin-top: .5em;
        }

        .media.multi {
            overflow-x: scroll;
            overflow-y: hidden;
            white-space: nowrap;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .media * {
            max-width: 100%;
        }

        .media.multi * {
            max-width: 95%;
        }

        img+img {
            margin-left: .2em;
        }

        .card {
            width: 90%;
            margin: auto;
            border-radius: .3em;
            border: 1px solid var(--color);
            height: 100px;
            overflow: hidden;
            overflow-y: auto;
        }

        .iframe {
            width: 90%;
            margin: auto;
            border-radius: .3em;
            border: 1px solid var(--color);
            height: 300px;
        }

        .iframe iframe {
            width: 100%;
            height: 100%;
        }

        .card img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            float: left;
            margin-right: .3em;
        }

        .card .title {
            font-weight: bold;
        }

        .status .status {
            border: none;
            border-radius: 0;
            border-left: 1px solid var(--color);
            padding-right: 0;
            margin-right: 0;
        }

        .actions {
            text-align: right;
            float: right;
        }

        .actions i {
            font-style: normal;
            font-size: large;
        }

        .actions span {
            border-radius: .3em;
            padding: .3em;
            cursor: pointer;
            border: 1px solid var(--color);
        }

        .focus>.text {
            font-size: larger;
        }

        .status.fav>div.actions>.fav,
        .status.reb>div.actions>.reb {
            background-color: var(--highlight);
            color: var(--bg);
            border: var(--highlight) solid 1px;
        }

        #write>textarea {
            display: block;
            width: 100%;
            font-family: inherit;
        }

        textarea {
            border-radius: .3em;
            border: 1px solid #333;
        }

        img.emoji {
            max-width: 1em;
        }

        .status[in_reply_to_id] {
            border-left: 2px solid var(--highlight);
        }

        #account .header {
            width: 100%;
        }

        #account .avatar {
            width: 100;
        }

        #settings button svg {
            width: 24px;
            height: 24px;
        }

        .editthread .post {
            display: flex;
            align-items: center;
            clear: both;
            min-height: 48px;
        }

        .editthread>* {
            margin: .1em;
        }

        .editthread>textarea {
            font-family: inherit;
            font-size: small;
            min-height: 300px;
            width: 99%;
        }

        .media_attachments textarea {
            font-family: inherit;
            font-size: small;
            height: 6em;
        }

        .editthread button {
            height: 32px;
            max-height: 32px;
        }

        .editthread label {
            height: 24px;
            max-height: 24px;
        }

        .media_attachments {
            clear: both;
        }

        .media_attachments>div {
            display: none;
        }

        .media_attachments>div>img {
            width: calc(50% - 25px)
        }

        .media_attachments>div>textarea {
            width: calc(50% - 25px)
        }

        .media_attachments>div>button {
            height: 40px;
            margin-bottom: 24px;
        }

        #sidenav svg,
        #sidenav img,
        #modal svg {
            width: 24px;
            height: 24px;
            display: inline-block;
        }

        .actions svg {
            width: 18px;
            height: 18px;
        }

        .actions>span {
            height: 18px;
            display: inline-block;
        }

        body>svg {
            height: 1px;
        }

        #write svg {
            height: 24px;
            width: 24px;
        }

        #write button,
        #write label {
            vertical-align: middle;
        }

        .gras {
            font-weight: bold;
        }

        #modal {
            display: none;
            position: fixed;
            z-index: 2;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            margin: 0px;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal-content {
            background-color: var(--bg);
            margin: auto;
            margin-top: 4em;
            padding: 20px;
            border: 1px solid var(--color);
            width: 60%;
        }

        #modal .close {
            color: var(--highlight);
            float: right;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #accounts img,
        #topnav svg {
            height: 1em;
            width: 1em;
            margin-left: .3em;
        }

        #sidenav img.active {
            border: var(--highlight) solid 2px
        }

        nav h1 a {
            position: relative;
            display: inline-block;
        }

        nav h1 a svg {
            display: block;
        }

        nav h1 a img {
            width: 70%;
            position: absolute;
            top: 24px;
            left: 12px
        }

        .status.quo:before {
            display: block;
            stroke: var(--highlight);
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='10' y1='8' x2='10' y2='12'%3E%3C/line%3E%3Cline x1='14' y1='8' x2='14' y2='12'%3E%3C/line%3E%3Cpath d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'%3E%3C/path%3E%3C/svg%3E");
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='10' y1='8' x2='10' y2='12'%3E%3C/line%3E%3Cline x1='14' y1='8' x2='14' y2='12'%3E%3C/line%3E%3Cpath d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'%3E%3C/path%3E%3C/svg%3E");
            background-color: var(--highlight);
            mask-size: cover;
            -webkit-mask-size: cover;
            height: 28px;
            width: 28px;
            float: left;
            content: '';
        }

        .status.quo {
            border: var(--highlight) solid;
            border-radius: .3em;
            padding: .1em;
            width: 95%;
            margin: auto;
        }
    </style>
</head>

<body>
    <svg>
        <defs>
            <symbol id="home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" class="feather feather-home">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </symbol>
            <symbol id="public" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </symbol>
            <symbol id="pen" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                <path d="M2 2l7.586 7.586"></path>
                <circle cx="11" cy="11" r="2"></circle>
            </symbol>
            <symbol id="bell" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </symbol>
            <symbol id="logout" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </symbol>
            <symbol id="tree" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="18" cy="18" r="3"></circle>
                <circle cx="6" cy="6" r="3"></circle>
                <path d="M6 21V9a9 9 0 0 0 9 9"></path>
            </symbol>
            <symbol id="rep" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 10 4 15 9 20"></polyline>
                <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
            </symbol>
            <symbol id="reb" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="17 1 21 5 17 9"></polyline>
                <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                <polyline points="7 23 3 19 7 15"></polyline>
                <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
            </symbol>
            <symbol id="star" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                </polygon>
            </symbol>
            <symbol id="cancel" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="9" x2="15" y2="15"></line>
                <line x1="15" y1="9" x2="9" y2="15"></line>
            </symbol>
            <symbol id="send" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </symbol>
            <symbol id="plus" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </symbol>
            <symbol id="camera" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </symbol>
            <symbol id="searchi" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </symbol>
            <symbol id="trendi" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </symbol>
            <symbol id="quote" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="10" y1="8" x2="10" y2="12"></line>
                <line x1="14" y1="8" x2="14" y2="12"></line>
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </symbol>
            <symbol id="i-adduser" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </symbol>
            <symbol id="gear" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
            </symbol>
            <symbol id="globe" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                </path>
            </symbol>
            <symbol id="blank" viewBox="0 0 24 24"></symbol>
        </defs>
    </svg>
    <nav id="sidenav">
        <h1>
            <a href="#write"><svg>
                    <use href="#pen" />
                </svg></a>
            <a href="#search"><svg>
                    <use href="#searchi" />
                </svg></a>
        </h1>
        <hr />
        <a href="#adduser"><svg>
                <use href="#i-adduser" />
            </svg></a>
        <a href="#settings"><svg>
                <use href="#gear" />
            </svg></a>
    </nav>
    <nav id="topnav">
        <h4 id="title"></h4>
    </nav>
    <div id="timeline"></div>
    <div id="status"></div>
    <div id="account"></div>

    <div id="write">
        <div class="editthread" attach="0">
            <!-- <div class="post"> -->
            <input type="hidden" id="in_reply_to_id" />
            <textarea class="text" placeholder="What's on your mind?"></textarea>
            <span class="size"></span>
            <br /><label class="button"><input type="file" accept="image/*" /><svg>
                    <use href="#camera" />
                </svg></label>
            <!-- </div> -->
            <div class="media_attachments">
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
            </div>
        </div>
        <button id="bplus"><svg>
                <use href="#plus" />
            </svg></button>
        <select id="visibility">
            <option value="public">Public</option>
            <option value="unlisted">Unlisted</option>
            <option value="private">Private</option>
            <option value="direct">Mentions</option>
        </select>
        <select id="lang">
            <option value="fr">FR</option>
            <option value="en">EN</option>
        </select>
        <button id="toob"><svg>
                <use href="#send" />
            </svg></button>
        <!-- <div id="log"></div> -->
    </div>
    <div id="search">
        <input type="text" placeholder="Search terms" />
    </div>
    <div id="login">
        <input type="text" id="instance" placeholder="https://piaille.fr" />
        <button id="loginb">Se connecter</button>
    </div>
    <div id="settings">
        <div id="colors">
        </div>
    </div>
    <div id="modal">
        <div class="modal-content">
            <span class="close"><svg>
                    <use href="#cancel" />
                </svg></span>
            <p>Some text in the Modal..</p>
            <button class="OK">OK</button>
        </div>
    </div>
    <script>
        navigator.serviceWorker.register('service-worker.js', { scope: '.' })
            .then(function (registration) {
                console.log('Service worker registered successfully');
            }).catch(function (e) {
                console.error('Error during service worker registration:', e);
            });
        //login dance
        account = window.localStorage.getItem('activeAccount') || 0
        code = new URLSearchParams(window.location.search).get('code')
        if (code) {//we got a code back from a user consenting to login
            fd = new FormData();
            clients = JSON.parse(window.localStorage.getItem('clients'))
            inst = window.localStorage.getItem('instance')
            fd.append('client_id', clients[inst].client_id)
            fd.append('client_secret', clients[inst].client_secret)
            fd.append('grant_type', 'authorization_code')
            fd.append('redirect_uri', window.location.protocol + '//' + window.location.host + window.location.pathname)
            fd.append('code', code)
            fd.append('scope', 'read write')
            ajax(inst + "/oauth/token", {
                method: 'POST',
                data: {
                    client_id: clients[inst].client_id, client_secret: clients[inst].client_secret, grant_type: 'authorization_code',
                    redirect_uri: window.location.protocol + '//' + window.location.host + window.location.pathname,
                    code: code, scope: 'read write'
                },
                success: function (data) {
                    accounts = JSON.parse(window.localStorage.getItem('accounts') || '[]')
                    accounts.push({ instance: inst, at: JSON.parse(data).access_token })
                    window.localStorage.setItem('accounts', JSON.stringify(accounts))
                    window.localStorage.removeItem('instance')
                    window.location.href = window.location.pathname
                }
            }
            )
        }
        s('#loginb').onclick = function () {
            inst = s('#instance').value
            if (inst.substring(0, 8) != 'https://') inst = 'https://' + inst

            clients = JSON.parse(window.localStorage.getItem('clients')) || {}
            if (!clients[inst]) { // we first need a client_id/client_secret to connect to this instance

                ajax(inst + "/api/v1/apps", {
                    method: 'POST',
                    data: {
                        client_name: 'Toob', redirect_uris: window.location.protocol + '//' + window.location.host + window.location.pathname,
                        scopes: 'read write', website: "https://github.com/teddyber/toob"
                    }, success: function (data) {
                        data = JSON.parse(data)
                        // clients = {}
                        clients[inst] = { 'client_id': data.client_id, 'client_secret': data.client_secret }
                        window.localStorage.setItem('clients', JSON.stringify(clients))
                        window.localStorage.setItem('instance', inst)
                        window.location.href = `${inst}/oauth/authorize?client_id=${data.client_id}&scope=read+write&redirect_uri=${window.location.protocol + '//' + window.location.host + window.location.pathname}&response_type=code`
                    }
                })
            }
            else {
                window.localStorage.setItem('instance', inst)
                window.location.href = `${inst}/oauth/authorize?client_id=${JSON.parse(window.localStorage.getItem('clients'))[inst].client_id}&scope=read+write&redirect_uri=${window.location.protocol + '//' + window.location.host + window.location.pathname}&response_type=code`
            }
        }
        function getClient(inst, callback) {
            clients = JSON.parse(window.localStorage.getItem('clients'))
            if (clients[inst] !== undefined) {
                callback({ client_id: clients[inst].client_id, client_secret: clients[inst].client_secret })
            } else {
                ajax(inst + "/api/v1/apps", {
                    method: 'POST',
                    data: {
                        client_name: 'Toob', redirect_uris: window.location.protocol + '//' + window.location.host + window.location.pathname,
                        scopes: 'read write', website: "https://github.com/teddyber/toob"
                    }, success: function (data) {
                        data = JSON.parse(data)
                        // clients = {}
                        clients[inst] = { 'client_id': data.client_id, 'client_secret': data.client_secret }
                        window.localStorage.setItem('clients', JSON.stringify(clients))
                        callback({ client_id: data.client_id, client_secret: data.client_secret })
                        // window.localStorage.setItem('instance', inst)
                        // window.location.href = `${inst}/oauth/authorize?client_id=${data.client_id}&scope=read+write&redirect_uri=${window.location.protocol + '//' + window.location.host + window.location.pathname}&response_type=code`
                    }
                })
            }
        }
        whichTimeline = '';
        lastAccountId = '';
        lastStatusId = '';
        maxId = 999999999999999999
        waitingFor = 999999999999999999

        window.addEventListener('hashchange', (event) => {
            display();
        });


        function s(p) { return document.querySelector(p); }// Select node from Pattern
        function sa(p) { return document.querySelectorAll(p); }// Select All nodes from Pattern
        function n(h) { return document.createRange().createContextualFragment(h) } // create Node from Html

        function getInstance(account) {
            return JSON.parse(window.localStorage.getItem('accounts') || '{}')[account] ? JSON.parse(window.localStorage.getItem('accounts') || '{}')[account].instance : null
        }
        function display() {
            s('body').append(s('#write'))
            hash = window.location.hash.split('/')[0]
            switch (hash) {
                case '#logout':
                    accounts = JSON.parse(window.localStorage.getItem('accounts'))
                    delete accounts[account]
                    window.localStorage.setItem('accounts', JSON.stringify(accounts))
                    window.localStorage.removeItem('instance')
                    window.location.href = window.location.pathname;
                    break;
                case '#settings':
                    showOnly('#settings')
                    break;
                case '#adduser':
                    showOnly('#login')
                    break;
                case '#login':
                    showOnly('#login')
                    s('#title').innerHTML = `<svg><use href="#adduser" /></svg> Login`
                    break;
                case '#home':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#home" /></svg> ${accounts[window.location.hash.split('/')[1]].display_name} (@${accounts[window.location.hash.split('/')[1]].acct}@${accounts[window.location.hash.split('/')[1]].url.match(/\/\/[\w\.]+\//)[0].replaceAll('/', '')})`
                    updateTimeline('timelines/home', window.location.hash.split('/')[1]);
                    break;
                case '#trend':
                    showOnly('#timeline')
                    updateTimeline('timelines/trend');
                    break;
                case '#notifications':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#bell" /></svg> ${accounts[window.location.hash.split('/')[1]].display_name} (@${accounts[window.location.hash.split('/')[1]].acct}@${accounts[window.location.hash.split('/')[1]].url.match(/\/\/[\w\.]+\//)[0].replaceAll('/', '')})`
                    updateNotifications('notifications', window.location.hash.split('/')[1]);
                    break;
                case '#write':
                    showOnly('#write')
                    s('#title').innerHTML = `<svg><use href="#pen" /></svg> Write with ${accounts[account].display_name} (@${accounts[account].acct}@${accounts[account].url.match(/\/\/[\w\.]+\//)[0].replaceAll('/', '')})`
                    s('#write div.editthread:last-of-type textarea').focus()
                    break;
                case '#federated':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#public" /></svg> ${accounts[window.location.hash.split('/')[1]].display_name} (@${accounts[window.location.hash.split('/')[1]].acct}@${accounts[window.location.hash.split('/')[1]].url.match(/\/\/[\w\.]+\//)[0].replaceAll('/', '')})`
                    updateTimeline('timelines/public', window.location.hash.split('/')[1]);
                    break;
                case '#public':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#public" /></svg> ${accounts[window.location.hash.split('/')[1]].display_name} (@${accounts[window.location.hash.split('/')[1]].acct}@${accounts[window.location.hash.split('/')[1]].url.match(/\/\/[\w\.]+\//)[0].replaceAll('/', '')})`
                    updateTimeline('timelines/public?local=true', window.location.hash.split('/')[1]);
                    break;
                case '#search':
                    showOnly('#search')
                    s('#title').innerHTML = `<svg><use href="#search" /></svg> Search with ${accounts[account].display_name} (@${accounts[account].acct}@${accounts[account].url.match(/\/\/[\w\.]+\//)[0].replaceAll('/', '')})`
                    updateSearch(window.location.hash.substring(8));
                    break;
                case '#tags':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#tag" /></svg> #${window.location.hash.split('/')[1]} with ${accounts[account].display_name} (@${accounts[account].acct}@${accounts[account].url.match(/\/\/[\w\.]+\//)[0].replaceAll('/', '')})`
                    updateTimeline('timelines/tag/' + window.location.hash.split('/')[1], window.location.hash.split('/')[2]);
                    break;
                case '#account':
                    showOnly('#account')
                    updateAccount(window.location.hash.substring(9));
                    break;
                case '#status':
                    showOnly('#status')
                    updateStatus(window.location.hash.substring(8))
                    break;
                case '#remote':
                    showOnly('#account')
                    updateRemoteAccount(window.location.hash.substring(8))
                    break;

                default:
                    break;
            }
        }
        function updateSearch(term) {
            s('#search input').value = term
            s('#search input').focus()
            s('#search input').onchange()
        }
        s('#search input').onchange = function () {
            window.location.hash = '#search/' + this.value
            ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + this.value, {
                headers: { 'Authorization': 'Bearer ' + getAT(account) },
                success: function (data) {
                    data = JSON.parse(data)
                    sa('#search .status, #search .account, #search .hashtags').forEach(e => { e.remove() })
                    data.accounts.forEach(e => { s('#search').append(n(`<div class="account"><a href="#account/${account}/${e.id}"><img loading="lazy" class="sm-avatar" src="${e.avatar}"/>${e.display_name} (${e.acct})</a></div>`)) })
                    data.hashtags.forEach(e => { s('#search').append(n(`<div class="hashtags"><a href="#tags/${e.name}/${account}">#${e.name}</a></div>`)) })
                    data.statuses.forEach(e => { s('#search').append(n(displayStatus(e, account))) })
                    tweak();
                }
            })
        }
        function showModal(text, confirm) {
            s('#modal p').innerHTML = text
            s('#modal').style.display = 'block'
            s('#modal button.OK').onclick = function () { confirm(); s('#modal').style.display = 'none' }
        }
        s('.close').onclick = function () { s('#modal').style.display = 'none' }
        s('#modal').onclick = function () { s('#modal').style.display = 'none' }
        function showOnly(div) {
            sa('body > div').forEach(e => { e.style.display = 'none' })
            s(div).style.display = 'block'
            sa('#sidenav a').forEach(e => { e.classList.remove('active') })
            if (s(`[href^="${window.location.hash}"]`)) s(`[href^="${window.location.hash}"]`).classList.add('active')
        }
        function getAT(account) {
            return JSON.parse(window.localStorage.getItem('accounts') || '[]')[account] ? JSON.parse(window.localStorage.getItem('accounts') || '[]')[account].at : null
        }
        function updateTimeline(which, account = 0) {
            trend = false
            if (which == 'timelines/trend') {
                trend = true
                feed = 'timelines/home'
            }
            else feed = which
            if (which + '/' + account != whichTimeline) {
                whichTimeline = which + '/' + account
                maxId = 999999999999999999
                waitingFor = 999999999999999999

                s('#timeline').textContent = ''
                ajax(getInstance(account) + '/api/v1/' + feed + '?limit=40', {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        JSON.parse(data).forEach(el => {
                            if (!trend || el.replies_count + el.reblogs_count + el.favourites_count > 0) {
                                s('#timeline').append(n(displayStatus(el, account)))
                                if (s('[in_reply_to_id="s' + el.id + '"]')) { // put parent up in the timeline if there's a reply
                                    s('[in_reply_to_id="s' + account + '-' + el.id + '"]').parentNode.insertBefore(s('#s' + account + '-' + el.id), s('[in_reply_to_id="s' + account + '-' + el.id + '"]'))
                                }
                                maxId = Math.min(maxId, el.id)  //  remmeber oldest toot for scrolling
                                sa('[in_reply_to_id="s' + account + '-' + el.id + '"]').forEach(c => {
                                    s('#s' + account + '-' + el.id).appendChild(c)
                                })
                            }
                        });
                        tweak();
                    }
                })
            }
        }
        function lookForNewNotif() {
            if (!window.localStorage.getItem('lastnotif')) window.localStorage.setItem('lastnotif', JSON.stringify([1, 1, 1])) //init TODO better
            for (i = 0; i < accounts.length; i++) {
                lastNotifs = JSON.parse(window.localStorage.getItem('lastnotif'))
                ajax(getInstance(i) + '/api/v1/notifications?limit=1&since_id=' + lastNotifs[i], {
                    headers: {
                        'Authorization': 'Bearer ' + getAT(i)
                    },
                    indexValue: i,
                    success: function (data, xhr) {
                        if (JSON.parse(data).length == 0) return;
                        e = JSON.parse(data)[0]
                        newestNotif = e.id
                        // alert(newestNotif > parseInt(JSON.parse(window.localStorage.getItem('lastnotif'))[xhr.indexValue]))
                        if (newestNotif > parseInt(JSON.parse(window.localStorage.getItem('lastnotif'))[xhr.indexValue])) {
                            sa(`[href="#notifications/${xhr.indexValue}"]`).forEach(e => { e.classList.add('new') })
                            const img = `${e.account.avatar}`;
                            text = e.type
                            if (e.type == 'follow') {
                                title = `${e.account.display_name} (${e.account.acct}) followed you!`;
                                text = `${e.account.note.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            if (e.type == 'favourite') {
                                title = `${e.account.display_name} (${e.account.acct}) favourited your status!`;
                                text = `${e.status.content.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            if (e.type == 'reblog') {
                                title = `${e.account.display_name} (${e.account.acct}) reblogged your status!`;
                                text = `${e.status.content.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            if (e.type == 'mention') {
                                title = `${e.account.display_name} (${e.account.acct}) mentionned you!`;
                                text = `${e.status.content.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            if (e.type == 'poll') {
                                title = `A poll you participated in just ended!`;
                                text = `${e.status.content.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            if (e.type == 'update') {
                                title = `${e.account.display_name} (${e.account.acct}) updated their toot!`;
                                text = `${e.status.content.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            navigator.serviceWorker.ready.then((registration) => {
                                registration.showNotification(title, {
                                    body: text,
                                    icon: img,
                                    badge: 'toob-96.png',
                                    data: { url: './#notifications/' + xhr.indexValue, prefix: window.location.protocol + '//' + window.location.host + window.location.pathname },
                                    tag: e.id,
                                });
                            });
                        }
                    }
                })
            }
        }
        setInterval(lookForNewNotif, 10000)
        function getAccount(account) {
            return new Promise(resolve => {
                ajax(getInstance(account) + '/api/v1/accounts/verify_credentials', {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        resolve(JSON.parse(data))
                    }
                })
            })
        }
        function getAccounts() {
            return new Promise(resolve => {
                accts = JSON.parse(window.localStorage.getItem('accounts'))
                r = []
                for (i = 0; i < accts.length; i++) {
                    r.push(getAccount(i).then(r => { return r }))
                }
                resolve(Promise.all(r))
            })
        }
        accounts = ''
        a = getAccounts().then(a => {
            accounts = a
            if (window.location.hash == '') {
                if (accounts.length > 0)
                    window.location.hash = `#home/${account}`;
                else
                    window.location.hash = '#login';
            } else {
                display()
            }
            displaySideNav()
            displaySettings()
            return a
        })
        columns = JSON.parse(window.localStorage.getItem('columns')) || []
        function displaySettings() {
            document.querySelector(':root').style.setProperty('--highlight', window.localStorage.getItem('color'))
            colors = ['#817', '#a35', '#c66', '#e94', '#ed0', '#9d5', '#4d8', '#2cb', '#0bc', '#09c', '#36b', '#639']
            if (columns.length == 0) { accounts.forEach(a => { columns.push(['home', 'public', 'federated', 'notifications']) }) }
            colors.forEach(c => {
                s('#colors').append(n(`<button style="background-color: ${c};"><svg><use href="#blank" /></svg></button>`))
                sa('#colors button').forEach(b => {
                    b.onclick = function () {
                        document.querySelector(':root').style.setProperty('--highlight', this.style['background-color'])
                        window.localStorage.setItem('color', this.style['background-color'])
                    }
                })
            })
            i = 0;

            accounts.forEach(a => {
                s('#settings').append(n(`<div><span><img loading="lazy" src="${a.avatar}" class="sm-avatar"/> ${a.display_name}
                    <button class="logout" acct="${i}"><svg><use href="#logout"/></svg></button>
                    <button class="resetnotif" acct="${i}"><svg><use href="#bell"/></svg></button>
                    <button class="col outline" acct="${i}" col="home"><svg><use href="#home"/></svg></button>
                    <button class="col outline" acct="${i}" col="public"><svg><use href="#public"/></svg></button>
                    <button class="col outline" acct="${i}" col="federated"><svg><use href="#globe"/></svg></button>
                    <button class="col outline" acct="${i}" col="notifications"><svg><use href="#bell"/></svg></button>
                    </div>`))
                s('#settings').append(n(`<p>${columns}</p>`))
                columns[i].forEach(c => { sa(`[col="${c}"][acct="${i}"]`).forEach(b => { b.classList.remove('outline') }) })
                i++
            })
            sa('button.col').forEach(b => {
                b.onclick = function () {
                    col = b.getAttribute('col')
                    acct = b.getAttribute('acct')
                    if (b.classList.contains('outline')) {
                        columns[acct].push(col)
                        b.classList.remove('outline')
                    } else {
                        columns[acct].splice(columns[acct].indexOf(col), 1)
                        b.classList.add('outline')
                    }
                    window.localStorage.setItem('columns', JSON.stringify(columns))
                }
            })
            sa('.logout').forEach(b => {
                b.onclick = function () {
                    accounts = JSON.parse(window.localStorage.getItem('accounts')).splice(this.getAttribute('acct'), 1)
                    window.localStorage.setItem('accounts', JSON.stringify(accounts))
                }
            })
            sa('.resetnotif').forEach(b => {
                b.onclick = function () {
                    ln = JSON.parse(window.localStorage.getItem('lastnotif'))
                    ln[this.getAttribute('acct')] = 1
                    window.localStorage.setItem('lastnotif', JSON.stringify(ln))
                }
            })
        }
        function displaySideNav() {
            i = 0
            columns = JSON.parse(window.localStorage.getItem('columns')) || []
            if (columns.length == 0) { accounts.forEach(a => { columns.push(['home', 'public', 'federated', 'notifications']) }) }
            accounts.forEach(a => {
                s('#sidenav h1').append(n(`<hr/><span><img loading="lazy" acct="${i}" class="${i == account ? 'active' : ''}" src="${a.avatar}"/></span>`))
                if (columns[i].includes('home')) s('#sidenav h1').append(n(`<a href="#home/${i}"><svg><use href="#home" /></svg></a>`))
                if (columns[i].includes('public')) s('#sidenav h1').append(n(`<a href="#public/${i}"><svg><use href="#public" /></svg></a>`))
                if (columns[i].includes('federated')) s('#sidenav h1').append(n(`<a href="#federated/${i}"><svg><use href="#globe" /></svg></a>`))
                if (columns[i].includes('notifications')) s('#sidenav h1').append(n(`<a href="#notifications/${i}"><svg><use href="#bell" /></svg></a>`))
                i++
            })
            sa('#sidenav a').forEach(a => { a.onclick = function () { if (this.classList.contains('active')) window.scrollTo({ top: 0, behavior: 'smooth' }); } })
            sa('#sidenav img').forEach(i => {
                i.onclick = function () {
                    sa('#sidenav img').forEach(i => {
                        i.classList.remove('active')
                    })
                    account = this.getAttribute('acct');
                    window.localStorage.setItem('activeAccount', account)
                    this.classList.add('active')
                    whichTimeline = ''
                    display()
                }
            })
        }
        function updateNotifications(which, account = 0) {
            if (Notification.permission == 'default') {
                Notification.requestPermission()
            }
            if (which + '/' + account != whichTimeline) {
                whichTimeline = which + '/' + account
                s('#timeline').textContent = ''
                ajax(getInstance(account) + '/api/v1/' + which, {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        JSON.parse(data).forEach(e => {
                            if (!window.localStorage.getItem('lastnotif')) window.localStorage.setItem('lastnotif', JSON.stringify([1, 1, 1])) //init
                            s('#timeline').append(n(displayNotification(e, account)))
                        })
                        tweak()
                    }
                })
                sa(`[href^="#notifications/${account}"]`).forEach(e => { e.classList.remove('new') })
            }
        }
        function displayNotification(e, acct) {
            // console.log(e)
            lastNotifs = JSON.parse(window.localStorage.getItem('lastnotif'))
            lastNotifs[acct] = Math.max(parseInt(lastNotifs[acct]), parseInt(e.id))
            window.localStorage.setItem('lastnotif', JSON.stringify(lastNotifs))
            maxId = Math.min(maxId, e.id)  //  remember oldest toot for scrolling
            switch (e.type) {
                case 'follow':
                    return `<div class="notif"><p>
                                        <a href="#account/${acct}/${e.account.id}">
                                            <img loading="lazy" class="sm-avatar" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> followed you!</p></div>`
                    break;
                case 'reblog':
                    if (!s(`#reb${e.status.id}`)) {
                        return `<div class="notif" id="reb${e.status.id}"><p><a href="#account/${acct}/${e.account.id}">
                                            <img loading="lazy" class="sm-avatar" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> ${e.status.reblogs_count > 1 ? `and ${e.status.reblogs_count - 1} other${e.status.reblogs_count == 1 ? '' : 's'}` : ''} reblogged your status!</p>
                                ${displayStatus(e.status, acct)}</div>`
                    }
                    break;
                case 'update':
                    return `<div class="notif"><p><a href="#account/${acct}/${e.account.id}">
                                            <img loading="lazy" class="sm-avatar" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> updated their status!</p>
                                ${displayStatus(e.status, acct)}</div>`
                    break;
                case 'favourite':
                    if (!s(`#fav${e.status.id}`)) {
                        return `<div class="notif" id="fav${e.status.id}"><p><a href="#account/${acct}/${e.account.id}">
                                            <img loading="lazy" class="sm-avatar" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> ${e.status.favourites_count > 1 ? `and ${e.status.favourites_count - 1} other${e.status.favourites_count == 2 ? '' : 's'}` : ''} favourited your status!</p>
                                ${displayStatus(e.status, acct)}</div>`
                    } else {
                        s(`#fav${e.status.id} p`).prepend(n(`<img loading="lazy" class="sm-avatar" src="${e.account.avatar}"/>`))
                    }
                    break;
                case 'mention':
                    return `<div class="notif"><p><a href="#account/${acct}/${e.account.id}">
                                            <img loading="lazy" class="sm-avatar" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> mentioned you!</p>
                                ${displayStatus(e.status, acct)}</div>`
                    break;
                case 'poll':
                    return `<div class="notif"><p>A poll you participated in ended!</p>
                                ${displayStatus(e.status, acct)}</div>`
                    break;
                default:
                    console.log(e)
                    break;
            }
            return ''
        }
        function updateStatus(id) {
            var [acct, statusId] = id.split('/')
            if (acct != account) {//we want to display the toot as seen from the currentAccount
                ajax(getInstance(acct) + '/api/v1/statuses/' + statusId, {
                    headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                    success: function (data) {
                        ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + JSON.parse(data).uri, {
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function (data) {
                                updateStatus(account + '/' + JSON.parse(data).statuses[0].id)
                            }
                        })
                    }
                })
            } else {
                if (id == lastStatusId) return;
                lastStatusId = id;
                s('#status').innerHTML = '';

                ajax(getInstance(acct) + '/api/v1/statuses/' + statusId, {
                    headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                    success: function (data) {
                        current = JSON.parse(data)
                        s('#title').innerHTML = `Toot by <img loading="lazy" class="sm-avatar" src="${current.account.avatar}"/> ${replaceEmojis(current.account.emojis, current.account.display_name)}`
                        ajax(getInstance(acct) + '/api/v1/statuses/' + (current.reblog ? current.reblog.id : statusId) + '/context', {
                            headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                            success: function (data) {
                                i = 0;
                                data = JSON.parse(data)
                                data.ancestors.forEach(element => {
                                    s('#status').append(n(displayStatus(element, acct, (i == 0 ? 'top' : 'ancestor'), 't')));
                                    i++
                                });
                                c = current.reblog ? current.reblog : current
                                s('#status').append(n(displayStatus(c, acct, 'focus' + (i == 0 ? ' top' : ''), 't')));
                                data.descendants.forEach(element => {
                                    s('#t' + acct + '-' + element.in_reply_to_id).append(n(displayStatus(element, acct, 'thread', 't')));
                                });
                                tweak();
                            }
                        }
                        )
                    }
                })
            }
        }
        function updateRemoteAccount(accountUri) {
            inst = accountUri.split('@')[1]// match(/https:\/\/[\w\.]+\//)            console.log(inst)
            ajax('https://' + inst + "/api/v2/search?q=" + accountUri, {
                success: function (data) {
                    updateAccount(JSON.parse(data).accounts[0].id, 'https://' + inst)
                }
            })
        }
        function updateAccount(id, inst = null) {
            if (id == lastAccountId) return;
            lastAccountId = id;
            s('#account').innerHTML = '';
            acct = account
            if (!inst) {
                acct = id.split('/')[0]
                inst = getInstance(acct)
                id = id.split('/')[1]
            }
            ajax(inst + '/api/v1/accounts/' + id, {
                success: function (data) {
                    data = JSON.parse(data)
                    html = `
                    <img class="header" src="${data.header}"/>
                    <img class="avatar" src="${data.avatar}"/>
                    <button id="follow" acct="${data.id}"></button><a href="#remote/${data.acct}">See on user's instance</a>
                    <div class="dn">${replaceEmojis(data.emojis, data.display_name)}</div>
                    <div class="acct">${data.acct}</div>
                    <div class="note">${data.note}</div>
                    <div class="follows">Follows ${data.following_count}</div>
                    <div class="followed">Followed by ${data.followers_count}</div>
                    <div class="statuses">Statuses ${data.statuses_count}</div>
                    `
                    s('#account').innerHTML = html
                    s('#title').innerHTML = `<img class="sm-avatar" src="${data.avatar}"/> ${replaceEmojis(data.emojis, data.display_name)} <!--(@${data.acct}${data.acct.indexOf('@') == -1 ? `@${data.url.match(/\/\/[\w\.]+\//)[0].replaceAll('/', '')}` : ''})-->`
                    sa('.note .mention.u-url').forEach(a => {
                        a.removeAttribute('target')
                        ajax(inst + "/api/v2/search?resolve=true&q=" + a.getAttribute('href'), {
                            headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                            success: function (data, xhr) {
                                a.setAttribute('href', '#account/' + acct + '/' + JSON.parse(data).accounts[0].id)
                            }
                        })
                    })
                    s('#follow').onclick = function () {
                        statusPostAction(data.id, data.url, account, this.innerText.toLowerCase())
                    }
                    ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + data.url, {
                        headers: { 'Authorization': 'Bearer ' + getAT(account) },
                        success: function (data) {
                            i = JSON.parse(data).accounts[0].id
                            ajax(getInstance(account) + `/api/v1/accounts/relationships?id[]=${i}`, {
                                headers: { 'Authorization': 'Bearer ' + getAT(account) },
                                success: function (data) {
                                    r = JSON.parse(data)
                                    s('#follow').innerText = r[0].following ? 'Unfollow' : 'Follow'
                                    if (r[0].followed_by) { s('.follows').append(' including you') }
                                }
                            })
                        }
                    })
                }
            })
            ajax(inst + `/api/v1/accounts/${id}/statuses?limit=40`, {
                success: function (data) {
                    JSON.parse(data).forEach(e => {
                        s('#account').append(n(displayStatus(e, acct)))
                    })
                    tweak();
                }
            })
        }
        function statusPostAction(accountId, accountUri, from, action) {
            var [acct, id] = accountId.split('/');
            type = action.endsWith('follow') ? 'accounts' : 'statuses'
            if (acct != from) {
                ajax(getInstance(from) + "/api/v2/search?resolve=true&q=" + accountUri, {
                    headers: { 'Authorization': 'Bearer ' + getAT(from) },
                    success: function (data) {
                        data = JSON.parse(data)
                        statusPostAction(from + '/' + (type ? data[type][0].id : data[type][0].id), accountUri, from, action)
                    }
                })
            } else {
                ajax(getInstance(from) + `/api/v1/${type}/${id}/${action}`, {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + getAT(from) },
                    success: function (data) {
                        if (action.endsWith('follow')) { s('#follow').innerText = s('#follow').innerText == 'Follow' ? 'Unfollow' : 'Follow' }
                        if (action.endsWith('favourite')) {
                            if (action.startsWith('un')) s(`[uri="${accountUri}"`).classList.remove('fav')
                            else { s(`[uri="${accountUri}"`).classList.add('fav') }
                        }
                        if (action.endsWith('reblog')) {
                            if (action.startsWith('un')) s(`[uri="${accountUri}"`).classList.remove('reb')
                            else { s(`[uri="${accountUri}"`).classList.add('reb') }
                        }
                    }
                })
            }
        }
        function tweak(nb = 0) {
            //activate links
            sa('.actions .fav').forEach(e => {
                e.onclick = function () {
                    st = this.parentNode.parentNode
                    statusPostAction(st.getAttribute('id'), st.getAttribute('uri'), account, st.classList.contains('fav') ? 'unfavourite' : 'favourite')
                }
            })
            sa('.actions .reb').forEach(e => {
                e.onclick = function () {
                    st = this.parentNode.parentNode
                    statusPostAction(st.getAttribute('id'), st.getAttribute('uri'), account, st.classList.contains('reb') ? 'unreblog' : 'reblog')
                }
            })
            sa('.actions .del').forEach(e => {
                e.onclick = function () {
                    id = this.parentNode.parentNode.getAttribute('id').substring(1);
                    confirm = showModal('Confirmer la suppression?', function () {
                        ajax(getInstance(account) + `/api/v1/statuses/${id.split('-')[1]}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function () {
                                whichTimeline = ''
                                display()
                            }
                        })
                    })
                }
            })
            sa('a.hashtag').forEach(e => { e.removeAttribute('target') })
            sa('.actions .rep, .actions .quo').forEach(e => {
                e.onclick = function () {
                    id = this.parentNode.parentNode.getAttribute('id').substring(1);
                    if (id.split('-')[0] != account) {
                        ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + this.parentNode.parentNode.getAttribute('uri'), {
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function (data) {
                                data = JSON.parse(data)
                                s('#in_reply_to_id').setAttribute('value', data.statuses[0].id)
                            }
                        })
                    }
                    else {
                        s('#in_reply_to_id').setAttribute('value', id.substring(2))
                    }
                    this.parentNode.parentNode.append(s('#write'))
                    s('#write').style.display = 'block'
                    s('#write textarea').value = '@' + this.getAttribute('author') + ' ' + this.getAttribute('mentions') + ' '
                    s('#write textarea').focus();
                    end = s('#write textarea').selectionEnd
                    start = s('#write textarea').selectionStart - this.getAttribute('mentions').length
                    s('#write textarea').value += `
${this.getAttribute('tags')}`
                    if (this.classList.contains('quo')) {
                        s('#write textarea').value += `
${this.getAttribute('href')}`
                    }
                    s('#write textarea').style.height = Math.max(s('#write textarea').scrollHeight, 50) + 'px';
                    s('#write textarea').selectionStart = start - 1
                    s('#write textarea').selectionEnd = end - 1
                }
            })
            sa('.vote').forEach(e => {
                e.onclick = function () {
                    poll_id = this.getAttribute('id').split('_')[1]
                    own_votes = Array.from(sa('[name="option_' + poll_id + '[]"]:checked')).map(function (i) { return i.getAttribute('id').split('_')[2] })
                    fd = new FormData()
                    fd.append('choices[]', own_votes)
                    ajax(getInstance(account) + `/api/v1/polls/${poll_id}/votes`, {
                        method: 'POST', headers: '',
                        headers: { 'Authorization': 'Bearer ' + getAT(account) },
                        data: { 'choices[]': own_votes },
                        success: function (data) {
                            whichTimeline = ''
                            display()
                        }
                    })
                }
            })
            if (nb < 10)
                sa('div.card.toresolve a').forEach(a => {
                    // if (a.getAttribute('href').match(/^https:\/\/[\w\.]+\/@\w+\/\d+$/)) {
                    ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + a.getAttribute('href'), {
                        headers: { 'Authorization': 'Bearer ' + getAT(account) },
                        success: function (data) {
                            data = JSON.parse(data)
                            if (data.statuses[0]) {
                                a.parentNode.classList.remove('card')
                                a.parentNode.classList.remove('toresolve')
                                a.parentNode.innerHTML = displayStatus(data.statuses[0], account, 'quo')
                                tweak(nb + 1)
                            } else {
                                a.parentNode.classList.remove('toresolve')
                            }
                        }
                    })
                })
        }
        function vote(statusId, statusUri, from, ownvotes) {
            var [acct, id] = statusId.split('-')
        }
        // function ajax(method, url, params, success) {
        //     var xhttp = new XMLHttpRequest();
        //     xhttp.onreadystatechange = success;
        //     xhttp.open(method, url, true);
        //     at = JSON.parse(window.localStorage.getItem('accounts') || '[]')[account] ? JSON.parse(window.localStorage.getItem('accounts') || '[]')[account].at : null
        //     if (at) xhttp.setRequestHeader('Authorization', 'Bearer ' + at)
        //     if (params)
        //         xhttp.send(params);
        //     else
        //         xhttp.send()
        // }
        function ajax(url, params) {
            xhr = new XMLHttpRequest()
            if (params.indexValue !== undefined) { xhr.indexValue = params.indexValue }
            xhr.onreadystatechange = function () {
                if (params.success && this.readyState == XMLHttpRequest.DONE && (this.status == 200 || this.status == 202)) {
                    params.success(this.response, this)
                }
                if (params.wait && this.readyState == XMLHttpRequest.DONE && this.status == 206) {
                    params.wait(this.response, this)
                }
            }
            xhr.open(params.method || 'GET', url, true)
            if (params.headers) {
                Object.keys(params.headers).forEach(k => {
                    xhr.setRequestHeader(k, params.headers[k])
                })
            }
            fd = null
            if (params.data) {
                fd = new FormData()
                Object.keys(params.data).forEach(k => {
                    Array.isArray(params.data[k]) ? params.data[k].forEach(v => { fd.append(k, v) }) : fd.append(k, params.data[k])
                })
            }
            xhr.send(fd || null)
        }
        function convertHTTPtoUri(http) {
            var [h, n, i, a] = http.split('/')
            return a.substring(1) + '@' + i
        }
        function displayStatus(el, acct, cssClass = '', id_prefix = 's') {
            // console.log(el)
            if (el.reblog) {
                boost = `<a href="#account/${acct}/${el.account.id}"><img loading="lazy" src="${el.account.avatar}"/> ${replaceEmojis(el.account.emojis, el.account.display_name)}</a> boosted`;
                e = el.reblog;
            } else {
                boost = ''
                e = el;
            }
            // e.card ? console.log(e.card) : '';
            // e.poll ? console.log(e.poll) : ''
            return `<div uri="${e.uri}" id="${id_prefix}${acct}-${e.id}" ${e.in_reply_to_id ? `in_reply_to_id="${id_prefix}${acct}-${e.in_reply_to_id}"` : ''} class="status${e.favourited ? ' fav' : ''}${e.reblogged ? ' reb' : ''} ${cssClass}">
            <div class="boost">${boost}</div>
            <div class="reply_to"></div>
            <div class="author"><a href="#account/${acct}/${e.account.id}"><img loading="lazy" class="sm-avatar" src="${e.account.avatar}"/> ${replaceEmojis(e.account.emojis, e.account.display_name)} <span class="account">(${e.account.acct})</span></a></div>
            <div class="actions">
                ${accounts[acct].id == e.account.id ? '<span class="edit"><svg><use href="#pen"/></svg></span>' : ''}
                ${accounts[acct].id == e.account.id ? '<span class="del"><svg><use href="#cancel"/></svg></span>' : ''}
                <span class="link"><a href="#status/${acct}/${e.id}"><svg><use href="#tree"/></svg></a></span> 
                <span class="rep" author="${e.account.acct.indexOf('@') != -1 ? e.account.acct : convertHTTPtoUri(e.account.url)}" mentions="${e.mentions.map(function (m) { return `@${m.acct.indexOf('@') != -1 ? m.acct : convertHTTPtoUri(m.url)}` }).join(' ')}" 
                tags="${e.tags.map(function (t) { return `#${t.name}` }).join(' ')}"><svg><use href="#rep"/></svg>(${e.replies_count})</span>
                <span class="quo" author="${e.account.acct}" mentions="${e.mentions.map(function (m) { return `@${m.acct}` }).join(' ')}" href="${e.url}"
                tags="${e.tags.map(function (t) { return `#${t.name}` }).join(' ')}"><svg><use href="#quote"/></svg></span>
                <span class="reb"><svg><use href="#reb" /></svg>(${e.reblogs_count})</span> 
                <span class="fav"><svg><use href="#star" /></svg>(${e.favourites_count})</span>
            </div>
            <div class="text">${replaceMentions(e.mentions, replaceEmojis(e.emojis, parseMd(e.content)).replace(/href=\"https:\/\/[\w.\/]+\/tags\/(\w+)/g, `href="#tags/$1/${acct}`), acct)}</div>
            ${e.poll && !e.poll.voted && !e.poll.expired ? '<div class="poll">' + e.poll.options.map(function (o, i) { return `<div><input type="${e.poll.multiple ? 'checkbox' : 'radio'}" name="option_${e.poll.id}[]" id="option_${e.poll.id}_${i}"/><label for="option_${e.poll.id}_${i}">${o.title}</label></div>` }).join('') + `<div><button class="vote" id="poll_${e.poll.id}">Vote!</button></div><div>${e.poll.votes_count} voters</div></div>` : ''}
            ${e.poll && (e.poll.voted || e.poll.expired) ? '<div class="poll">' + e.poll.options.map(function (o, i) { return `<div  class="${e.poll.own_votes.includes(i) ? 'gras' : ''}">${o.title} : ${Math.round(o.votes_count / e.poll.voters_count * 100)}%</div><div style="height:6px;width:${o.votes_count / e.poll.voters_count * 100}%;background-color:var(--highlight)"></div>` }).join('') + `</div><div>${e.poll.votes_count} voters</div>` : ''}
            <div class="media${e.media_attachments.length > 1 ? ' multi' : ''}">${e.media_attachments.map(function (m) {
                if (m.type == 'image') return `<img loading="lazy" alt="${m.description}" title="${m.description}" aria-label="${m.description}" src="${m.preview_url}"/>`;
                if (m.type == 'video') return `<video preload="none" src="${m.url}" poster="${m.preview_url}" controls volume="1" aria-label="${m.description}" title="${m.description}"></video>`
                if (m.type == 'gifv') return `<video preload="none" src="${m.url}" poster="${m.preview_url}" autoplay loop volume="1" aria-label="${m.description}" title="${m.description}"></video>`
            }).join('')}</div>
            ${e.card ? (e.card.type == 'video' ? `<div class="iframe">${e.card.html}</div>` : `<div class="card toresolve"><a href="${e.card.url}">
                ${e.card.image ? `<img loading="lazy" src="${e.card.image}"/>` : ''}
                <div class="provider">${e.card.provider_name}</div>
                <div class="title">${e.card.title}</div>
                <div class="desc">${e.card.description}</div>
            </a></div>`) : ''}
        </div>`
        }
        function replaceMentions(array, text, acct) {
            array.forEach(m => {
                text = text.replaceAll(`href="${m.url}"`, `href="#account/${acct}/${m.id}"`).replaceAll('target="_blank"', '')
            })
            return text
        }
        function replaceEmojis(array, text) {
            array.forEach(e => {
                text = text.replaceAll(':' + e.shortcode + ':', '<img class="emoji" alt="' + e.shortcode + '" title="' + e.shortcode + '" src="' + e.url + '"/>')
            })
            return text
        }
        // function resize_textarea() {
        //     this.style.overflow = 'hidden';
        //     this.style.height = 0;
        //     this.style.height = Math.max(this.scrollHeight, 300) + 'px';
        // }
        // sa('textarea').forEach(e => {
        //     e.onkeyup = resize_textarea;
        // })
        s('#bplus').onclick = function () {
            s('#bplus').parentNode.insertBefore(n(`<div class="editthread" attach="0"><!--<div class="post">-->
                                                    <textarea class="text" name="status[]" placeholder="And then..."></textarea>
                                                    <label class="button"><input type="file" accept="image/*"/><svg><use href="#camera" /></svg></label>
                                                    <span class="size"></span>
                                                    <button class="cancel"><svg><use href="#cancel" /></svg></button>
                                                    <!--</div>-->
                                                    <div class="media_attachments">
                                                        ${`<div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                                                            <button class="piccancel"><svg>
                                                                    <use href="#cancel" />
                                                                </svg></button>
                                                        </div>`.repeat(4)}
                                                    </div>
                                                   </div>`), s('#bplus'))
            tweakFileInput()
            s('#write div.editthread:last-of-type textarea').focus()
            // sa('textarea').forEach(e => {
            //     e.onkeyup = resize_textarea;
            // })
            sa('.cancel').forEach(e => { e.onclick = function () { this.parentNode.remove() } })
        }

        function tweakFileInput() {
            sa('input[type="file"]').forEach(e => {
                e.onchange = function (ev) {
                    if (parseInt(e.closest('.editthread').getAttribute('attach')) < 4) {
                        var file = this.files[0];
                        t = this
                        var reader = new FileReader();
                        reader.onload = function () {
                            editthread = t.closest('.editthread')
                            attach = parseInt(editthread.getAttribute('attach'))
                            editthread.querySelector(`.media_attachments div:nth-child(${attach + 1}) img.media`).src = this.result; //input=>label>.post>.editthread => .media_attachments
                            editthread.querySelector(`.media_attachments>div:nth-child(${attach + 1})`).style.display = 'block'
                            editthread.setAttribute('attach', attach + 1)
                        };
                        reader.readAsDataURL(file);
                    }
                }
            })
            sa('.piccancel').forEach(b => {
                b.onclick = function () {
                    editthread = this.closest('.editthread')
                    editthread.setAttribute('attach', parseInt(editthread.getAttribute('attach')) - 1)
                    this.parentNode.querySelector('img').src = '';
                    this.parentNode.style.display = 'none';
                    this.parentNode.parentNode.append(this.parentNode)
                }
            })
            sa('.media_attachments img').forEach(i => {
                i.onload = function () {
                    if (this.src.substring(0, 4) == 'http' && this.complete && this.naturalHeight != 1) {
                        textarea = this.parentNode.parentNode.parentNode.querySelector('textarea')
                        t = this
                        src = this.src
                        ajax('pj.php?url=' + this.src, {
                            success: function (data, xhr) {
                                textarea.value = textarea.value.replace(src, '') // remove URL from textarea
                                t.src = 'data:' + xhr.getResponseHeader('content-type') + ';base64, ' + data
                                t.parentNode.style.display = 'block'
                                editthread = t.parentNode.parentNode.parentNode //img>div>.media_attachments>.editthread
                                editthread.setAttribute('attach', parseInt(editthread.getAttribute('attach')) + 1)
                            }
                        })
                    }
                }
            })
            sa('textarea.text').forEach(e => { //div.bla //paste image directly
                // e.onpaste = function (ev) {
                //     d = ev.clipboardData || window.clipboardData
                //     // console.log(d)
                //     // s('#log').innerHTML += d
                //     for (i = 0; i < d.items.length; i++) {
                //         console.log(d.items[i].type.indexOf('text'))
                //         if (d.items[i].type.indexOf('text') == 0) d.items[i].getAsString(data => {
                //             if (a = new URL(data)) {
                //                 console.log(a)
                //                 // s('#log').innerHTML += a

                //                 e.after(n(`<img id="test" />`))//onload="javascript: s('#log').innerHTML += this.complete && this.naturalHeight"/>`))
                //                 s('#test').onload = function () {
                //                     console.log(this.complete && this.naturalHeight)
                //                     console.log(this.src)
                //                     // s('#log').innerHTML += src

                //                     // var img = new Image();
                //                     // img.src = document.getElementById("test").src;
                //                     // console.log(img)
                //                     // var canvas = document.getElementById("canvas");
                //                     // var context = canvas.getContext("2d");
                //                     // context.drawImage(img, 40, 40);
                //                 }
                //                 s('#test').setAttribute('src', data)
                //                 // ajax('GET', data, null, function () {
                //                 //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                //                 //         console.log(this.response)
                //                 //     }
                //                 // })
                //                 // im = s('#test')
                //                 // console.log(im.complete && im.naturalHeight)
                //             }
                //             i = n(data)
                //             console.log(i)
                //             // e.after(n)
                //         })
                //         // if(d.items[i].type.indexOf('image')==0)  console.log(d.items[i].getAsFile(data=>{console.log(data)}))
                //     }
                // }
                // e.onkeyup = function(){
                //     s('#log').append(n(`<div>${'ici'}</div>`))

                // }
                e.oninput = function (ev) { //paste or inject GIF URL

                    if ((ev.inputType == 'insertText' || ev.inputType == 'insertFromPaste' || ev.inputType == 'insertCompositionText') && ev.data.substring(0, 4) == 'http' && (url = new URL(ev.data))) {
                        attach = parseInt(e.parentNode.parentNode.getAttribute('attach'))
                        e.parentNode.parentNode.querySelector(`.media_attachments div:nth-child(${attach + 1}) img.media`).src = ev.data
                    }
                    e.parentNode.querySelector('.size').innerText = 500 - e.value.replace(/https?:\/\/\S+/gm, '12345678901234567890123').replace(/([\s^]@[\w]+)@[\w]+\b/gm, '$1').length //TODO base this on instance config + 23 chars per URL, no domain name in @
                }
            })

        }
        tweakFileInput()
        const sleep = ms => {
            return new Promise(resolve => setTimeout(resolve, ms))
        }
        const uploadFile = (toot, i) => { //uploads and then checks upload is finished
            return new Promise((resolve, reject) => {
                const file = DataURIToBlob(toot.querySelector(`.media_attachments div:nth-child(${i + 1}) img`).getAttribute('src'))
                ajax(getInstance(account) + '/api/v2/media', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    data: { file: file, description: toot.querySelector(`.media_attachments div:nth-child(${i + 1}) textarea`).value },
                    success: async function (data) {
                        id = await checkUpload(JSON.parse(data).id).then(r => { return r })
                        resolve(JSON.parse(data))
                    }
                })
            })
        }
        async function toot(toots, i, in_reply_to_id = '') { // toots multiple toots in a row
            if (toots.length <= i) {//finished
                cleanUpWrite()
                return
            }

            const uploads = []
            medias = toots[i].querySelectorAll('.media_attachments div')
            toots[i].scrollIntoView()
            max = parseInt(toots[i].getAttribute('attach'))
            for (j = 0; j < max; j++) { //loop on img
                uploads.push(uploadFile(toots[i], j).then(r => { return r.id }))
            }
            const results = await Promise.all(uploads) //uploads and wait for each to be ready
            fd = new FormData();
            fd.append('status', toots[i].querySelector('textarea.text').value)
            fd.append('visibility', s('#visibility').value.toLowerCase())
            fd.append('language', s('#lang').value)
            results.forEach(r => { fd.append('media_ids[]', r) }) // attach all medias
            dataToSend = { status: toots[i].querySelector('textarea.text').value, visibility: s('#visibility').value.toLowerCase(), language: s('#lang').value, 'media_ids[]': results }
            if (in_reply_to_id && in_reply_to_id != '') dataToSend.in_reply_to_id = in_reply_to_id

            ajax(getInstance(account) + '/api/v1/statuses', {
                method: 'POST',
                data: dataToSend,
                headers: { 'Authorization': 'Bearer ' + getAT(account) },
                success: function (data) {
                    // toots[i].style.display = 'none'
                    toots[i].querySelectorAll('textarea').forEach(t => { t.disabled = true })
                    toot(toots, i + 1, JSON.parse(data).id) // toot next one
                }
            })
        }
        s('#toob').onclick = function () {
            toots = sa('.editthread')
            //check media descriptions
            t = true
            toots.forEach(toot => {
                texts = toot.querySelectorAll('.media_attachments div[style*="block"] textarea')
                texts.forEach(desc => {
                    if (!desc.value) {
                        t = false
                    }
                })
            })
            if (t) {
                toot(toots, 0, s('#in_reply_to_id').getAttribute('value'))
            }
        }
        function checkUpload(id) {
            return new Promise((resolve, reject) => {
                ajax(getInstance(account) + '/api/v1/media/' + id, {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        resolve(id);// finished
                    },
                    wait: function (data) {
                        sleep(1000).then(v => { resolve(checkUpload(id)) })
                    }
                })
            })
        }
        function cleanUpWrite() {
            sa('#write .editthread:not(:first-child)').forEach(t => { t.remove() }) //remove additional textareas
            s('.size').innerHTML='';
            s('#write .editthread').setAttribute('attach', 0)
            s('#write .editthread').style.display = 'block'
            sa('#write img').forEach(i => { i.src = '' }) //reset media attachments
            sa('#write .editthread textarea').forEach(t => { t.value = ''; t.disabled = false })//reset remaining texteareas (alt texts)
            attach = false // reset attachment status
            sa('.media_attachments>div').forEach(d => { d.style.display = 'none' })  //hide media attachments 
            s('#account').after(s('#write'))//move #write back to its place
            whichTimeline = ''
            display()
        }
        function DataURIToBlob(dataURI) {
            const splitDataURI = dataURI.split(',')
            const byteString = splitDataURI[0].indexOf('base64') >= 0 ? atob(splitDataURI[1]) : decodeURI(splitDataURI[1])
            const mimeString = splitDataURI[0].split(':')[1].split(';')[0]

            const ia = new Uint8Array(byteString.length)
            for (let i = 0; i < byteString.length; i++)
                ia[i] = byteString.charCodeAt(i)

            return new Blob([ia], { type: mimeString })
        }

        window.onscroll = function (ev) {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
                h = window.location.hash.split('/')

                switch (h[0]) {
                    case '#home':
                        feed = 'timelines/home'
                        acct = h[1]
                        break;
                    case '#notifications':
                        feed = 'notifications'
                        acct = h[1]
                        break;
                    case '#public':
                        feed = 'timelines/public?local=true'
                        acct = h[1]
                        break;
                    case '#federated':
                        feed = 'timelines/public'
                        acct = h[1]
                        break;
                    case '#tags':
                        feed = 'timelines/tag/' + h[1]
                        acct = h[2]
                        break;

                    default:
                        break;
                }
                if (acct === undefined) return;
                trend = (timeline == '#trend')
                // feed = trend ? 'timelines/home' : wt[0]+'/'+wt[1]
                if (waitingFor > maxId) {
                    ajax(getInstance(acct) + '/api/v1/' + feed + '?limit=40&max_id=' + maxId, {
                        headers: { 'Authorization': 'Bearer ' + getAT(acct) }, success: function (data) {
                            JSON.parse(data).forEach(el => {
                                if (!trend || el.replies_count + el.reblogs_count + el.favourites_count > 0) {
                                    s('#timeline').append(n(h[0] == '#notifications' ? displayNotification(el, acct) : displayStatus(el, acct)))
                                    maxId = Math.min(maxId, el.id)
                                    sa('[in_reply_to_id="s' + acct + '-' + el.id + '"]').forEach(c => {
                                        s('#s' + acct + '-' + el.id).appendChild(c)
                                    })
                                }
                            })
                            tweak();
                        }
                    })
                    waitingFor = maxId
                }
            }
        }
        function parseMd(md) {
            md = md.replace(/\b[\*\_]{2}([^\*\_]+)[\*\_]{2}\b/g, '<b>$1</b>');
            md = md.replace(/\b[\*\_]{1}([^\*\_]+)[\*\_]{1}\b/g, '<i>$1</i>');
            md = md.replace(/\b[\~]{2}([^\~]+)[\~]{2}\b/g, '<del>$1</del>');
            md = md.replace(/\b[\`]{1}([^\`]+)[\`]{1}\b/g, '<code>$1</code>');
            return md;
        }

        /* TODOS
            CW support
            compose a poll
            keyboard nav
            edit toot
            lists, remove from timeline
        */
    </script>
</body>

</html>