<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Toob - A Mastodon client</title>
    <link rel="icon" type="image/x-icon" href="./toob.svg">
    <link rel="manifest" href="manifest.json" />
    <style>
        :root {
            --highlight: #36b;
            /* #3088D4 */
        }

        @media (prefers-color-scheme: light) {
            :root {
                --color: #333;
                --bg: #eee;
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color: #eee;
                --bg: #333;
            }
        }

        body {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: small;
            max-width: 800;
            margin: auto;
            background-color: var(--bg);
            color: var(--color);
        }

        svg.sm,
        img.sm {
            max-height: 20px;
            max-width: 20px;
        }

        .vsm {
            max-height: 16px;
            max-width: 16px;
        }

        .status>div>.sm {
            color: var(--highlight)
        }

        svg.md,
        img.md {
            max-height: 24px;
            max-width: 24px;
        }

        svg.lg,
        img.lg {
            max-height: 100px;
            max-width: 100px;
        }

        body>div {
            display: none;
            margin-top: 38px;
            margin-left: 36px;
        }

        #topnav {
            position: fixed;
            z-index: 1;
            display: block;
            width: calc(800px - 32px);
            margin-left: 35px;
            max-width: calc(100% - 36px);
            top: 0px;
            background-color: var(--bg);
            box-shadow: 0 3px 3px var(--color);
        }

        #topnav h4 {
            margin: .4em;
        }

        #sidenav {
            position: fixed;
            top: 0px;
            width: 32px;
            height: 100%;
            background-color: var(--bg);
            box-shadow: 3px 0px 2px var(--color);
            overflow-y: scroll;
            scrollbar-width: none;
        }

        #sidenav::-webkit-scrollbar {
            display: none;
        }

        #sidenav svg {
            margin-top: .5em;
        }

        #sidenav a svg,
        .actions span a svg {
            color: var(--color);
        }

        #sidenav a.active svg {
            color: var(--highlight);
        }

        @keyframes new {
            0% {
                background-color: var(--bg);
                color: var(--highlight);
            }

            50% {
                background-color: var(--highlight);
                color: var(--bg);
            }

            100% {
                background-color: var(--bg);
                color: var(--highlight);
            }
        }

        #sidenav a.new svg {
            animation-name: new;
            animation-duration: 2s;
            animation-iteration-count: infinite;
            border-radius: .3em;
        }

        a {
            color: var(--highlight);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .status {
            border: 1px solid var(--color);
            border-radius: .3em;
            margin: .2em;
            padding: .2em;
            overflow: hidden;
        }

        button,
        label.button,
        select {
            border: none;
            color: #eee;
            background-color: var(--highlight);
            border: var(--highlight) 1px solid;
            padding: 4px 8px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1.2em;
            border-radius: .5em;
            cursor: pointer;
        }

        button {
            min-width: 40px;
            min-height: 32px;
        }

        button.outline {
            background-color: var(--bg);
            color: var(--highlight)
        }

        select {
            vertical-align: middle;
            height: 32px;
        }

        input[type="file"] {
            display: none;
        }

        .author {
            float: left;
        }

        .author .account {
            font-size: smaller;
        }

        /* .sm-avatar {
            max-width: 20;
        } */

        .notif {
            border-bottom: 1px solid var(--color);
        }

        /* .boost img {
            max-width: 15;
        } */

        .boost {
            font-size: smaller;
        }

        .text {
            clear: both;
            overflow: auto;
        }

        .text>a {
            color: var(--color);
            text-decoration: none;
        }

        .text a span.invisible {
            display: none;
        }

        .text p a span.ellipsis::after {
            content: '…';
        }

        .text p {
            text-align: justify;
        }

        .media {
            text-align: center;
            margin-top: .5em;
        }

        .media.multi {
            overflow-x: scroll;
            overflow-y: hidden;
            white-space: nowrap;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .media * {
            max-width: 100%;
        }

        .media.multi * {
            max-width: 95%;
        }

        img+img {
            margin-left: .2em;
        }

        .card {
            width: 90%;
            margin: auto;
            border-radius: .3em;
            border: 1px solid var(--color);
            height: 100px;
            overflow: hidden;
            overflow-y: auto;
        }

        .iframe {
            width: 90%;
            margin: auto;
            border-radius: .3em;
            border: 1px solid var(--color);
            height: 300px;
        }

        .iframe iframe {
            width: 100%;
            height: 100%;
        }

        .card img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            float: left;
            margin-right: .3em;
        }

        .card .title {
            font-weight: bold;
        }

        .status .status {
            border: none;
            border-radius: 0;
            border-left: 1px solid var(--color);
            padding-right: 0;
            margin-right: 0;
        }

        .actions {
            text-align: right;
            float: right;
        }

        .actions i {
            font-style: normal;
            font-size: large;
        }

        .actions span {
            border-radius: .3em;
            padding: .3em;
            cursor: pointer;
            border: 1px solid var(--color);
        }

        span.at {
            font-size: smaller;
            border: none;
        }

        .focus>.text {
            font-size: larger;
        }

        .status.fav>div.actions>.fav,
        .status.reb>div.actions>.reb {
            background-color: var(--highlight);
            color: var(--bg);
            border: var(--highlight) solid 1px;
        }

        #write>textarea {
            display: block;
            width: 100%;
            font-family: inherit;
        }

        textarea {
            border-radius: .3em;
            border: 1px solid #333;
        }

        img.emoji {
            max-width: 1em;
        }

        .status[in_reply_to_id] {
            border-left: 2px solid var(--highlight);
        }

        #account .header {
            width: 100%;
        }

        #account .avatar {
            width: 100;
        }

        #settings button svg {
            width: 24px;
            height: 24px;
        }

        .editthread .post {
            display: flex;
            align-items: center;
            clear: both;
            min-height: 48px;
        }

        .editthread>* {
            margin: .1em;
        }

        .editthread>textarea {
            font-family: inherit;
            font-size: small;
            min-height: 300px;
            width: 99%;
        }

        .media_attachments textarea {
            font-family: inherit;
            font-size: small;
            height: 6em;
        }

        .editthread button,
        #account>button {
            height: 32px;
            max-height: 32px;
            min-width: 40px;
        }

        .editthread label {
            height: 24px;
            max-height: 24px;
        }

        .media_attachments {
            clear: both;
        }

        .media_attachments>div {
            display: none;
        }

        .media_attachments>div>img {
            width: calc(50% - 25px)
        }

        .media_attachments>div>textarea {
            width: calc(50% - 25px)
        }

        .media_attachments>div>button {
            height: 40px;
            margin-bottom: 24px;
        }

        #sidenav svg,
        #sidenav img,
        #modal svg {
            width: 24px;
            height: 24px;
            display: inline-block;
            margin-left: 4px;
        }

        .actions svg {
            width: 18px;
            height: 18px;
        }

        .actions>span {
            height: 18px;
            display: inline-block;
        }

        body>svg {
            height: 1px;
        }

        #write svg {
            height: 24px;
            width: 24px;
        }

        #write button,
        #write label {
            vertical-align: middle;
        }

        .gras {
            font-weight: bold;
        }

        #modal {
            display: none;
            position: fixed;
            z-index: 2;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            margin: 0px;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.6);
        }

        .modal-content {
            background-color: var(--bg);
            margin: auto;
            margin-top: 4em;
            padding: 20px;
            border: 1px solid var(--color);
            width: 60%;
        }

        #modal .close {
            color: var(--highlight);
            float: right;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* #accounts img, */
        #topnav svg {
            height: 20px;
            width: 20px;
            margin-left: .3em;
        }

        #sidenav img.active {
            border: var(--highlight) solid 2px;
            margin-left: 2px;
        }

        nav h1 a {
            position: relative;
            display: inline-block;
        }

        nav h1 a svg {
            display: block;
        }

        nav h1 a img {
            width: 70%;
            position: absolute;
            top: 24px;
            left: 12px
        }

        .status.quo:before {
            display: block;
            stroke: var(--highlight);
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='10' y1='8' x2='10' y2='12'%3E%3C/line%3E%3Cline x1='14' y1='8' x2='14' y2='12'%3E%3C/line%3E%3Cpath d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'%3E%3C/path%3E%3C/svg%3E");
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='10' y1='8' x2='10' y2='12'%3E%3C/line%3E%3Cline x1='14' y1='8' x2='14' y2='12'%3E%3C/line%3E%3Cpath d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'%3E%3C/path%3E%3C/svg%3E");
            background-color: var(--highlight);
            mask-size: cover;
            -webkit-mask-size: cover;
            height: 28px;
            width: 28px;
            float: left;
            content: '';
        }

        .status.quo {
            border: var(--highlight) solid;
            border-radius: .3em;
            padding: .1em;
            width: 95%;
            margin: auto;
        }

        code,
        pre {
            background-color: var(--color);
            color: var(--bg);
            overflow-x: auto;
            font-size: medium;
            /* padding: 0 0em; */
        }

        blockquote {
            font-style: italic;
            margin-left: 32px;
            font-family: Georgia, "Times New Roman", serif;
            border-left: 4px solid #CCC;
            padding-left: 8px;
        }

        #ac {
            position: absolute;
            background-color: var(--bg);
            border: 1px solid var(--color)
        }
    </style>
</head>

<body>
    <svg>
        <defs>
            <symbol id="home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" class="feather feather-home">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </symbol>
            <symbol id="public" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </symbol>
            <symbol id="pen" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                <path d="M2 2l7.586 7.586"></path>
                <circle cx="11" cy="11" r="2"></circle>
            </symbol>
            <symbol id="notifications" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </symbol>
            <symbol id="logout" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </symbol>
            <symbol id="tree" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="18" cy="18" r="3"></circle>
                <circle cx="6" cy="6" r="3"></circle>
                <path d="M6 21V9a9 9 0 0 0 9 9"></path>
            </symbol>
            <symbol id="rep" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 10 4 15 9 20"></polyline>
                <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
            </symbol>
            <symbol id="reb" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="17 1 21 5 17 9"></polyline>
                <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                <polyline points="7 23 3 19 7 15"></polyline>
                <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
            </symbol>
            <symbol id="star" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                </polygon>
            </symbol>
            <symbol id="cancel" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="9" x2="15" y2="15"></line>
                <line x1="15" y1="9" x2="9" y2="15"></line>
            </symbol>
            <symbol id="send" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </symbol>
            <symbol id="plus" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </symbol>
            <symbol id="camera" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </symbol>
            <symbol id="searchi" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </symbol>
            <symbol id="trendi" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </symbol>
            <symbol id="quote" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="10" y1="8" x2="10" y2="12"></line>
                <line x1="14" y1="8" x2="14" y2="12"></line>
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </symbol>
            <symbol id="quo">
                <use xlink:href="#quote" transform="scale(0.8)" />
                <use xlink:href="#rep" transform="translate(5 6)scale(0.8)" />
            </symbol>
            <symbol id="i-adduser" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </symbol>
            <symbol id="gear" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
            </symbol>
            <symbol id="federated" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="2" y1="12" x2="22" y2="12"></line>
                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                </path>
            </symbol>
            <symbol id="tag" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="4" y1="9" x2="20" y2="9"></line>
                <line x1="4" y1="15" x2="20" y2="15"></line>
                <line x1="10" y1="3" x2="8" y2="21"></line>
                <line x1="16" y1="3" x2="14" y2="21"></line>
            </symbol>
            <symbol id="tags">
                <use xlink:href="#tag" transform="scale(0.5)" />
                <use xlink:href="#tag" transform="translate(11 11)scale(0.5)" />
                <use xlink:href="#tag" transform="translate(0 11)scale(0.5)" />
                <use xlink:href="#tag" transform="translate(11 0)scale(0.5)" />
            </symbol>
            <symbol id="pin" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke-width="2"
                stroke="currentColor">
                <path
                    d="M16,3 L10,9 C10,9 6,8 3,11 C3,11 13,21 13,21 C16,18 15,14 15,14 L21,8 L16,3 Z M1,23 L8,16 M14,1 L23,10" />
            </symbol>
            <symbol id="unpin" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke-width="2"
                stroke="currentColor">
                <line x1="1" y1="1" x2="23" y2="23"></line>
                <path
                    d="M16,3 L10,9 C10,9 6,8 3,11 C3,11 13,21 13,21 C16,18 15,14 15,14 L21,8 L16,3 Z M1,23 L8,16 M14,1 L23,10" />
            </symbol>
            <symbol id="minus" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </symbol>
            <symbol id="blank" viewBox="0 0 24 24"></symbol>
            <symbol id="external" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
            </symbol>
            <symbol id="link" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </symbol>
            <symbol id="userplus" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </symbol>
            <symbol id="usermin" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </symbol>
            <symbol id="lists" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </symbol>
            <symbol id="list" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </symbol>
            <symbol id="hide" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path
                    d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24">
                </path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
            </symbol>
            <symbol id="show" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </symbol>
            <symbol id="save" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </symbol>
        </defs>
    </svg>
    <nav id="sidenav">
        <!-- <a href="#test"><svg>
            <use href="#tags" />
        </svg></a><a href="#test"><svg>
            <use href="#tag" />
        </svg></a> -->
        <a href="#write"><svg>
                <use href="#pen" />
            </svg></a>
        <a href="#search"><svg>
                <use href="#searchi" />
            </svg></a>
        <h1></h1>
        <hr />
        <a href="#adduser"><svg>
                <use href="#i-adduser" />
            </svg></a>
        <a href="#settings"><svg>
                <use href="#gear" />
            </svg></a>
    </nav>
    <nav id="topnav">
        <h4 id="title"></h4>
    </nav>
    <div id="timeline"></div>
    <div id="divtags"></div>
    <div id="divlists"></div>
    <div id="status"></div>
    <div id="account"></div>
    <div id="write">
        <div class="editthread" attach="0">
            <!-- <div class="post"> -->
            <input type="hidden" id="in_reply_to_id" />
            <input type="hidden" id="toot_id" />
            <textarea class="text" placeholder="What's on your mind?"></textarea>
            <span class="size"></span>
            <br /><label class="button"><input type="file" accept="image/*" /><svg>
                    <use href="#camera" />
                </svg></label>
            <!-- </div> -->
            <div class="media_attachments">
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
            </div>
        </div>
        <button id="bplus"><svg>
                <use href="#plus" />
            </svg></button>
        <select id="visibility">
            <option value="public">Public</option>
            <option value="unlisted">Unlisted</option>
            <option value="private">Private</option>
            <option value="direct">Mentions</option>
        </select>
        <select id="lang">
            <option value="fr">FR</option>
            <option value="en">EN</option>
        </select>
        <button id="toob"><svg>
                <use href="#send" />
            </svg></button>
        <!-- <div id="log"></div> -->
    </div>
    <div id="search">
        <input type="text" placeholder="Search terms" />
    </div>
    <div id="login">
        <input type="text" id="instance" placeholder="https://piaille.fr" />
        <button id="loginb">Se connecter</button>
    </div>
    <div id="settings">
        <div id="colors">
        </div>
    </div>
    <div id="modal">
        <div class="modal-content">
            <span class="close"><svg>
                    <use href="#cancel" />
                </svg></span>
            <p>Some text in the Modal..</p>
            <button class="OK">OK</button>
        </div>
    </div>
    <script>
        navigator.serviceWorker.register('service-worker.js', { scope: '.' })
            .then(function (registration) {
                console.log('Service worker registered successfully');
            }).catch(function (e) {
                console.error('Error during service worker registration:', e);
            });
        //login dance
        account = window.localStorage.getItem('activeAccount') || 0
        code = new URLSearchParams(window.location.search).get('code')
        if (code) {//we got a code back from a user consenting to login
            fd = new FormData();
            clients = JSON.parse(window.localStorage.getItem('clients'))
            inst = window.localStorage.getItem('instance')
            fd.append('client_id', clients[inst].client_id)
            fd.append('client_secret', clients[inst].client_secret)
            fd.append('grant_type', 'authorization_code')
            fd.append('redirect_uri', window.location.protocol + '//' + window.location.host + window.location.pathname)
            fd.append('code', code)
            fd.append('scope', 'read write')
            ajax(inst + "/oauth/token", {
                method: 'POST',
                data: {
                    client_id: clients[inst].client_id, client_secret: clients[inst].client_secret, grant_type: 'authorization_code',
                    redirect_uri: window.location.protocol + '//' + window.location.host + window.location.pathname,
                    code: code, scope: 'read write'
                },
                success: function (data) {
                    accounts = JSON.parse(window.localStorage.getItem('accounts') || '[]')
                    accounts.push({ instance: inst, at: JSON.parse(data).access_token })
                    window.localStorage.setItem('accounts', JSON.stringify(accounts)) | []

                    columns = JSON.parse(window.localStorage.getItem('columns')) || []
                    columns.push(['home', 'public', 'federated', 'notifications'])
                    window.localStorage.setItem('columns', JSON.stringify(columns))

                    ln = JSON.parse(window.localStorage.getItem('lastnotif')) || []
                    ln.push(1)
                    window.localStorage.setItem('lastnotif', JSON.stringify(ln))

                    window.localStorage.removeItem('instance')
                    window.location.href = window.location.pathname
                }
            }
            )
        }
        s('#instance').onchange = function () { s('#loginb').click() }
        s('#loginb').onclick = function () {
            inst = s('#instance').value
            if (inst.substring(0, 8) != 'https://') inst = 'https://' + inst

            clients = JSON.parse(window.localStorage.getItem('clients')) || {}
            if (!clients[inst]) { // we first need a client_id/client_secret to connect to this instance

                ajax(inst + "/api/v1/apps", {
                    method: 'POST',
                    data: {
                        client_name: 'Toob', redirect_uris: window.location.protocol + '//' + window.location.host + window.location.pathname,
                        scopes: 'read write', website: "https://github.com/teddyber/toob"
                    }, success: function (data) {
                        data = JSON.parse(data)
                        // clients = {}
                        clients[inst] = { 'client_id': data.client_id, 'client_secret': data.client_secret }
                        window.localStorage.setItem('clients', JSON.stringify(clients))
                        window.localStorage.setItem('instance', inst)
                        window.location.href = `${inst}/oauth/authorize?client_id=${data.client_id}&scope=read+write&redirect_uri=${window.location.protocol + '//' + window.location.host + window.location.pathname}&response_type=code`
                    }
                })
            }
            else {
                window.localStorage.setItem('instance', inst)
                window.location.href = `${inst}/oauth/authorize?client_id=${JSON.parse(window.localStorage.getItem('clients'))[inst].client_id}&scope=read+write&redirect_uri=${window.location.protocol + '//' + window.location.host + window.location.pathname}&response_type=code`
            }
        }
        function getClient(inst, callback) {
            clients = JSON.parse(window.localStorage.getItem('clients'))
            if (clients[inst] !== undefined) {
                callback({ client_id: clients[inst].client_id, client_secret: clients[inst].client_secret })
            } else {
                ajax(inst + "/api/v1/apps", {
                    method: 'POST',
                    data: {
                        client_name: 'Toob', redirect_uris: window.location.protocol + '//' + window.location.host + window.location.pathname,
                        scopes: 'read write', website: "https://github.com/teddyber/toob"
                    }, success: function (data) {
                        data = JSON.parse(data)
                        // clients = {}
                        clients[inst] = { 'client_id': data.client_id, 'client_secret': data.client_secret }
                        window.localStorage.setItem('clients', JSON.stringify(clients))
                        callback({ client_id: data.client_id, client_secret: data.client_secret })
                        // window.localStorage.setItem('instance', inst)
                        // window.location.href = `${inst}/oauth/authorize?client_id=${data.client_id}&scope=read+write&redirect_uri=${window.location.protocol + '//' + window.location.host + window.location.pathname}&response_type=code`
                    }
                })
            }
        }
        whichTimeline = '';
        lastAccountId = '';
        lastStatusId = '';
        maxId = 999999999999999999
        waitingFor = 999999999999999999
        window.addEventListener('hashchange', (event) => {
            display();
        });

        function s(p) { return document.querySelector(p); }// Select node from Pattern
        function sa(p) { return document.querySelectorAll(p); }// Select All nodes from Pattern
        function n(h) { return document.createRange().createContextualFragment(h) } // create Node from Html

        function getInstance(account) {
            return JSON.parse(window.localStorage.getItem('accounts') || '{}')[account] ? JSON.parse(window.localStorage.getItem('accounts') || '{}')[account].instance : null
        }
        function display() {
            s('body').append(s('#write'))
            hash = window.location.hash.split('/')[0]
            switch (hash) {
                case '#logout':
                    accounts = JSON.parse(window.localStorage.getItem('accounts'))
                    delete accounts[account]
                    window.localStorage.setItem('accounts', JSON.stringify(accounts))
                    window.localStorage.removeItem('instance')
                    window.location.href = window.location.pathname;
                    break;
                case '#settings':
                    s('#title').innerHTML = `<svg><use href="#gear" /></svg> Settings`
                    displaySideNav()
                    showOnly('#settings')
                    break;
                case '#adduser':
                    showOnly('#login')
                    break;
                case '#login':
                    showOnly('#login')
                    s('#title').innerHTML = `<svg><use href="#adduser" /></svg> Login`
                    break;
                case '#home':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#home" /></svg> ${accounts[window.location.hash.split('/')[1]].display_name}`
                    updateTimeline('timelines/home', window.location.hash.split('/')[1]);
                    break;
                case '#lists':
                    showOnly('#divlists')
                    s('#title').innerHTML = `<svg><use href="#lists" /></svg> ${accounts[window.location.hash.split('/')[1]].display_name}`
                    updateLists(window.location.hash.split('/')[1]);
                    break;
                case '#tags':
                    showOnly('#divtags')
                    s('#title').innerHTML = `<svg><use href="#tags" /></svg> ${accounts[window.location.hash.split('/')[1]].display_name}`
                    updateTags(window.location.hash.split('/')[1]);
                    break;
                case '#notifications':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#notifications" /></svg> ${accounts[window.location.hash.split('/')[1]].display_name}`
                    updateNotifications('notifications', window.location.hash.split('/')[1]);
                    break;
                case '#write':
                    showOnly('#write')
                    s('#title').innerHTML = `<svg><use href="#pen" /></svg> Write with ${accounts[account].display_name}`
                    s('#write div.editthread:last-of-type textarea').focus()
                    break;
                case '#federated':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#federated" /></svg> ${accounts[window.location.hash.split('/')[1]].display_name}`
                    updateTimeline('timelines/public', window.location.hash.split('/')[1]);
                    break;
                case '#public':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#public" /></svg> ${accounts[window.location.hash.split('/')[1]].display_name}`
                    updateTimeline('timelines/public?local=true', window.location.hash.split('/')[1]);
                    break;
                case '#search':
                    showOnly('#search')
                    s('#title').innerHTML = `<svg><use href="#search" /></svg> Search with ${accounts[account].display_name}`
                    updateSearch(window.location.hash.substring(8));
                    break;
                case '#list':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#lists" /></svg> ${lists[window.location.hash.split('/')[2]].find(function (l) { return l.id == window.location.hash.split('/')[1] }).title} on ${accounts[window.location.hash.split('/')[2]].url.match(/https?:\/\/[^\/]+\//)} <a class="pin" href="#"><svg><use href="#pin" /></svg></a> <a href="#m${window.location.hash.substring(1)}"><svg><use href="#gear" /></svg></a>`
                    updateTimeline('timelines/list/' + window.location.hash.split('/')[1], window.location.hash.split('/')[2]);
                    break;
                case '#mlist':
                    showOnly('#divlists')
                    s('#title').innerHTML = `<svg><use href="#lists" /></svg> ${lists[window.location.hash.split('/')[2]].find(function (l) { return l.id == window.location.hash.split('/')[1] }).title} on ${accounts[window.location.hash.split('/')[2]].url.match(/https?:\/\/[^\/]+\//)}` //TODO del list
                    editList(window.location.hash.split('/')[1], window.location.hash.split('/')[2]);
                    break;
                case '#tag':
                    showOnly('#timeline')
                    s('#title').innerHTML = `<svg><use href="#tag" /></svg> #${window.location.hash.split('/')[1]} on ${accounts[window.location.hash.split('/')[2]].url.match(/https?:\/\/[^\/]+\//)} <a class="pin" href="#"><svg><use href="#pin" /></svg></a><a class="follow" href="#"><svg><use href="#plus" /></svg></a>`
                    updateTimeline('timelines/tag/' + window.location.hash.split('/')[1], window.location.hash.split('/')[2]);
                    break;
                case '#a':
                    showOnly('#account')
                    updateAccount(window.location.hash.substring(3));
                    break;
                case '#s':
                    showOnly('#status')
                    updateStatus(window.location.hash.substring(3))
                    break;
                case '#edit':
                    showOnly('#write')
                    s('#title').innerHTML = `<svg><use href="#pen" /></svg> Edit with ${accounts[window.location.hash.split('/')[1]].display_name}`
                    editStatus(window.location.hash.substring(6))
                    break;
                case '#account':
                    showOnly('#account')
                    updateRemoteAccount(window.location.hash.substring(9))
                    break;
                case '#status':
                    showOnly('#status')
                    updateRemoteStatus(window.location.hash.substring(8))
                    break;
                default:
                    break;
            }
        }
        function editList(id, acct) {
            s('#divlists').innerHTML = ''
            ajax(getInstance(acct) + `/api/v1/lists/${id}`, {
                headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                success: function (data) {
                    s('#divlists').append(n(`<div><input value="${JSON.parse(data).title}" id="listname"/><svg class="sm savelist" list="${id}"><use href="#save"/></svg></div>`))
                    ajax(getInstance(acct) + `/api/v1/lists/${id}/accounts`, {
                        headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                        success: function (data) {
                            data = JSON.parse(data)
                            data.forEach(a => { s('#divlists').append(n(`<div><img class="sm" src="${a.avatar}"/>${a.display_name} (${a.acct})</div>`)) })
                            s('.savelist').onclick = function () {
                                ajax(getInstance(acct) + `/api/v1/lists/${id}`, {
                                    headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                                    method: 'PUT',
                                    data: { title: s('#listname').value, replies_policy: 'followed' },
                                })
                            }
                        }
                    })
                }
            })
        }
        function editStatus(id) {
            var [acct, id] = id.split('/')
            ajax(getInstance(acct) + `/api/v1/statuses/${id}/source`, {
                headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                success: function (data) {
                    data = JSON.parse(data)
                    s('#write .editthread textarea.text').value = data.text
                    s('#toot_id').value = id
                    s('#write .editthread label').style.display = 'none'
                    ajax(getInstance(acct) + `/api/v1/statuses/${id}`, {
                        success: function (data) {
                            i = 1
                            data = JSON.parse(data)
                            data.media_attachments.forEach(m => {
                                // media = s(`#write .editthread .media_attachments>div:nth-child(${i}) `)
                                s('#write .editthread textarea.text').after(n(`<img class="preview" src='${m.preview_url}'/>`))
                                // media.querySelector('img').setAttribute('src', m.preview_url)
                                // media.querySelector('textarea').style.display = 'none'
                                // media.querySelector('button').style.display = 'none'
                                // media.style.display = 'block'

                            })
                        }
                    })
                }
            })
        }

        function updateSearch(term) {
            s('#search input').value = term
            s('#search input').focus()
            s('#search input').onchange()
        }
        s('#search input').onchange = function () {
            window.location.hash = '#search/' + this.value
            ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + this.value, {
                headers: { 'Authorization': 'Bearer ' + getAT(account) },
                success: function (data) {
                    data = JSON.parse(data)
                    sa('#search .status, #search .account, #search .hashtags').forEach(e => { e.remove() })
                    // data.accounts.forEach(e => { s('#search').append(n(`<div class="account"><a href="#account/${e.url}"><img loading="lazy" class="sm" src="${e.avatar}"/>${e.display_name} (${e.acct})</a></div>`)) })
                    data.accounts.forEach(e => { s('#search').append(n(`<div class="account"><a href="#a/${account}/${e.id}"><img loading="lazy" class="sm" src="${e.avatar}"/>${e.display_name} (${e.acct})</a></div>`)) })
                    data.hashtags.forEach(e => { s('#search').append(n(`<div class="hashtags"><a href="#tag/${e.name}/${account}">#${e.name}</a></div>`)) })
                    data.statuses.forEach(e => { s('#search').append(n(displayStatus(e, account))) })
                    tweak();
                }
            })
        }
        function showModal(text, confirm) {
            s('#modal p').innerHTML = text
            s('#modal').style.display = 'block'
            s('#modal button.OK').onclick = function () { confirm(); s('#modal').style.display = 'none' }
        }
        s('.close').onclick = function () { s('#modal').style.display = 'none' }
        s('#modal').onclick = function () { s('#modal').style.display = 'none' }
        function showOnly(div) {
            sa('body > div').forEach(e => { e.style.display = 'none' })
            s(div).style.display = 'block'
            sa('#sidenav a').forEach(e => { e.classList.remove('active') })
            if (s(`[href^="${window.location.hash}"]`)) s(`[href^="${window.location.hash}"]`).classList.add('active')
        }
        function getAT(account) {
            return JSON.parse(window.localStorage.getItem('accounts') || '[]')[account] ? JSON.parse(window.localStorage.getItem('accounts') || '[]')[account].at : null
        }
        function updateLists(acct) {
            s('#divlists').innerHTML = ''
            hiddenLists = JSON.parse(window.localStorage.getItem('hiddenlists')) || []
            if (hiddenLists.length == 0) accounts.forEach(a => [hiddenLists.push([])])
            lists[acct].forEach(l => {
                s('#divlists').append(n(`<br/>
                <a href="#list/${l.id}/${acct}">${l.title}</a>
                <a href="#mlist/${l.id}/${acct}"><svg class="sm"><use href="#gear"/></svg></a>
                <svg class="dellist sm" list="${l.id}"><use href="#cancel"/></svg>
                <svg class="hidelist sm" list="${l.id}"><use href="#hide"/></svg>`))
            })
            hiddenLists[acct].forEach(l => { s(`[list="${l}"].hidelist use`).setAttribute('href', '#show') })
            s('#divlists').append(n(`<div><input type="text" id="newlist"/><svg id="createlist" class="sm"><use href="#plus"/></svg></div>`))
            s('#createlist').onclick = function () {
                if (s('#newlist').getAttribute('value') != '') {
                    ajax(getInstance(account) + '/api/v1/lists', {
                        headers: { 'Authorization': 'Bearer ' + getAT(account) },
                        method: 'POST',
                        data: { title: s('#newlist').getAttribute('value'), replies_policy: 'followed' },
                        // success: function (data) {
                        //     console.log(JSON.parse(data))
                        // }
                    })
                }
            }
            sa('.dellist').forEach(b => {
                b.onclick = function () {
                    console.log('TODO DEL', this.getAttribute('list'))
                }
            })
            sa('.hidelist').forEach(b => {
                b.onclick = function () {
                    idx = hiddenLists[acct].indexOf(this.getAttribute('list'))
                    if (idx != -1) { hiddenLists[acct].splice(idx, 1); this.querySelector('use').setAttribute('href', '#hide') }
                    else { hiddenLists[acct].push(this.getAttribute('list')); this.querySelector('use').setAttribute('href', '#show') }
                    window.localStorage.setItem('hiddenlists', JSON.stringify(hiddenLists))
                }
            })
        }
        function updateTags(acct) {
            s('#divtags').innerHTML = ''
            tags[acct].forEach(t => {
                s('#divtags').append(n(`<br/><a href="#tag/${t}/${acct}">${t}</a><svg class="sm"><use href="#minus"/></svg>`))
            })
        }
        function updateTimeline(which, acct = 0) {
            if (which + '/' + acct != whichTimeline) {
                whichTimeline = which + '/' + acct
                maxId = 999999999999999999
                waitingFor = 999999999999999999
                s('#timeline').textContent = ''
                ajax(getInstance(acct) + '/api/v1/' + which + '?limit=40', {
                    headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                    success: function (data) {
                        JSON.parse(data).forEach(el => {
                            if (!hiddenAccounts.includes(el.account.id) || which.indexOf('list') != -1) s('#timeline').append(n(displayStatus(el, acct)))
                            if (s('[in_reply_to_id="s' + el.id + '"]')) { // put parent up in the timeline if there's a reply
                                s('[in_reply_to_id="s' + acct + '-' + el.id + '"]').parentNode.insertBefore(s('#s' + acct + '-' + el.id), s('[in_reply_to_id="s' + acct + '-' + el.id + '"]'))
                            }
                            maxId = Math.min(maxId, el.id)  //  remmeber oldest toot for scrolling
                            sa('[in_reply_to_id="s' + acct + '-' + el.id + '"]').forEach(c => {
                                s('#s' + acct + '-' + el.id).appendChild(c)
                            })
                        });
                        tweak();
                    }
                })
                //tags
                w = whichTimeline.split('/')
                if (w[1] == "tag" || w[1] == "list") {
                    w.splice(0, 1)
                    w.splice(2)
                    if (columns[acct].includes(w.join('/'))) s('#topnav a.pin').innerHTML = '<svg><use href="#unpin"/></svg>'
                    else s('#topnav a.pin').innerHTML = '<svg><use href="#pin"/></svg>'
                    s('#topnav a.pin').onclick = function () {
                        if (columns[acct].includes(w.join('/'))) {
                            columns[acct].splice(columns[acct].indexOf(w.join('/')), 1)
                            this.innerHTML = '<svg><use href="#pin"/></svg>'
                        }
                        else {
                            columns[acct].push(w.join('/'))
                            this.innerHTML = '<svg><use href="#unpin"/></svg>'
                        }
                        displaySideNav()
                        window.localStorage.setItem('columns', JSON.stringify(columns))
                        return false
                    }
                    if (w[0] == "tag") {
                        if (tags[account].includes(w[1].toLowerCase())) {
                            s('#topnav a.follow').innerHTML = '<svg><use href="#minus"/></svg>'
                        }
                        else {
                            s('#topnav a.follow').innerHTML = '<svg><use href="#plus"/></svg>'
                        }
                        s('#topnav a.follow').onclick = function () {
                            // if (typeof action !== 'undefined') 
                            if (tags[account].includes(w[1].toLowerCase())) {
                                action = 'unfollow'
                                svg = 'plus'
                            } else {
                                action = 'follow'
                                svg = 'minus'
                            }
                            t = this
                            ajax(getInstance(account) + `/api/v1/tags/${w[1]}/${action}`, {
                                headers: { 'Authorization': 'Bearer ' + getAT(account) },
                                method: 'POST',
                                success: function (data) {
                                    t.innerHTML = `<svg><use href="#${svg}"/></svg>`
                                    if (action == 'unfollow') tags[account].splice(tags[account].indexOf(w[1].toLowerCase()), 1)
                                    else tags[account].push(w[1].toLowerCase())
                                }
                            })
                            return false
                        }
                    }
                }
            }
        }
        function lookForNewNotif() {
            // if (!window.localStorage.getItem('lastnotif')) window.localStorage.setItem('lastnotif', JSON.stringify([1, 1, 1])) //init TODO better
            for (i = 0; i < accounts.length; i++) {
                lastNotifs = JSON.parse(window.localStorage.getItem('lastnotif'))
                ajax(getInstance(i) + '/api/v1/notifications?limit=1&since_id=' + lastNotifs[i], {
                    headers: {
                        'Authorization': 'Bearer ' + getAT(i)
                    },
                    indexValue: i,
                    success: function (data, xhr) {
                        if (JSON.parse(data).length == 0) return;
                        e = JSON.parse(data)[0]
                        newestNotif = e.id
                        // alert(newestNotif > parseInt(JSON.parse(window.localStorage.getItem('lastnotif'))[xhr.indexValue]))
                        if (newestNotif > parseInt(JSON.parse(window.localStorage.getItem('lastnotif'))[xhr.indexValue])) {
                            sa(`[href="#notifications/${xhr.indexValue}"]`).forEach(e => { e.classList.add('new') })
                            const img = `${e.account.avatar}`;
                            text = e.type
                            if (e.type == 'follow') {
                                title = `➕ ${e.account.display_name} (${e.account.acct}) followed you!`;
                                text = `${e.account.note.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            if (e.type == 'favourite') {
                                title = `⭐ ${e.account.display_name} (${e.account.acct}) fav'd your status!`;
                                text = `${e.status.content.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            if (e.type == 'reblog') {
                                title = `🔁 ${e.account.display_name} (${e.account.acct}) boosted your status!`;
                                text = `${e.status.content.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            if (e.type == 'mention') {
                                title = `👉 ${e.account.display_name} (${e.account.acct}) mentionned you!`;
                                text = `${e.status.content.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            if (e.type == 'poll') {
                                title = `📊 A poll you participated in just ended!`;
                                text = `${e.status.content.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            if (e.type == 'update') {
                                title = `${e.account.display_name} (${e.account.acct}) updated their toot!`;
                                text = `${e.status.content.replaceAll(/<\/?[^>]+(>|$)/gi, "")}`
                            }
                            navigator.serviceWorker.ready.then((registration) => {
                                registration.showNotification(title, {
                                    body: text,
                                    icon: img,
                                    badge: 'toob-96.png',
                                    data: { url: './#notifications/' + xhr.indexValue, prefix: window.location.protocol + '//' + window.location.host + window.location.pathname },
                                    tag: e.id,
                                });
                            });
                        }
                    }
                })
            }
        }
        setInterval(lookForNewNotif, 10000)
        tags = []
        lists = []
        hiddenAccounts = []
        function getAccount(account) {
            return new Promise(resolve => {
                ajax(getInstance(account) + '/api/v1/followed_tags', {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        tags[account] = []
                        JSON.parse(data).forEach(t => { tags[account].push(t.name.toLowerCase()) })
                        ajax(getInstance(account) + '/api/v1/lists', {
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function (data) {
                                lists[account] = []
                                JSON.parse(data).forEach(l => { lists[account].push({ id: l.id, title: l.title }) })
                                hiddenLists[account].forEach(l => {
                                    ajax(getInstance(account) + `/api/v1/lists/${l}/accounts`, {
                                        headers: { 'Authorization': 'Bearer ' + getAT(account) },
                                        success: function (data) {
                                            data = JSON.parse(data)
                                            data.forEach(a => { hiddenAccounts.push(a.id) })
                                        }
                                    })
                                })
                                ajax(getInstance(account) + '/api/v1/accounts/verify_credentials', {
                                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                                    success: function (data) {
                                        r = JSON.parse(data)
                                        resolve(r)
                                    }
                                })

                            }
                        })
                    }
                })
            })
        }
        function getAccounts() {
            return new Promise(resolve => {
                accts = JSON.parse(window.localStorage.getItem('accounts')) || []
                hiddenLists = JSON.parse(window.localStorage.getItem('hiddenlists')) || []
                if (hiddenLists.length == 0) accts.forEach(a => [hiddenLists.push([])])

                r = []
                for (i = 0; i < accts.length; i++) {
                    r.push(getAccount(i).then(r => { return r }))
                }
                resolve(Promise.all(r))
            })
        }
        accounts = ''
        columns = JSON.parse(window.localStorage.getItem('columns')) || []
        a = getAccounts().then(a => {
            accounts = a
            if (window.location.hash == '' || window.location.hash == '#') {
                if (accounts.length > 0)
                    window.location.hash = `#home/${account}`;
                else
                    window.location.hash = '#login';
            } else {
                display()
            }
            displaySideNav()
            displaySettings()
            return a
        })
        function displaySettings() {
            s('#settings').innerHTML = '<div id="colors"></div>'
            document.querySelector(':root').style.setProperty('--highlight', window.localStorage.getItem('color'))
            colors = ['#817', '#a35', '#c66', '#e94', '#ed0', '#9d5', '#4d8', '#2cb', '#0bc', '#09c', '#36b', '#639']
            if (columns.length == 0) { accounts.forEach(a => { columns.push(['home', 'public', 'federated', 'notifications']) }) }
            colors.forEach(c => {
                s('#colors').append(n(`<button style="background-color: ${c};"><svg><use href="#blank" /></svg></button>`))
                sa('#colors button').forEach(b => {
                    b.onclick = function () {
                        document.querySelector(':root').style.setProperty('--highlight', this.style['background-color'])
                        window.localStorage.setItem('color', this.style['background-color'])
                    }
                })
            })
            i = 0;
            accounts.forEach(a => {
                s('#settings').append(n(`<hr/><div><span><img loading="lazy" src="${a.avatar}" class="sm"/> ${a.display_name}
                    <button class="logout" acct="${i}"><svg><use href="#logout"/></svg></button>
                    <button class="resetnotif" acct="${i}"><svg><use href="#notifications"/></svg></button>
                    | <button class="col outline" acct="${i}" col="home"><svg><use href="#home"/></svg></button>
                    <button class="col outline" acct="${i}" col="public"><svg><use href="#public"/></svg></button>
                    <button class="col outline" acct="${i}" col="federated"><svg><use href="#federated"/></svg></button>
                    <button class="col outline" acct="${i}" col="notifications"><svg><use href="#notifications"/></svg></button>
                    <button class="col outline" acct="${i}" col="tags"><svg><use href="#tags"/></svg></button>
                    <button class="col outline" acct="${i}" col="lists"><svg><use href="#lists"/></svg></button>
                    </div>`))
                columns[i].forEach(c => { sa(`[col="${c}"][acct="${i}"]`).forEach(b => { b.classList.remove('outline') }) })
                i++
            })
            sa('button.col').forEach(b => {
                b.onclick = function () {
                    col = b.getAttribute('col')
                    acct = b.getAttribute('acct')
                    if (b.classList.contains('outline')) {
                        columns[acct].push(col)
                        b.classList.remove('outline')
                    } else {
                        columns[acct].splice(columns[acct].indexOf(col), 1)
                        b.classList.add('outline')
                    }
                    window.localStorage.setItem('columns', JSON.stringify(columns))
                    display();
                }
            })
            sa('.logout').forEach(b => {
                b.onclick = function () {
                    accounts = JSON.parse(window.localStorage.getItem('accounts'))
                    columns = JSON.parse(window.localStorage.getItem('columns'))
                    ln = JSON.parse(window.localStorage.getItem('lastnotif'))
                    accounts.splice(this.getAttribute('acct'), 1)
                    columns.splice(this.getAttribute('acct'), 1)
                    ln.splice(this.getAttribute('acct'), 1)
                    window.localStorage.setItem('accounts', JSON.stringify(accounts))
                    window.localStorage.setItem('columns', JSON.stringify(columns))
                    window.localStorage.setItem('lastnotif', JSON.stringify(ln))
                    window.location.reload()
                    // display();
                }
            })
            sa('.resetnotif').forEach(b => {
                b.onclick = function () {
                    ln = JSON.parse(window.localStorage.getItem('lastnotif'))
                    ln[this.getAttribute('acct')] = 1
                    window.localStorage.setItem('lastnotif', JSON.stringify(ln))
                }
            })
        }
        function displaySideNav() {
            i = 0
            if (columns.length == 0) { accounts.forEach(a => { columns.push(['home', 'public', 'federated', 'notifications']) }) }
            s('#sidenav h1').innerHTML = ''
            accounts.forEach(a => {
                s('#sidenav h1').append(n(`<hr/><span><img loading="lazy" acct="${i}" class="md ${i == account ? 'active' : ''}" src="${a.avatar}"/></span>`))
                columns[i].forEach(c => {
                    s('#sidenav h1').append(n(`<a href="#${c}/${i}"><svg><use href="#${c.split('/')[0]}" /></svg></a>`))
                })
                i++
            })
            sa('#sidenav a').forEach(a => { a.onclick = function () { if (this.classList.contains('active')) window.scrollTo({ top: 0, behavior: 'smooth' }); } })
            sa('#sidenav img').forEach(i => {
                i.onclick = function () {
                    sa('#sidenav img').forEach(i => {
                        i.classList.remove('active')
                    })
                    account = this.getAttribute('acct');
                    window.localStorage.setItem('activeAccount', account)
                    this.classList.add('active')
                    whichTimeline = ''
                    display()
                }
            })
        }
        function updateNotifications(which, account = 0) {
            if (Notification.permission == 'default') {
                Notification.requestPermission()
            }
            if (which + '/' + account != whichTimeline) {
                whichTimeline = which + '/' + account
                s('#timeline').innerHTML = ''
                ajax(getInstance(account) + '/api/v1/' + which, {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        JSON.parse(data).forEach(e => {
                            // if (!window.localStorage.getItem('lastnotif')) window.localStorage.setItem('lastnotif', JSON.stringify([1, 1, 1])) //init
                            s('#timeline').append(n(displayNotification(e, account)))
                        })
                        tweak()
                    }
                })
                sa(`[href^="#notifications/${account}"]`).forEach(e => { e.classList.remove('new') })
            }
        }
        function displayNotification(e, acct) {
            // console.log(e)
            lastNotifs = JSON.parse(window.localStorage.getItem('lastnotif'))
            lastNotifs[acct] = Math.max(parseInt(lastNotifs[acct]), parseInt(e.id))
            window.localStorage.setItem('lastnotif', JSON.stringify(lastNotifs))
            maxId = Math.min(maxId, e.id)  //  remember oldest toot for scrolling
            switch (e.type) {
                case 'follow':
                    return `<div class="notif"><p>➕ 
                                        <a href="#a/${acct}/${e.account.id}">
                                            <img loading="lazy" class="md" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> followed you!</p></div>`
                    break;
                case 'reblog':
                    if (!s(`#reb${e.status.id}`)) {
                        return `<div class="notif" id="reb${e.status.id}"><p>🔁 <a href="#a/${acct}/${e.account.id}">
                                            <img loading="lazy" class="md" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> ${e.status.reblogs_count > 1 ? `and ${e.status.reblogs_count - 1} other${e.status.reblogs_count == 1 ? '' : 's'}` : ''} reblogged your status!</p>
                                ${displayStatus(e.status, acct)}</div>`
                    } else {
                        s(`#reb${e.status.id} p img`).before(n(`<img loading="lazy" class="md" src="${e.account.avatar}"/>`))
                    }
                    break;
                case 'update':
                    return `<div class="notif"><p><a href="#a/${acct}/${e.account.id}">
                                            <img loading="lazy" class="md" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> updated their status!</p>
                                ${displayStatus(e.status, acct)}</div>`
                    break;
                case 'favourite':
                    if (!s(`#fav${e.status.id}`)) {
                        return `<div class="notif" id="fav${e.status.id}"><p>⭐ <a href="#a/${acct}/${e.account.id}">
                                            <img loading="lazy" class="md" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> ${e.status.favourites_count > 1 ? `and ${e.status.favourites_count - 1} other${e.status.favourites_count == 2 ? '' : 's'}` : ''} favourited your status!</p>
                                ${displayStatus(e.status, acct)}</div>`
                    } else {
                        s(`#fav${e.status.id} p img`).before(n(`<img loading="lazy" class="md" src="${e.account.avatar}"/>`))
                    }
                    break;
                case 'mention':
                    return `<div class="notif"><p>👉 <a href="#a/${acct}/${e.account.id}">
                                            <img loading="lazy" class="md" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> mentioned you!</p>
                                ${displayStatus(e.status, acct)}</div>`
                    break;
                case 'poll':
                    return `<div class="notif"><p>📊 A poll you participated in ended!</p>
                                ${displayStatus(e.status, acct)}</div>`
                    break;
                default:
                    console.log(e)
                    break;
            }
            return ''
        }
        function updateRemoteStatus(statusUri, inst) {
            if (statusUri.match(/^\d\/\d+$/)) updateStatus(statusUri)
            var [h, n, i, u, id] = statusUri.split('/')
            updateStatus(id, 'https://' + i)
        }
        function updateStatus(id, inst = null) {
            if (inst == null) { // we want to see the toot as from the current "account"
                var [acct, statusId] = id.split('/')
                inst = getInstance(acct)

            } else { // we want to see the remote status
                acct = account
                statusId = id
            }
            if (acct != account) {//we want to display the toot as seen from the currentAccount
                ajax(inst + '/api/v1/statuses/' + statusId, {
                    headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                    success: function (data) {
                        ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + JSON.parse(data).uri, {
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function (data) {
                                updateStatus(account + '/' + JSON.parse(data).statuses[0].id)
                            }
                        })
                    }
                })
            } else {
                if (id == lastStatusId) return;
                lastStatusId = id;
                s('#status').innerHTML = '';

                ajax(inst + '/api/v1/statuses/' + statusId, {
                    headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                    success: function (data) {
                        current = JSON.parse(data)
                        s('#title').innerHTML = `Toot by <img loading="lazy" class="sm" src="${current.account.avatar}"/> ${replaceEmojis(current.account.emojis, current.account.display_name)}
                        from ${replaceEmojis(accounts[acct].emojis, accounts[acct].display_name)}`
                        ajax(inst + '/api/v1/statuses/' + (current.reblog ? current.reblog.id : statusId) + '/context', {
                            headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                            success: function (data) {
                                i = 0;
                                data = JSON.parse(data)
                                data.ancestors.forEach(element => {
                                    s('#status').append(n(displayStatus(element, acct, (i == 0 ? 'top' : 'ancestor'), 't')));
                                    i++
                                });
                                c = current.reblog ? current.reblog : current
                                s('#status').append(n(displayStatus(c, acct, 'focus' + (i == 0 ? ' top' : ''), 't')));
                                data.descendants.forEach(element => {
                                    s('#t' + acct + '-' + element.in_reply_to_id).append(n(displayStatus(element, acct, 'thread', 't')));
                                });
                                tweak();
                            }
                        }
                        )
                    }
                })
            }
        }
        function updateRemoteAccount(accountUri) {
            inst = accountUri.split('/')[2]
            ajax('https://' + inst + "/api/v2/search?q=" + accountUri.split('/')[3] + '@' + inst, {
                // headers: { 'Authorization': 'Bearer ' + getAT(account) },
                success: function (data) {
                    JSON.parse(data).accounts.forEach(a => { if (a.url == accountUri) updateAccount(a.id, 'https://' + inst) })
                    // updateAccount(JSON.parse(data).accounts[0].id, 'https://' + inst)
                }
            })
        }
        function updateAccount(id, inst = null) {
            if (id == lastAccountId) return;
            lastAccountId = id;
            s('#account').innerHTML = '';
            acct = account
            if (!inst) {
                acct = id.split('/')[0]
                inst = getInstance(acct)
                id = id.split('/')[1]
            }
            ajax(inst + '/api/v1/accounts/' + id, {
                success: function (data) {
                    data = JSON.parse(data)
                    html = `
                    <img class="header" src="${data.header}"/>
                    <img class="avatar" src="${data.avatar}"/>
                    <button id="follow" acct="${data.id}"></button>
                    <a href="#account/${data.url}"><button><svg class="sm"><use href="#external"/></svg></button></a>
                    `+ ((acct == account) ? lists[acct].map(l => { return `<button class="addlist outline" list="${l.id}">${l.title}</button>` }).join(' ') : '') + `
                    <div class="dn">${replaceEmojis(data.emojis, data.display_name)}</div>
                    <div class="acct">${data.acct}</div>
                    <div class="note">${data.note}</div>
                    <div class="follows">Follows ${data.following_count}</div>
                    <div class="followed">Followed by ${data.followers_count}</div>
                    <div class="statuses">Statuses ${data.statuses_count}</div>
                    `
                    s('#account').innerHTML = html
                    ajax(getInstance(acct) + `/api/v1/accounts/${id}/lists`, {
                        headers: { 'Authorization': 'Bearer ' + getAT(account) },
                        success: function (data) {
                            data = JSON.parse(data)
                            data.forEach(l => { s(`[list="${l.id}"]`).classList.remove('outline') })
                        }
                    })
                    sa('.addlist').forEach(b => {
                        b.onclick = function () {
                            if (this.classList.contains('outline')) {
                                ajax(getInstance(acct) + `/api/v1/lists/${this.getAttribute('list')}/accounts`, {
                                    method: 'POST', headers: { 'Authorization': 'Bearer ' + getAT(account) },
                                    data: { 'account_ids[]': [id] },
                                    success: function (data) {
                                        b.classList.remove('outline')
                                    }
                                })
                            } else {
                                ajax(getInstance(acct) + `/api/v1/lists/${this.getAttribute('list')}/accounts`, {
                                    method: 'DELETE', headers: { 'Authorization': 'Bearer ' + getAT(account) },
                                    data: { 'account_ids[]': [id] },
                                    success: function (data) {
                                        b.classList.add('outline')
                                    }
                                })
                            }
                        }
                    })
                    s('#title').innerHTML = `<img class="sm" src="${data.avatar}"/> ${replaceEmojis(data.emojis, data.display_name)}
                    from ${replaceEmojis(accounts[acct].emojis, accounts[acct].display_name)}`
                    sa('.note .mention.u-url').forEach(a => {
                        a.removeAttribute('target')
                        ajax(inst + "/api/v2/search?resolve=true&q=" + a.getAttribute('href'), {
                            headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                            success: function (data, xhr) {
                                a.setAttribute('href', '#a/' + acct + '/' + JSON.parse(data).accounts[0].id)
                                // a.setAttribute('href', '#account/' + JSON.parse(data).accounts[0].url)
                            }
                        })
                    })
                    s('#follow').onclick = function () {
                        statusPostAction(data.id, data.url, account, this.querySelector('use').getAttribute('href') == '#usermin' ? 'unfollow' : 'follow')
                    }
                    ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + data.url, {
                        headers: { 'Authorization': 'Bearer ' + getAT(account) },
                        success: function (data) {
                            i = JSON.parse(data).accounts[0].id
                            ajax(getInstance(account) + `/api/v1/accounts/relationships?id[]=${i}`, {
                                headers: { 'Authorization': 'Bearer ' + getAT(account) },
                                success: function (data) {
                                    r = JSON.parse(data)
                                    s('#follow').innerHTML = r[0].following ? '<svg class="sm"><use href="#usermin"/></svg>' : '<svg class="sm"><use href="#userplus"/></svg>'
                                    if (r[0].followed_by) { s('.follows').append(' including you') }
                                }
                            })
                        }
                    })
                }
            })
            ajax(inst + `/api/v1/accounts/${id}/statuses?limit=40`, {
                success: function (data) {
                    JSON.parse(data).forEach(e => {
                        s('#account').append(n(displayStatus(e, acct)))
                        maxId = e.id
                    })
                    tweak();
                }
            })
        }
        function statusPostAction(accountId, accountUri, from, action) {
            var [acct, id] = accountId.split('/');
            type = action.endsWith('follow') ? 'accounts' : 'statuses'
            if (acct != from) {
                ajax(getInstance(from) + "/api/v2/search?resolve=true&q=" + accountUri, {
                    headers: { 'Authorization': 'Bearer ' + getAT(from) },
                    success: function (data) {
                        data = JSON.parse(data)
                        statusPostAction(from + '/' + (type ? data[type][0].id : data[type][0].id), accountUri, from, action)
                    }
                })
            } else {
                ajax(getInstance(from) + `/api/v1/${type}/${id}/${action}`, {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + getAT(from) },
                    success: function (data) {
                        if (action.endsWith('follow')) { s('#follow').innerHTML = action == 'follow' ? '<svg class="sm"><use href="#usermin"/></svg>' : '<svg class="sm"><use href="#userplus"/></svg>' }
                        if (action.endsWith('favourite')) {
                            if (action.startsWith('un')) s(`[uri="${accountUri}"`).classList.remove('fav')
                            else { s(`[uri="${accountUri}"`).classList.add('fav') }
                        }
                        if (action.endsWith('reblog')) {
                            if (action.startsWith('un')) s(`[uri="${accountUri}"`).classList.remove('reb')
                            else { s(`[uri="${accountUri}"`).classList.add('reb') }
                        }
                    }
                })
            }
        }
        function tweak(nb = 0) {
            //resolve and build actions buttons?
            //activate links
            sa('.actions .fav').forEach(e => {
                e.onclick = function () {
                    st = this.parentNode.parentNode
                    statusPostAction(st.getAttribute('id'), st.getAttribute('uri'), account, st.classList.contains('fav') ? 'unfavourite' : 'favourite')
                }
            })
            sa('.actions .reb').forEach(e => {
                e.onclick = function () {
                    st = this.parentNode.parentNode
                    statusPostAction(st.getAttribute('id'), st.getAttribute('uri'), account, st.classList.contains('reb') ? 'unreblog' : 'reblog')
                }
            })
            sa('.actions .del').forEach(e => {
                e.onclick = function () {
                    id = this.parentNode.parentNode.getAttribute('id').substring(1);
                    confirm = showModal('Confirmer la suppression?', function () {
                        ajax(getInstance(account) + `/api/v1/statuses/${id.split('-')[1]}`, {
                            method: 'DELETE',
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function () {
                                whichTimeline = ''
                                display()
                            }
                        })
                    })
                }
            })
            sa('.status .text, .status .poll.voted').forEach(t => { t.onclick = function (e) { if (e.target.parentNode.tagName != 'A' && window.getSelection().toString().length === 0) window.location.href = '#s/' + this.closest('.status').getAttribute('id').substring(1).replace('-', '/') } })
            sa('a.hashtag').forEach(e => { e.removeAttribute('target') })
            sa('.actions .rep, .actions .quo').forEach(e => {
                e.onclick = function () {
                    id = this.parentNode.parentNode.getAttribute('id').substring(1);
                    if (id.split('-')[0] != account) {
                        ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + this.parentNode.parentNode.getAttribute('uri'), {
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function (data) {
                                data = JSON.parse(data)
                                s('#in_reply_to_id').setAttribute('value', data.statuses[0].id)
                            }
                        })
                    }
                    else {
                        s('#in_reply_to_id').setAttribute('value', id.substring(2))
                    }
                    this.parentNode.parentNode.append(s('#write'))
                    s('#write').style.display = 'block'
                    s('#write textarea').value = '@' + this.getAttribute('author') + ' ' + this.getAttribute('mentions') + ' '
                    s('#write textarea').focus();
                    end = s('#write textarea').selectionEnd
                    start = s('#write textarea').selectionStart - this.getAttribute('mentions').length
                    s('#write textarea').value += `
${this.getAttribute('tags')}`
                    if (this.classList.contains('quo')) {
                        s('#write textarea').value += `
${this.getAttribute('href')}`
                    }
                    s('#write textarea').style.height = Math.max(s('#write textarea').scrollHeight, 50) + 'px';
                    s('#write textarea').selectionStart = start - 1
                    s('#write textarea').selectionEnd = end - 1
                }
            })
            sa('.vote').forEach(e => {
                e.onclick = function () {

                    var [p, acct, poll_id] = this.getAttribute('id').split('_')
                    own_votes = Array.from(sa('[name="option_' + poll_id + '[]"]:checked')).map(function (i) { return i.getAttribute('id').split('_')[2] })
                    fd = new FormData()
                    fd.append('choices[]', own_votes)
                    if (acct == account) {
                        ajax(getInstance(account) + `/api/v1/polls/${poll_id}/votes`, {
                            method: 'POST', headers: '',
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            data: { 'choices[]': own_votes },
                            success: function (data) {
                                whichTimeline = ''
                                display()
                            }
                        })
                    } else {
                        uri = this.closest('.status').getAttribute('uri')
                        ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + uri, {
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function (data) {
                                data = JSON.parse(data)
                                poll_id = data.poll.id
                                ajax(getInstance(account) + `/api/v1/polls/${poll_id}/votes`, {
                                    method: 'POST', headers: '',
                                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                                    data: { 'choices[]': own_votes },
                                    success: function (data) {
                                        whichTimeline = ''
                                        display()
                                    }
                                })
                            }

                        })
                    }
                }
            })
            if (nb < 100)
                sa('div.card.toresolve a').forEach(a => {
                    if (a.closest('.status').getAttribute('url') != a.getAttribute('href')) {
                        ajax(getInstance(account) + "/api/v2/search?resolve=true&q=" + a.getAttribute('href'), {
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function (data) {
                                data = JSON.parse(data)
                                if (data.statuses[0]) {
                                    a.parentNode.classList.remove('card')
                                    a.parentNode.classList.remove('toresolve')
                                    a.parentNode.innerHTML = displayStatus(data.statuses[0], account, 'quo')
                                    tweak(nb + 1)
                                } else {
                                    a.parentNode.classList.remove('toresolve')
                                }
                            }
                        })
                    }
                })
        }
        function vote(statusId, statusUri, from, ownvotes) {
            var [acct, id] = statusId.split('-')
        }
        function ajax(url, params) {
            xhr = new XMLHttpRequest()
            if (params.indexValue !== undefined) { xhr.indexValue = params.indexValue }
            xhr.onreadystatechange = function () {
                if (params.success && this.readyState == XMLHttpRequest.DONE && (this.status == 200 || this.status == 202)) {
                    params.success(this.response, this)
                }
                if (params.wait && this.readyState == XMLHttpRequest.DONE && this.status == 206) {
                    params.wait(this.response, this)
                }
            }
            xhr.open(params.method || 'GET', url, true)
            if (params.headers) {
                Object.keys(params.headers).forEach(k => {
                    xhr.setRequestHeader(k, params.headers[k])
                })
            }
            fd = null
            if (params.data) {
                fd = new FormData()
                Object.keys(params.data).forEach(k => {
                    Array.isArray(params.data[k]) ? params.data[k].forEach(v => { fd.append(k, v) }) : fd.append(k, params.data[k])
                })
            }
            xhr.send(fd || null)
        }
        function convertHTTPtoUri(http) {
            var [h, n, i, a] = http.split('/')
            return a.substring(1) + '@' + i
        }
        function displayDate(d) {
            d = (new Date(d)).toLocaleString('fr') //dd/mm/yyy hh:mm:ss
            if (d.substring(0, 10) == (new Date()).toLocaleString('fr').substring(0, 10)) date = d.substring(11, 16)
            else date = d.substring(0, 5)
            return date
        }
        function displayStatus(el, acct, cssClass = '', id_prefix = 's') {
            // console.log(el)
            if (el.reblog) {
                boost = `<svg class="sm"><use href="#reb"/></svg><a href="#a/${acct}/${el.account.id}"><img class="sm" loading="lazy" src="${el.account.avatar}"/> ${replaceEmojis(el.account.emojis, el.account.display_name)}</a> boosted`;
                e = el.reblog;
            } else {
                boost = ''
                e = el;
            }
            mention = false
            if (e.mentions) e.mentions.forEach(m => { m.id == accounts[account].id ? mention = true : '' })

            if (e.edited_at) date = displayDate(e.edited_at) + ' <del>' + displayDate(e.created_at) + '</del>'
            else date = displayDate(e.created_at)

            // e.card ? console.log(e.card) : '';
            // e.poll ? console.log(e.poll) : ''
            return `<div uri="${e.uri}" url="${e.url}" id="${id_prefix}${acct}-${e.id}" ${e.in_reply_to_id ? `in_reply_to_id="${id_prefix}${acct}-${e.in_reply_to_id}"` : ''} class="status${e.favourited ? ' fav' : ''}${e.reblogged ? ' reb' : ''} ${cssClass}">
            <div class="boost">${boost}</div>
            <div class="reply_to">${mention ? '<svg class="sm"><use href="#rep"/></svg>' : ''}</div>
            <div class="author">
                <a href="#a/${acct}/${e.account.id}"><img loading="lazy" class="md" src="${e.account.avatar}"/> ${replaceEmojis(e.account.emojis, e.account.display_name)} <span class="account">(${e.account.acct})</span></a>
                <a href="#account/${e.account.url}"><svg class="vsm"><use href="#external"/></svg></a>
            </div>
            <div class="actions">
                <span class="at">${date}</span>
                ${accounts[acct].id == e.account.id ? `<span class="edit"><a href="#edit/${acct}/${e.id}"><svg><use href="#pen"/></svg></a></span>` : ''}
                ${accounts[acct].id == e.account.id ? '<span class="del"><svg><use href="#cancel"/></svg></span>' : ''}
                <span class="remote"><a href="#status/${e.url}"><svg><use href="#external"/></svg></a></span>
                <!--<span class="link"><a href="#s/${acct}/${e.id}"><svg><use href="#link"/></svg></a></span>-->
                <span class="rep" author="${e.account.acct.indexOf('@') != -1 ? e.account.acct : convertHTTPtoUri(e.account.url)}" mentions="${e.mentions.map(function (m) { return `@${m.acct.indexOf('@') != -1 ? m.acct : convertHTTPtoUri(m.url)}` }).join(' ')}" 
                tags="${e.tags.map(function (t) { return `#${t.name}` }).join(' ')}"><svg><use href="#rep"/></svg>(${e.replies_count})</span>
                <span class="quo" author="${e.account.acct}" mentions="${e.mentions.map(function (m) { return `@${m.acct}` }).join(' ')}" href="${e.url}"
                tags="${e.tags.map(function (t) { return `#${t.name}` }).join(' ')}"><svg><use href="#quote"/></svg></span>
                <span class="reb"><svg><use href="#reb" /></svg>(${e.reblogs_count})</span>
                <span class="fav"><svg><use href="#star" /></svg>(${e.favourites_count})</span>
            </div>
            <div class="text">${replaceMentions(e.mentions, replaceEmojis(e.emojis, parseMd(e.content)).replace(/href=\"https:\/\/[\w\.\-\/]+\/tags\/(\w+)/g, `href="#tag/$1/${acct}`), acct)}</div>
            ${e.poll && !e.poll.voted && !e.poll.expired ? '<div class="poll">' + e.poll.options.map(function (o, i) { return `<div><input type="${e.poll.multiple ? 'checkbox' : 'radio'}" name="option_${e.poll.id}[]" id="option_${e.poll.id}_${i}"/><label for="option_${e.poll.id}_${i}">${o.title}</label></div>` }).join('') + `<div><button class="vote" id="poll_${acct}_${e.poll.id}">Vote!</button></div><div>${e.poll.votes_count} voters</div></div>` : ''}
            ${e.poll && (e.poll.voted || e.poll.expired) ? '<div class="poll voted">' + e.poll.options.map(function (o, i) { return `<div  class="${e.poll.own_votes.includes(i) ? 'gras' : ''}">${o.title} : ${Math.round(o.votes_count / e.poll.voters_count * 100)}%</div><div style="height:6px;width:${o.votes_count / e.poll.voters_count * 100}%;background-color:var(--highlight)"></div>` }).join('') + `</div><div>${e.poll.votes_count} voters</div>` : ''}
            <div class="media${e.media_attachments.length > 1 ? ' multi' : ''}">${e.media_attachments.map(function (m) {
                if (m.type == 'image') return `<img loading="lazy" alt="${m.description ? m.description.replaceAll('"', '&quot;') : ''}" title="${m.description ? m.description.replaceAll('"', '&quot;') : ''}" aria-label="${m.description ? m.description.replaceAll('"', '&quot;') : ''}" src="${m.preview_url}"/>`;
                if (m.type == 'video') return `<video preload="none" src="${m.url}" poster="${m.preview_url}" controls volume="1" aria-label="${m.description ? m.description.replaceAll('"', '&quot;') : ''}" title="${m.description ? m.description.replaceAll('"', '&quot;') : ''}"></video>`
                if (m.type == 'gifv') return `<video preload="none" src="${m.url}" poster="${m.preview_url}" autoplay loop volume="1" aria-label="${m.description ? m.description.replaceAll('"', '&quot;') : ''}" title="${m.description ? m.description.replaceAll('"', '&quot;') : ''}"></video>`
            }).join('')}</div>
            ${e.card ? (e.card.type == 'video' ? `<div class="iframe">${e.card.html}</div>` : `<div class="card toresolve"><a href="${e.card.url}">
                ${e.card.image ? `<img loading="lazy" src="${e.card.image}"/>` : ''}
                <div class="provider">${e.card.provider_name}</div>
                <div class="title">${e.card.title}</div>
                <div class="desc">${e.card.description}</div>
            </a></div>`) : ''}
        </div>`
        }
        function replaceMentions(array, text, acct) {
            array.forEach(m => {
                // text = text.replaceAll(`href="${m.url}"`, `href="#account/${m.url}"`).replaceAll('target="_blank"', '')
                text = text.replaceAll(`href="${m.url}"`, `href="#a/${acct}/${m.id}"`).replaceAll('target="_blank"', '')
            })
            return text
        }
        function replaceEmojis(array, text) {
            array.forEach(e => {
                text = text.replaceAll(':' + e.shortcode + ':', '<img class="emoji" alt="' + e.shortcode + '" title="' + e.shortcode + '" src="' + e.url + '"/>')
            })
            return text
        }
        s('#bplus').onclick = function () {
            s('#bplus').parentNode.insertBefore(n(`<div class="editthread" attach="0"><!--<div class="post">-->
                                                    <textarea class="text" name="status[]" placeholder="And then..."></textarea>
                                                    <label class="button"><input type="file" accept="image/*"/><svg><use href="#camera" /></svg></label>
                                                    <span class="size"></span>
                                                    <button class="cancel"><svg><use href="#cancel" /></svg></button>
                                                    <!--</div>-->
                                                    <div class="media_attachments">
                                                        ${`<div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                                                            <button class="piccancel"><svg>
                                                                    <use href="#cancel" />
                                                                </svg></button>
                                                        </div>`.repeat(4)}
                                                    </div>
                                                   </div>`), s('#bplus'))
            tweakFileInput()
            s('#write div.editthread:last-of-type textarea').focus()
            sa('.cancel').forEach(e => { e.onclick = function () { this.parentNode.remove() } })
        }

        function tweakFileInput() {
            sa('input[type="file"]').forEach(e => {
                e.onchange = function (ev) {
                    if (parseInt(e.closest('.editthread').getAttribute('attach')) < 4) {
                        var file = this.files[0];
                        t = this
                        var reader = new FileReader();
                        reader.onload = function () {
                            editthread = t.closest('.editthread')
                            attach = parseInt(editthread.getAttribute('attach'))
                            editthread.querySelector(`.media_attachments div:nth-child(${attach + 1}) img.media`).src = this.result; //input=>label>.post>.editthread => .media_attachments
                            editthread.querySelector(`.media_attachments>div:nth-child(${attach + 1})`).style.display = 'block'
                            editthread.setAttribute('attach', attach + 1)
                        };
                        reader.readAsDataURL(file);
                    }
                }
            })
            sa('.piccancel').forEach(b => {
                b.onclick = function () {
                    editthread = this.closest('.editthread')
                    editthread.setAttribute('attach', parseInt(editthread.getAttribute('attach')) - 1)
                    this.parentNode.querySelector('img').src = '';
                    this.parentNode.style.display = 'none';
                    this.parentNode.parentNode.append(this.parentNode)
                }
            })
            sa('.media_attachments img').forEach(i => {
                i.onload = function () {
                    if (this.src.substring(0, 4) == 'http' && this.complete && this.naturalHeight != 1) {
                        textarea = this.parentNode.parentNode.parentNode.querySelector('textarea')
                        t = this
                        src = this.src
                        ajax('pj.php?url=' + this.src, {
                            success: function (data, xhr) {
                                textarea.value = textarea.value.replace(src, '') // remove URL from textarea
                                t.src = 'data:' + xhr.getResponseHeader('content-type') + ';base64, ' + data
                                t.parentNode.style.display = 'block'
                                editthread = t.parentNode.parentNode.parentNode //img>div>.media_attachments>.editthread
                                editthread.setAttribute('attach', parseInt(editthread.getAttribute('attach')) + 1)
                            }
                        })
                    }
                }
            })
            sa('textarea.text').forEach(e => { //div.bla //paste image directly
                e.onpaste = function (ev) {
                    d = ev.clipboardData || window.clipboardData
                    for (i = 0; i < d.items.length; i++) {
                        if (d.items[i].type.indexOf('image') == 0) {
                            var reader = new FileReader();
                            reader.onload = function (event) {
                                et = e.closest('.editthread')
                                attach = parseInt(et.getAttribute('attach'))
                                et.querySelector(`.media_attachments div:nth-child(${attach + 1}) img.media`).src = event.target.result
                                et.querySelector(`.media_attachments div:nth-child(${attach + 1})`).style.display = 'block'
                                et.setAttribute('attach', attach + 1)
                            };
                            reader.readAsDataURL(d.items[i].getAsFile());
                        }
                    }
                }
                e.oninput = function (ev) { //paste or inject GIF URL
                    if ((ev.inputType == 'insertText' || ev.inputType == 'insertFromPaste' || ev.inputType == 'insertCompositionText') && ev.data.substring(0, 4) == 'http' && (url = new URL(ev.data))) {
                        editthread = e.closest('.editthread')
                        attach = parseInt(editthread.getAttribute('attach'))
                        console.log(attach)
                        editthread.querySelector(`.media_attachments div:nth-child(${attach + 1}) img.media`).src = ev.data
                    }
                    e.parentNode.querySelector('.size').innerText = 500 - e.value.replace(/https?:\/\/\S+/gm, '12345678901234567890123').replace(/([\s^]@[\w]+)@[\w]+\b/gm, '$1').length //TODO base this on instance config + 23 chars per URL, no domain name in @
                    if (ev.target.selectionEnd == ev.target.selectionStart) {
                        sub = ev.target.value.substring(0, ev.target.selectionEnd)
                        sub = sub.substring(sub.lastIndexOf(' ') + 1, sub.length)
                        if (sub.substring(0, 1) == '@') {
                            ajax(getInstance(account) + '/api/v2/search?type=accounts&q=' + sub, {
                                headers: { 'Authorization': 'Bearer ' + getAT(account) },
                                success: function (data) {
                                    data = JSON.parse(data)
                                    if (s('#ac')) s('#ac').remove()
                                    ev.target.after(n('<div id="ac"></div>'))
                                    data.accounts.forEach(a => { s('#ac').append(n(`<div><img class="vsm" src="${a.avatar}"/><span class="acct">${a.acct}</span> (${a.display_name})</div>`)) })
                                    sa('#ac>div').forEach(d => {
                                        d.onclick = function () {
                                            ev.target.selectionStart = ev.target.selectionStart - sub.length
                                            ev.target.value = ev.target.value.substring(0, ev.target.selectionStart) + '@' + this.querySelector('.acct').innerText + ' ' + ev.target.value.substring(ev.target.selectionEnd)
                                            ev.target.focus()
                                            s('#ac').remove()
                                        }
                                    })
                                }
                            })
                        }
                        if (sub.substring(0, 1) == '#') {
                            ajax(getInstance(account) + '/api/v2/search?type=hashtags&q=' + sub.substring(1), {
                                headers: { 'Authorization': 'Bearer ' + getAT(account) },
                                success: function (data) {
                                    data = JSON.parse(data)
                                    if (s('#ac')) s('#ac').remove()
                                    ev.target.after(n('<div id="ac"></div>'))
                                    data.hashtags.forEach(a => { s('#ac').append(n(`<div><span class="acct">${a.name}</span></div>`)) })
                                    sa('#ac>div').forEach(d => {
                                        d.onclick = function () {
                                            ev.target.selectionStart = ev.target.selectionStart - sub.length
                                            ev.target.value = ev.target.value.substring(0, ev.target.selectionStart) + '#' + this.querySelector('.acct').innerText + ' ' + ev.target.value.substring(ev.target.selectionEnd)
                                            ev.target.focus()
                                            s('#ac').remove()
                                        }
                                    })
                                }
                            })
                        }
                        if (sub.substring(0, 1) != '#' && sub.substring(0, 1) != '@') s('#ac').remove()
                    }
                }
            })
        }
        tweakFileInput()
        const sleep = ms => {
            return new Promise(resolve => setTimeout(resolve, ms))
        }
        const uploadFile = (toot, i) => { //uploads and then checks upload is finished
            return new Promise((resolve, reject) => {
                const file = DataURIToBlob(toot.querySelector(`.media_attachments div:nth-child(${i + 1}) img`).getAttribute('src'))
                ajax(getInstance(account) + '/api/v2/media', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    data: { file: file, description: toot.querySelector(`.media_attachments div:nth-child(${i + 1}) textarea`).value },
                    success: async function (data) {
                        id = await checkUpload(JSON.parse(data).id).then(r => { return r })
                        resolve(JSON.parse(data))
                    }
                })
            })
        }
        async function toot(toots, i, in_reply_to_id = '') { // toots multiple toots in a row
            if (toots.length <= i) {//finished
                cleanUpWrite()
                return
            }
            const uploads = []
            medias = toots[i].querySelectorAll('.media_attachments div')
            toots[i].scrollIntoView()
            max = parseInt(toots[i].getAttribute('attach'))
            for (j = 0; j < max; j++) { //loop on img
                uploads.push(uploadFile(toots[i], j).then(r => { return r.id }))
            }
            const results = await Promise.all(uploads) //uploads and wait for each to be ready
            fd = new FormData();
            fd.append('status', toots[i].querySelector('textarea.text').value)
            fd.append('visibility', s('#visibility').value.toLowerCase())
            fd.append('language', s('#lang').value)
            results.forEach(r => { fd.append('media_ids[]', r) }) // attach all medias
            dataToSend = { status: toots[i].querySelector('textarea.text').value, visibility: s('#visibility').value.toLowerCase(), language: s('#lang').value }//, 'media_ids[]': results }
            if (parseInt(toots[i].getAttribute('attach')) > 0) dataToSend['media_ids[]'] = results
            if (in_reply_to_id && in_reply_to_id != '') dataToSend.in_reply_to_id = in_reply_to_id
            if (toots[i].querySelector('#toot_id') && toots[i].querySelector('#toot_id').value != '') {
                ajax(getInstance(account) + '/api/v1/statuses/' + toots[i].querySelector('#toot_id').value, {
                    success: function (data) {
                        JSON.parse(data).media_attachments.forEach(m => { results.push(m.id) })
                        dataToSend['media_ids[]'] = results
                        ajax(getInstance(account) + '/api/v1/statuses/' + toots[i].querySelector('#toot_id').value, {
                            method: 'PUT',
                            data: dataToSend,
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function (data) {
                                toots[i].querySelectorAll('textarea').forEach(t => { t.disabled = true })
                                toot(toots, i + 1, JSON.parse(data).id) // toot next one
                            }
                        })

                    }
                })
                //we are editing a toot
            } else {
                ajax(getInstance(account) + '/api/v1/statuses', {
                    method: 'POST',
                    data: dataToSend,
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        toots[i].querySelectorAll('textarea').forEach(t => { t.disabled = true })
                        toot(toots, i + 1, JSON.parse(data).id) // toot next one
                    }
                })
            }
        }
        s('#toob').onclick = function () {
            toots = sa('.editthread')
            //check media descriptions
            t = true
            toots.forEach(toot => {
                texts = toot.querySelectorAll('.media_attachments div[style*="block"] textarea')
                texts.forEach(desc => {
                    if (!desc.value) {
                        t = false
                    }
                })
            })
            if (t) {
                toot(toots, 0, s('#in_reply_to_id').getAttribute('value'))
            }
        }
        function checkUpload(id) {
            return new Promise((resolve, reject) => {
                ajax(getInstance(account) + '/api/v1/media/' + id, {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        resolve(id);// finished
                    },
                    wait: function (data) {
                        sleep(1000).then(v => { resolve(checkUpload(id)) })
                    }
                })
            })
        }
        function cleanUpWrite() {
            sa('#write .editthread:not(:first-child)').forEach(t => { t.remove() }) //remove additional textareas
            s('.size').innerHTML = '';
            s('#write .editthread').setAttribute('attach', 0)
            s('#write .editthread').style.display = 'block'
            s('#write .editthread textarea.text').value = ''
            s('#toot_id').value = ''
            s('#write .editthread label').style.display = 'inline-block'
            sa('#write img').forEach(i => { i.src = '' }) //reset media attachments
            sa('.preview').forEach(p => { p.remove() })
            sa('#write .editthread textarea').forEach(t => { t.value = ''; t.disabled = false })//reset remaining texteareas (alt texts)
            attach = false // reset attachment status
            sa('.media_attachments>div').forEach(d => { d.style.display = 'none' })  //hide media attachments 
            s('#account').after(s('#write'))//move #write back to its place
            whichTimeline = ''
            if (window.location.hash.substring(0, 6) == '#edit/') window.location.hash = window.location.hash.replace('edit', 'status')
            else display()
        }
        function DataURIToBlob(dataURI) {
            const splitDataURI = dataURI.split(',')
            const byteString = splitDataURI[0].indexOf('base64') >= 0 ? atob(splitDataURI[1]) : decodeURI(splitDataURI[1])
            const mimeString = splitDataURI[0].split(':')[1].split(';')[0]
            const ia = new Uint8Array(byteString.length)
            for (let i = 0; i < byteString.length; i++)
                ia[i] = byteString.charCodeAt(i)
            return new Blob([ia], { type: mimeString })
        }

        window.onscroll = function (ev) {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 1000) {
                h = window.location.hash.split('/')
                div = '#timeline'
                switch (h[0]) {
                    case '#home':
                        feed = 'timelines/home'
                        acct = h[1]
                        break;
                    case '#notifications':
                        feed = 'notifications'
                        acct = h[1]
                        break;
                    case '#public':
                        feed = 'timelines/public?local=true'
                        acct = h[1]
                        break;
                    case '#federated':
                        feed = 'timelines/public'
                        acct = h[1]
                        break;
                    case '#tag':
                        feed = 'timelines/tag/' + h[1]
                        acct = h[2]
                        break;
                    case '#a':
                        feed = 'accounts/' + h[2] + '/statuses'
                        acct = h[1]
                        div = '#account'
                        break;
                    case '#list':
                        feed = 'timelines/list/' + h[1]
                        acct = h[2]
                        break;
                    default:
                        break;
                }
                if (typeof acct === undefined) return;
                if (waitingFor > maxId) {
                    ajax(getInstance(acct) + '/api/v1/' + feed + '?limit=40&max_id=' + maxId, {
                        headers: { 'Authorization': 'Bearer ' + getAT(acct) }, success: function (data) {
                            JSON.parse(data).forEach(el => {
                                s(div).append(n(h[0] == '#notifications' ? displayNotification(el, acct) : (!hiddenAccounts.includes(el.account.id) || h[0] == '#list') ? displayStatus(el, acct) : ''))
                                maxId = Math.min(maxId, el.id)
                                sa('[in_reply_to_id="s' + acct + '-' + el.id + '"]').forEach(c => {
                                    s('#s' + acct + '-' + el.id).appendChild(c)
                                })
                            })
                            tweak();
                        }
                    })
                    waitingFor = maxId
                }
            }
        }
        function parseMd(md) {
            md = md.replaceAll('</p><p>', "\n\n")
            md = md.replace('<p>', '')
            md = md.replace('</p>', '\n\n')
            md = md.replaceAll('<br />', "\n")
            md = md.replaceAll('<br>', "\n")
            md = md.replaceAll('&gt;', '>')

            // console.log(md)
            //ul
            md = md.replace(/^\s*\n\*/gm, '<ul>\n*');
            md = md.replace(/^([\*\-].+)\s*\n([^\*\-])/gm, '$1\n</ul>\n\n$2');
            md = md.replace(/^\n?\*(.+)\n/gm, '<li>$1</li>');

            //ol
            md = md.replace(/^\s*\n\d\./gm, '<ol>\n1.');
            md = md.replace(/^(\d\..+)\s*\n([^\d\.])/gm, '$1\n</ol>\n\n$2');
            md = md.replace(/^\d\.(.+)\n/gm, '<li>$1</li>');

            md = md.replaceAll(">\n<", '><')
            //blockquote
            md = md.replace(/^\>(.+)/gm, '<blockquote>$1</blockquote>');
            md = md.replace(/<\/blockquote>\s*<blockquote>/gm, '<br />')

            //h
            md = md.replace(/^[\#]{6}\s+(.+)/gm, '<h6>$1</h6>');
            md = md.replace(/^[\#]{5}\s+(.+)/gm, '<h5>$1</h5>');
            md = md.replace(/^[\#]{4}\s+(.+)/gm, '<h4>$1</h4>');
            md = md.replace(/^[\#]{3}\s+(.+)/gm, '<h3>$1</h3>');
            md = md.replace(/^[\#]{2}\s+(.+)/gm, '<h2>$1</h2>');
            md = md.replace(/^[\#]{1}\s+(.+)/gm, '<h1>$1</h1>');

            //links
            // md = md.replace(/[\[]{1}([^\]]+)[\]]{1}[\(]{1}([^\)\"]+)(\"(.+)\")?[\)]{1}/g, '<a href="$2" title="$4">$1</a>');

            //font styles
            md = md.replace(/[\*\_]{2}\b([^\*\_]+)\b[\*\_]{2}/g, '<b>$1</b>');
            md = md.replace(/[\*\_]{1}\b([^\*\_>=]+)\b[\*\_]{1}/g, '<i>$1</i>');
            md = md.replace(/[\~]{2}([^\~]+)[\~]{2}/g, '<del>$1</del>');

            //pre
            md = md.replace(/^\s*\n\`\`\`(([^\s]+))?/gm, '<pre class="$2">');
            md = md.replace(/^\`\`\`\s*\n/gm, '</pre>\n\n');

            //code
            md = md.replace(/[\`]{1}([^\`]+)[\`]{1}/g, '<code>$1</code>');

            //p
            md = md.replace(/^\s*(\n)?(.+)/gm, function (m) {
                return /\<(\/)?(h\d|ul|ol|li|blockquote|pre|img)/.test(m) ? m : '<p>' + m + '</p>';
            });
            return md
        }

        /* TODOS
            CW support
            compose a poll
            remove / add picture while editing
            keyboard nav?
            local view of (own) boosts/favs for remote statuses
            don't reload window after vote
        */
    </script>
</body>

</html>