<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Toob</title>
    <link rel="icon" type="image/x-icon" href="./toob.svg">
    <style>
        body {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: small;
            max-width: 800;
            margin: auto;
            background-color: #333;
            color: #ccc;
        }

        body>div {
            display: none;
        }

        a {
            color: #3088D4;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .status {
            border: 1px solid #ccc;
            border-radius: .3em;
            margin: .2em;
            padding: .2em;
            overflow: hidden;
        }

        .author {
            float: left;
        }

        .author .account {
            font-size: smaller;
        }

        .author img {
            max-width: 20;
        }

        .boost img {
            max-width: 15;
        }

        .boost {
            font-size: smaller;
        }

        .text {
            clear: both;
            overflow: auto;
        }

        .text p a span.invisible {
            display: none;
        }

        .text p a span.ellipsis::after {
            content: 'â€¦';
        }

        .text p {
            text-align: justify;
        }

        .media {
            text-align: center;
        }

        .media.multi {
            overflow-x: scroll;
            overflow-y: hidden;
            white-space: nowrap;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .media * {
            max-width: 100%;
        }

        .media.multi * {
            max-width: 95%;
        }

        img+img {
            margin-left: .2em;
        }

        .card {
            width: 90%;
            margin: auto;
            border-radius: .3em;
            border: 1px solid #ccc;
            height: 100px;
            overflow: hidden;
            overflow-y: auto;
        }

        .card img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            float: left;
            margin-right: .3em;
        }

        .card .title {
            font-weight: bold;
        }

        .status .status {
            border: none;
            border-radius: 0;
            border-left: 1px solid #ccc;
            padding-right: 0;
            margin-right: 0;
        }

        .actions {
            text-align: right;
            float: right;
        }

        .actions i {
            font-style: normal;
            font-size: large;
        }

        .actions span {
            border-radius: .3em;
            padding: .3em;
            cursor: pointer;
            border: 1px solid #ccc;
        }

        .status.fav .fav,
        .status.reb .reb {
            background-color: #ccc;
            color: #333
        }

        #write textarea {
            display: block;
            width: 100%;
            font-family: inherit;
        }
        img.emoji {max-width: 1em;}

    </style>
</head>

<body>
    <nav id="nav">
        <h1><a href="#home">H</a> <a href="#public">P</a> <a href="#write">W</a> <a href="#logout">L</a></h1>
    </nav>
    <div id="timeline"></div>
    <div id="status"></div>
    <div id="write">
        <input type="hidden" id="in_reply_to_id" />
        <textarea placeholder="..."></textarea>
        <button id="plus">+</button>
        <button id="toob">Toob!</button>
    </div>
    <div id="login">
        <input type="text" id="instance" placeholder="https://piaille.fr" />
        <button id="loginb">Se connecter</button>
    </div>
    <script>
        code = new URLSearchParams(window.location.search).get('code')
        if (code) {
            fd = new FormData();
            fd.append('client_id', window.localStorage.getItem(window.localStorage.getItem('instance') + '_client_id'))
            fd.append('client_secret', window.localStorage.getItem(window.localStorage.getItem('instance') + '_client_secret'))
            fd.append('grant_type', 'authorization_code')
            fd.append('redirect_uri', window.location.protocol + '//' + window.location.host + window.location.pathname)
            fd.append('code', code)
            fd.append('scope', 'read write')
            ajax('POST', window.localStorage.getItem('instance') + "/oauth/token", fd,
                function (e) {
                    if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                        window.localStorage.setItem('at', JSON.parse(e.target.response).access_token)
                        window.location.href = window.location.pathname
                    }
                }
            )
        }
        s('#loginb').onclick = function () {
            inst = s('#instance').value
            if (inst.substring(0, 8) != 'https://') inst = 'https://' + inst
            if (!window.localStorage.getItem(inst + '_client_id')) {
                $.ajax(inst + "/api/v1/apps", {
                    method: 'POST',
                    data: {
                        client_name: "Toob",
                        redirect_uris: window.location.protocol + '//' + window.location.host + window.location.pathname,
                        scopes: "read write",
                        website: "https://github.com/teddyber/toob"
                    },
                    success: function (data) {
                        window.localStorage.setItem(inst + '_client_id', data.client_id)
                        window.localStorage.setItem(inst + '_client_secret', data.client_secret)
                        window.localStorage.setItem('instance', inst)
                        window.location.href = `${inst}/oauth/authorize?client_id=${window.localStorage.getItem(inst + '_client_id')}&scope=read+write&redirect_uri=${window.location.protocol + '//' + window.location.host + window.location.pathname}&response_type=code`
                    }
                })
            }
            else {
                window.localStorage.setItem('instance', inst)
                window.location.href = `${inst}/oauth/authorize?client_id=${window.localStorage.getItem(inst + '_client_id')}&scope=read+write&redirect_uri=${window.location.protocol + '//' + window.location.host + window.location.pathname}&response_type=code`
            }
        }

        whichTimeline = '';
        window.addEventListener('hashchange', (event) => {
            display();
        });

        if (window.location.hash == '') {
            if (window.localStorage.getItem('instance'))
                window.location.hash = '#home';
            else
                window.location.hash = '#login';
        } else
            display()
        function s(p) { return document.querySelector(p); }// Select node from Pattern
        function sa(p) { return document.querySelectorAll(p); }// Select All nodes from Pattern
        function n(h) { return document.createRange().createContextualFragment(h) } // create Node from Html
        function display() {
            if (window.location.hash == '#logout') {
                window.localStorage.removeItem('at')
                window.localStorage.removeItem('instance')
                window.location.href = window.location.pathname;
            }
            if (window.location.hash == '#login') {
                showOnly('#login')
            }
            if (window.location.hash == '#home') {
                showOnly('#timeline')
                updateTimeline('timelines/home');
            }
            if (window.location.hash == '#write') {
                showOnly('#write')
            }
            if (window.location.hash == '#public') {
                showOnly('#timeline')
                updateTimeline('timelines/public');
            }
            if (window.location.hash.substring(0, 6) == '#tags/') {
                showOnly('#timeline')
                updateTimeline('timelines/tag/' + window.location.hash.substring(6));
            }
            if (window.location.hash.substring(0, 8) == '#status/') {
                showOnly('#status')
                updateStatus(window.location.hash.substring(8))
            }

        }
        function showOnly(div) {
            sa('body > div').forEach(e => { e.style.display = 'none' })
            s(div).style.display = 'block'
        }
        function updateTimeline(which) {
            if (which != whichTimeline) {
                whichTimeline = which
                s('#timeline').textContent = ''
                ajax("GET", window.localStorage.getItem('instance') + '/api/v1/' + which + '?limit=40', null, function (e) {
                    if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                        JSON.parse(e.target.response).forEach(el => {
                            console.log(el)
                            s('#timeline').append(n(displayStatus(el)))
                            sa('[in_reply_to_id="s' + el.id + '"]').forEach(c => {
                                s('#s' + el.id).appendChild(c)
                            })
                        });
                        //activate links
                        sa('.actions .fav').forEach(e => {
                            e.onclick = function () {
                                st = this.parentNode.parentNode
                                id = this.parentNode.parentNode.getAttribute('id').substring(1);
                                prefix = this.parentNode.parentNode.classList.contains('fav') ? 'un' : '';
                                ajax('POST', window.localStorage.getItem('instance') + `/api/v1/statuses/${id}/${prefix}favourite`, null, function (e) {
                                    if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                                        prefix == 'un' ? st.classList.remove('fav') : st.classList.add('fav')
                                    }
                                })
                            }
                        })
                        sa('.actions .reb').forEach(e => {
                            e.onclick = function () {
                                st = this.parentNode.parentNode
                                id = this.parentNode.parentNode.getAttribute('id').substring(1);
                                prefix = this.parentNode.parentNode.classList.contains('reb') ? 'un' : '';
                                ajax('POST', window.localStorage.getItem('instance') + `/api/v1/statuses/${id}/${prefix}reblog`, null, function (e) {
                                    if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                                        prefix == 'un' ? st.classList.remove('reb') : st.classList.add('reb')
                                    }
                                })
                            }
                        })
                        sa('a.hashtag').forEach(e => { e.removeAttribute('target', '') })
                        sa('.actions .rep').forEach(e => {
                            e.onclick = function () {
                                id = this.parentNode.parentNode.getAttribute('id').substring(1);
                                s('#in_reply_to_id').setAttribute('value', id)
                                this.parentNode.parentNode.append(s('#write'))
                                s('#write').style.display = 'block'
                            }
                        })
                    }
                })
            }
        }
        function updateStatus(id) {
            s('#status').innerHTML = '';
            ajax('GET', window.localStorage.getItem('instance') + '/api/v1/statuses/' + id, new FormData(), function (e) {
                if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    current = JSON.parse(e.target.response)
                    ajax('GET', window.localStorage.getItem('instance') + '/api/v1/statuses/' + (current.reblog ? current.reblog.id : id) + '/context', new FormData(), function (e) {
                        if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                            i = 0;
                            data = JSON.parse(e.target.response)
                            data.ancestors.forEach(element => {
                                s('#status').append(n(displayStatus(element, (i == 0 ? 'top' : 'ancestor'), 't')));
                                i++
                            });
                            c = current.reblog ? current.reblog : current
                            s('#status').append(n(displayStatus(c, 'focus' + (i == 0 ? ' top' : ''), 't')));

                            data.descendants.forEach(element => {
                                s('#t' + element.in_reply_to_id).append(n(displayStatus(element, 'thread', 't')));
                            });
                        }
                    })
                }
            })
        }
        function ajax(method, url, params, success) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = success;
            xhttp.open(method, url, true);
            xhttp.setRequestHeader('Authorization', 'Bearer ' + window.localStorage.getItem('at'))
            if (params)
                xhttp.send(params);
            else
                xhttp.send()
        }
        function displayStatus(el, cssClass = '', id_prefix = 's') {
            if (el.reblog) {
                boost = `<img src="${el.account.avatar}"/> ${replaceEmojis(el.account.emojis, el.account.display_name)} boosted`;
                e = el.reblog;
            } else {
                boost = ''
                e = el;
            }
            return `<div id="${id_prefix}${e.id}" in_reply_to_id="s${e.in_reply_to_id}" class="status${e.favourited ? ' fav' : ''}${e.reblogged ? ' reb' : ''} ${cssClass}">
            <div class="boost">${boost}</div>
            <div class="reply_to"></div>
            <div class="author"><img src="${e.account.avatar}"/> ${replaceEmojis(e.account.emojis, e.account.display_name)} <span class="account">(${e.account.acct})</span></div>
            <div class="actions">
                <span class="link"><a href="#status/${e.id}"><i>V</i></a></span> 
                <span class="rep"><i>R</i>(${e.replies_count})</span>
                <span class="reb"><i>B</i>(${e.reblogs_count})</span> 
                <span class="fav"><i>F</i></span>
            </div>
            <div class="text">${replaceEmojis(e.emojis, e.content).replace(/href=\"https:\/\/[\w.\/]+\/tags\//g, 'href="#tags/')}</div>
            <div class="media${e.media_attachments.length > 1 ? ' multi' : ''}">${e.media_attachments.map(function (m) {
                if (m.type == 'image') return `<img alt="${m.description}" src="${m.preview_url}"/>`;
                if (m.type == 'video') return `<video src="${m.url}" poster="${m.preview_url}" controls role="button" tabindex="0" volume="1"></video>`
            }).join('')}</div>
            ${e.card ? `<div class="card"><a href="${e.card.url}">
                ${e.card.image ? `<img src="${e.card.image}"/>` : ''}
                <div class="provider">${e.card.provider_name}</div>
                <div class="title">${e.card.title}</div>
                <div class="desc">${e.card.description}</div>
            </a></div>`: ''}
        </div>`
        }
        function replaceEmojis(array, text) {
            array.forEach(e=>{
                text = text.replaceAll(':'+e.shortcode+':', '<img class="emoji" src="'+e.url+'"/>')
            })
            return text
        }
        function resize_textarea() {
            this.style.overflow = 'hidden';
            this.style.height = 0;
            this.style.height = Math.max(this.scrollHeight, 50) + 'px';
        }
        sa('textarea').forEach(e => {
            e.onkeyup = resize_textarea;
        })
        s('#plus').onclick = function () {
            s('#plus').parentNode.insertBefore(n('<textarea name="status[]" placeholder="Next..."></textarea>'), s('#plus'))
        }
        s('#toob').onclick = function () {
            ts = sa('textarea')
            toob(ts, 0, s('#in_reply_to_id').getAttribute('value'))
        }
        function toob(toots, index, in_reply_to_id = null) {
            if (index >= toots.length) {
                //TODO remove and empty textareas
                window.location.hash = '#write'
            } else {
                fd = new FormData();
                fd.append('status', toots[index].value)
                fd.append('visibility', 'public')
                fd.append('language', 'fr')
                if (in_reply_to_id && in_reply_to_id != '') fd.append('in_reply_to_id', in_reply_to_id)

                ajax('POST', window.localStorage.getItem('instance') + '/api/v1/statuses', fd, function (e) {
                    if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                        toob(toots, index + 1, JSON.parse(e.target.response).id);
                    }
                })
            }
        }
    </script>
</body>

</html>