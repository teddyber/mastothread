<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Toob</title>
    <link rel="icon" type="image/x-icon" href="./toob.svg">
    <link rel="manifest" href="manifest.json" />
    <style>
        :root {
            /* --color: #333;
            --bg: #eee; */
            --highlight: #3088D4;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --color: #333;
                --bg: #eee;
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color: #eee;
                --bg: #333;
            }
        }

        body {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: small;
            max-width: 800;
            margin: auto;
            background-color: var(--bg);
            color: var(--color);
        }

        body>div {
            display: none;
            margin-top: 38px;
            margin-left: 36px;
        }

        #topnav {
            position: fixed;
            z-index: 10;
            display: block;
            width: calc(800px - 32px);
            margin-left: 35px;
            max-width: calc(100% - 36px);
            top: 0px;
            background-color: var(--bg);
            box-shadow: 0 3px 3px var(--color);
        }

        #sidenav {
            position: fixed;
            top: 0px;
            width: 32px;
            height: 100%;
            background-color: var(--bg);
            box-shadow: 3px 0px 2px var(--color);
            overflow-y: scroll;
            scrollbar-width: none;
        }

        #sidenav svg {
            margin-top: .5em;
        }

        #sidenav a svg,
        .link a svg {
            color: var(--color);
        }

        #sidenav a.active svg {
            color: var(--highlight);
        }

        @keyframes new {
            0% {
                color: var(--color)
            }

            50% {
                color: var(--highlight);
            }

            100% {
                color: var(--color)
            }
        }

        #sidenav a.new svg {
            animation-name: new;
            animation-duration: 2s;
            animation-iteration-count: infinite;
        }

        a {
            color: var(--highlight);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .status {
            border: 1px solid var(--color);
            border-radius: .3em;
            margin: .2em;
            padding: .2em;
            overflow: hidden;
        }

        button,
        label.button,
        select {
            border: none;
            color: #eee;
            background-color: var(--highlight);
            padding: 4px 8px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1.2em;
            border-radius: .5em;
            cursor: pointer;
        }

        select {
            vertical-align: middle;
            height: 32px;
        }

        input[type="file"] {
            display: none;
        }

        .author {
            float: left;
        }

        .author .account {
            font-size: smaller;
        }

        .author img,
        .avatar {
            max-width: 20;
        }

        .notif {
            border-bottom: 1px solid var(--color);
        }

        .boost img {
            max-width: 15;
        }

        .boost {
            font-size: smaller;
        }

        .text {
            clear: both;
            overflow: auto;
        }

        .text p a span.invisible {
            display: none;
        }

        .text p a span.ellipsis::after {
            content: 'â€¦';
        }

        .text p {
            text-align: justify;
        }

        .media {
            text-align: center;
            margin-top: .5em;
        }

        .media.multi {
            overflow-x: scroll;
            overflow-y: hidden;
            white-space: nowrap;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .media * {
            max-width: 100%;
        }

        .media.multi * {
            max-width: 95%;
        }

        img+img {
            margin-left: .2em;
        }

        .card {
            width: 90%;
            margin: auto;
            border-radius: .3em;
            border: 1px solid var(--color);
            height: 100px;
            overflow: hidden;
            overflow-y: auto;
        }

        .iframe {
            width: 90%;
            margin: auto;
            border-radius: .3em;
            border: 1px solid var(--color);
            height: 300px;
        }

        .iframe iframe {
            width: 100%;
            height: 100%;
        }

        .card img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            float: left;
            margin-right: .3em;
        }

        .card .title {
            font-weight: bold;
        }

        .status .status {
            border: none;
            border-radius: 0;
            border-left: 1px solid var(--color);
            padding-right: 0;
            margin-right: 0;
        }

        .actions {
            text-align: right;
            float: right;
        }

        .actions i {
            font-style: normal;
            font-size: large;
        }

        .actions span {
            border-radius: .3em;
            padding: .3em;
            cursor: pointer;
            border: 1px solid var(--color);
        }

        .status.fav>div>.fav,
        .status.reb>div>.reb {
            background-color: var(--highlight);
            color: var(--bg);
            border: var(--highlight);
        }

        #write>textarea {
            display: block;
            width: 100%;
            font-family: inherit;
        }

        textarea {
            border-radius: .5em;
            border: 1px solid #333;
        }

        img.emoji {
            max-width: 1em;
        }

        .status[in_reply_to_id] {
            border-left: 2px solid var(--highlight);
        }

        #account .header {
            width: 100%;
        }

        #account .avatar {
            width: 100;
        }

        .editthread .post {
            display: flex;
            align-items: center;
            clear: both;
            min-height: 48px;
        }

        .editthread>* {
            margin: .1em;
        }

        .editthread textarea {
            font-family: inherit;
            min-height: 300px;
            width: calc(100% - 100px);
        }

        .editthread button {
            height: 32px;
            max-height: 32px;
        }

        .editthread label {
            height: 24px;
            max-height: 24px;
        }

        .media_attachments {
            clear: both;
        }

        .media_attachments>div {
            display: none;
        }

        .media_attachments>div>img {
            width: calc(50% - 30px)
        }

        .media_attachments>div>textarea {
            width: calc(50% - 30px)
        }

        .media_attachments>div>button {
            height: 40px
        }

        #sidenav svg,
        #modal svg {
            width: 24px;
            height: 24px;
            display: inline-block;
        }

        .actions svg {
            width: 18px;
            height: 18px;
        }

        .actions>span {
            height: 18px;
            display: inline-block;
        }

        body>svg {
            height: 1px;
        }

        #write svg {
            height: 24px;
            width: 24px;
        }

        #write button,
        #write label {
            vertical-align: middle;
        }

        .gras {
            font-weight: bold;
        }

        #modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        #modal .close {
            color: #aaa;
            float: right;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #accounts img,
        #topnav svg {
            height: 32px;
            width: 32px;
            margin-left: .3em;
        }

        #accounts img.active {
            border: var(--highlight) solid 2px
        }

        nav h1 a {
            position: relative;
            display: inline-block;
        }

        nav h1 a svg {
            display: block;
        }

        nav h1 a img {
            width: 70%;
            position: absolute;
            top: 24px;
            left: 12px
        }
    </style>
</head>

<body>
    <svg>
        <defs>
            <symbol id="home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" class="feather feather-home">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </symbol>
            <symbol id="public" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </symbol>
            <symbol id="pen" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
                <path d="M2 2l7.586 7.586"></path>
                <circle cx="11" cy="11" r="2"></circle>
            </symbol>
            <symbol id="bell" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </symbol>
            <symbol id="logout" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </symbol>
            <symbol id="tree" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <circle cx="18" cy="18" r="3"></circle>
                <circle cx="6" cy="6" r="3"></circle>
                <path d="M6 21V9a9 9 0 0 0 9 9"></path>
            </symbol>
            <symbol id="rep" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <polyline points="9 10 4 15 9 20"></polyline>
                <path d="M20 4v7a4 4 0 0 1-4 4H4"></path>
            </symbol>
            <symbol id="reb" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <polyline points="17 1 21 5 17 9"></polyline>
                <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                <polyline points="7 23 3 19 7 15"></polyline>
                <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
            </symbol>
            <symbol id="star" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <polygon
                    points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2">
                </polygon>
            </symbol>
            <symbol id="cancel" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="9" y1="9" x2="15" y2="15"></line>
                <line x1="15" y1="9" x2="9" y2="15"></line>
            </symbol>
            <symbol id="send" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </symbol>
            <symbol id="plus" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </symbol>
            <symbol id="camera" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </symbol>
            <symbol id="searchi" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </symbol>
            <symbol id="trendi" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </symbol>
            <symbol id="quote" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <line x1="10" y1="8" x2="10" y2="12"></line>
                <line x1="14" y1="8" x2="14" y2="12"></line>
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </symbol>
            <symbol id="i-adduser" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
                stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </symbol>
        </defs>
    </svg>
    <nav id="sidenav">
        <h1>
            <!-- <a href="#home/0"><svg>
                <use href="#home" />
            </svg>
            <img src="https://static.piaille.fr/accounts/avatars/109/285/191/576/839/720/original/4e7b3cac2ea00e1c.jpg"/>
        </a>
        <a href="#home/1"><svg>
            <use href="#home" />
        </svg>
        <img src="https://static.piaille.fr/accounts/avatars/109/285/191/576/839/720/original/4e7b3cac2ea00e1c.jpg"/>
    </a>
    <a href="#home/2"><svg>
        <use href="#home" />
    </svg>
    <img src="https://static.piaille.fr/accounts/avatars/109/285/191/576/839/720/original/4e7b3cac2ea00e1c.jpg"/>
</a> -->
            <a href="#write"><svg>
                    <use href="#pen" />
                </svg></a>
            <!-- <a href="#trend"><svg>
                    <use href="#trendi" />
                </svg></a> -->
            <a href="#search"><svg>
                    <use href="#searchi" />
                </svg></a>
            <!-- <a href="#logout"><svg>
                    <use href="#logout" />
                </svg></a> -->
        </h1>
    </nav>
    <nav id="topnav">
        <span id="accounts"></span>
        <a href="#adduser"><svg>
                <use href="#i-adduser" />
            </svg></a>
        </h1>
    </nav>
    <div id="timeline"></div>
    <div id="status"></div>
    <div id="account"></div>

    <div id="write">
        <div class="editthread" attach="0">
            <div class="post">
                <input type="text" id="in_reply_to_id" />
                <textarea desc="text" placeholder="What's on your mind?"></textarea>
                <label class="button"><input type="file" accept="image/*" /><svg>
                        <use href="#camera" />
                    </svg></label>
            </div>
            <div class="media_attachments">
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
                <div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                    <button class="piccancel"><svg>
                            <use href="#cancel" />
                        </svg></button>
                </div>
            </div>
        </div>
        <select id="visibility">
            <option value="public">Public</option>
            <option value="unlisted">Unlisted</option>
            <option value="private">Private</option>
            <option value="direct">Mentions</option>
        </select>
        <select id="lang">
            <option value="fr">FR</option>
            <option value="en">EN</option>
        </select>
        <button id="bplus"><svg>
                <use href="#plus" />
            </svg></button>
        <button id="toob"><svg>
                <use href="#send" />
            </svg></button>
        <!-- <div id="log"></div> -->
    </div>
    <div id="search">
        <input type="text" placeholder="Search terms" />
    </div>
    <div id="login">
        <input type="text" id="instance" placeholder="https://piaille.fr" />
        <button id="loginb">Se connecter</button>
    </div>
    <div id="modal">
        <div class="modal-content">
            <span class="close"><svg>
                    <use href="#cancel" />
                </svg></span>
            <p>Some text in the Modal..</p>
            <button class="OK">OK</button>
        </div>

    </div>
    <script>
        navigator.serviceWorker.register('service-worker.js', { scope: '.' })
            .then(function (registration) {
                console.log('Service worker registered successfully');
            }).catch(function (e) {
                console.error('Error during service worker registration:', e);
            });
        //login dance
        account = window.localStorage.getItem('activeAccount')
        code = new URLSearchParams(window.location.search).get('code')
        if (code) {//we got a code back from a user consenting to login
            fd = new FormData();
            clients = JSON.parse(window.localStorage.getItem('clients'))
            // console.log(clients)
            inst = window.localStorage.getItem('instance')
            fd.append('client_id', clients[inst].client_id)
            fd.append('client_secret', clients[inst].client_secret)
            fd.append('grant_type', 'authorization_code')
            fd.append('redirect_uri', window.location.protocol + '//' + window.location.host + window.location.pathname)
            fd.append('code', code)
            fd.append('scope', 'read write')
            majax(inst + "/oauth/token", {
                method: 'POST',
                data: {
                    client_id: clients[inst].client_id, client_secret: clients[inst].client_secret, grant_type: 'authorization_code',
                    redirect_uri: window.location.protocol + '//' + window.location.host + window.location.pathname,
                    code: code, scope: 'read write'
                },
                success: function (data) {
                    // console.log(JSON.parse(this.response))
                    // window.localStorage.setItem('at', JSON.parse(this.response).access_token)
                    accounts = JSON.parse(window.localStorage.getItem('accounts') || '[]')
                    accounts.push({ instance: inst, at: JSON.parse(data).access_token })
                    window.localStorage.setItem('accounts', JSON.stringify(accounts))
                    window.localStorage.removeItem('instance')
                    window.location.href = window.location.pathname
                }
            }
            )
            // ojax('POST', inst + "/oauth/token", fd,
            //     function (e) {
            //         if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
            //         }
            //     }
            // )
        }
        s('#loginb').onclick = function () {
            inst = s('#instance').value
            if (inst.substring(0, 8) != 'https://') inst = 'https://' + inst

            clients = JSON.parse(window.localStorage.getItem('clients')) || {}
            if (!clients[inst]) { // we first need a client_id/client_secret to connect to this instance
                // fd = new FormData()
                // fd.append('client_name', 'Toob')
                // fd.append('redirect_uris', window.location.protocol + '//' + window.location.host + window.location.pathname)
                // fd.append('scopes', 'read write')
                // fd.append('website', "https://github.com/teddyber/toob")

                majax(inst + "/api/v1/apps", {
                    method: 'POST',
                    data: {
                        client_name: 'Toob', redirect_uris: window.location.protocol + '//' + window.location.host + window.location.pathname,
                        scopes: 'read write', website: "https://github.com/teddyber/toob"
                    }, success: function (data) {
                        data = JSON.parse(data)
                        // clients = {}
                        clients[inst] = { 'client_id': data.client_id, 'client_secret': data.client_secret }
                        window.localStorage.setItem('clients', JSON.stringify(clients))
                        window.localStorage.setItem('instance', inst)
                        window.location.href = `${inst}/oauth/authorize?client_id=${data.client_id}&scope=read+write&redirect_uri=${window.location.protocol + '//' + window.location.host + window.location.pathname}&response_type=code`
                    }
                })
                // ojax('POST', inst + "/api/v1/apps", fd, function () {
                //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                //     }
                // })
            }
            else {
                window.localStorage.setItem('instance', inst)
                window.location.href = `${inst}/oauth/authorize?client_id=${JSON.parse(window.localStorage.getItem('clients'))[inst].client_id}&scope=read+write&redirect_uri=${window.location.protocol + '//' + window.location.host + window.location.pathname}&response_type=code`
            }
        }

        whichTimeline = '';
        lastAccountId = '';
        lastStatusId = '';
        maxId = 999999999999999999
        waitingFor = 999999999999999999

        window.addEventListener('hashchange', (event) => {
            display();
        });


        function s(p) { return document.querySelector(p); }// Select node from Pattern
        function sa(p) { return document.querySelectorAll(p); }// Select All nodes from Pattern
        function n(h) { return document.createRange().createContextualFragment(h) } // create Node from Html

        function getInstance(account) {
            return JSON.parse(window.localStorage.getItem('accounts') || '{}')[account] ? JSON.parse(window.localStorage.getItem('accounts') || '{}')[account].instance : null
        }
        function display() {
            s('body').append(s('#write'))
            hash = window.location.hash.split('/')[0]
            switch (hash) {
                case '#logout':
                    accounts = JSON.parse(window.localStorage.getItem('accounts'))
                    delete accounts[account]
                    window.localStorage.setItem('accounts', JSON.stringify(accounts))
                    // window.localStorage.removeItem('at')
                    window.localStorage.removeItem('instance')
                    window.location.href = window.location.pathname;
                    break;
                case '#adduser':
                    showOnly('#login')
                    break;
                case '#login':
                    showOnly('#login')
                    break;
                case '#home':
                    showOnly('#timeline')
                    updateTimeline('timelines/home', window.location.hash.split('/')[1]);
                    break;
                case '#trend':
                    showOnly('#timeline')
                    updateTimeline('timelines/trend');
                    break;
                case '#notifications':
                    showOnly('#timeline')
                    updateNotifications('notifications', window.location.hash.split('/')[1]);
                    break;
                case '#write':
                    showOnly('#write')
                    s('#write div.editthread:last-of-type textarea').focus()
                    break;
                case '#public':
                    showOnly('#timeline')
                    updateTimeline('timelines/public');
                    break;
                case '#search':
                    showOnly('#search')
                    updateSearch(window.location.hash.substring(8));
                    break;
                case '#tags':
                    showOnly('#timeline')
                    updateTimeline('timelines/tag/' + window.location.hash.split('/')[1], window.location.hash.split('/')[2]);
                    break;
                case '#account':
                    showOnly('#account')
                    updateAccount(window.location.hash.substring(9));
                    break;
                case '#status':
                    showOnly('#status')
                    updateStatus(window.location.hash.substring(8))
                    break;

                default:
                    break;
            }
        }
        function updateSearch(term) {
            s('#search input').value = term
            s('#search input').focus()
            // s('#search input').change()
        }
        s('#search input').onchange = function () {
            window.location.hash = '#search/' + this.value
            majax(getInstance(account) + "/api/v2/search?resolve=true&q=" + this.value, {
                success: function (data) {
                    data = JSON.parse(data)
                    sa('#search .status, #search .account, #search .hashtags').forEach(e => { e.remove() })
                    data.accounts.forEach(e => { s('#search').append(n(`<div class="account"><a href="#account/${e.id}"><img class="avatar" src="${e.avatar}"/>${e.display_name} (${e.acct})</a></div>`)) })
                    data.hashtags.forEach(e => { s('#search').append(n(`<div class="hashtags"><a href="#tag/${e.name}">#${e.name}</a></div>`)) })
                    data.statuses.forEach(e => { s('#search').append(n(displayStatus(e, account))) })
                }
            })
            // ojax('GET', getInstance(account) + "/api/v2/search?resolve=true&q=" + this.value, null, function () {
            //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
            //     }
            // })
        }
        function showModal(text, confirm) {
            s('#modal p').innerHTML = text
            s('#modal').style.display = 'block'
            s('#modal button.OK').onclick = function () { confirm(); s('#modal').style.display = 'none' }
        }
        s('.close').onclick = function () { s('#modal').style.display = 'none' }
        s('#modal').onclick = function () { s('#modal').style.display = 'none' }
        function showOnly(div) {
            sa('body > div').forEach(e => { e.style.display = 'none' })
            s(div).style.display = 'block'
            sa('nav a').forEach(e => { e.classList.remove('active') })
            if (s(`[href^="${window.location.hash}"]`)) s(`[href^="${window.location.hash}"]`).classList.add('active')
        }
        function getAT(account) {
            return JSON.parse(window.localStorage.getItem('accounts') || '[]')[account] ? JSON.parse(window.localStorage.getItem('accounts') || '[]')[account].at : null
        }
        function updateTimeline(which, account = 0) {
            trend = false
            if (which == 'timelines/trend') {
                trend = true
                feed = 'timelines/home'
            }
            else feed = which
            if (which != whichTimeline) {
                whichTimeline = which + '/' + account
                maxId = 999999999999999999
                waitingFor = 999999999999999999

                s('#timeline').textContent = ''
                majax(getInstance(account) + '/api/v1/' + feed + '?limit=40', {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        JSON.parse(data).forEach(el => {
                            if (!trend || el.replies_count + el.reblogs_count + el.favourites_count > 0) {
                                s('#timeline').append(n(displayStatus(el, account)))
                                if (s('[in_reply_to_id="s' + el.id + '"]')) { // put parent up in the timeline if there's a reply
                                    console.log('ici')
                                    s('[in_reply_to_id="s' + account + '-' + el.id + '"]').parentNode.insertBefore(s('#s' + account + '-' + el.id), s('[in_reply_to_id="s' + account + '-' + el.id + '"]'))
                                }
                                maxId = Math.min(maxId, el.id)  //  remmeber oldest toot for scrolling
                                sa('[in_reply_to_id="s' + account + '-' + el.id + '"]').forEach(c => {
                                    s('#s' + account + '-' + el.id).appendChild(c)
                                })
                            }
                        });
                        tweak();
                    }
                })
            }
        }
        function lookForNewNotif() {
            majax(getInstance(account) + '/api/v1/notifications', {
                headers: {
                    'Authorization': 'Bearer ' + getAT(account)
                }, success: function (data) {
                    // ojax('GET', getInstance() + '/api/v1/notifications', null, function () {
                    // if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    newestNotif = JSON.parse(data)[0].id
                    if (newestNotif > window.localStorage.getItem('lastnotif')) {
                        s('[href="#notifications"]').classList.add('new')
                    }
                    // }
                }
            })
            // setInterval(lookForNewNotif, 5000)
        }
        setInterval(lookForNewNotif, 5000)
        function getAccount(account) {
            return new Promise(resolve => {
                // ojax('GET', getInstance() + '/api/v1/accounts/verify_credentials', null, function () {
                // if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                majax(getInstance(account) + '/api/v1/accounts/verify_credentials', {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        resolve(JSON.parse(data))
                    }
                })
            })
        }
        function getAccounts() {
            return new Promise(resolve => {
                accts = JSON.parse(window.localStorage.getItem('accounts'))
                r = []
                // rem = account
                for (i = 0; i < accts.length; i++) {
                    // account = i
                    r.push(getAccount(i).then(r => { return r }))
                }
                // account = rem
                resolve(Promise.all(r))
            })
        }
        accounts = ''
        a = getAccounts().then(a => {
            accounts = a
            if (window.location.hash == '') {
                if (accounts.length > 0)
                    window.location.hash = `#home/${account}`;
                else
                    window.location.hash = '#login';
            } else {
                display()
            }
            displayAccounts()
            displaySideNav()
            return a
        })
        function displayAccounts() {
            i = 0
            accounts.forEach(a => {
                // console.log(a)
                s('#accounts').append(n(`<span><img acct="${i}" class="${i == account ? 'active' : ''}" src="${a.avatar}"/></span>`))
                i++
            })
            sa('#accounts img').forEach(i => {
                i.onclick = function () {
                    sa('#accounts img').forEach(i => {
                        i.classList.remove('active')
                    })
                    // console.log(this.getAttribute('acct'));
                    account = this.getAttribute('acct');
                    window.localStorage.setItem('activeAccount', account)
                    this.classList.add('active')
                    whichTimeline = ''
                    display()
                }
            })
        }
        function displaySideNav() {
            i = 0
            accounts.forEach(a => {
                // console.log(a)
                s('#sidenav h1').append(n(`<a href="#home/${i}"><svg><use href="#home" /></svg><img src="${a.avatar}"/></a>`))
                s('#sidenav h1').append(n(`<a href="#public/${i}"><svg><use href="#public" /></svg><img src="${a.avatar}"/></a>`))
                s('#sidenav h1').append(n(`<a href="#notifications/${i}"><svg><use href="#bell" /></svg><img src="${a.avatar}"/></a>`))
                i++
            })
        }
        function updateNotifications(which, account = 0) {
            if (which != whichTimeline) {
                whichTimeline = which + '/' + account
                s('#timeline').textContent = ''
                majax(getInstance(account) + '/api/v1/' + which, {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {

                        // ojax('GET', getInstance(account) + '/api/v1/' + which, null, function () {
                        // if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                        JSON.parse(data).forEach(e => {
                            // console.log(e)
                            if (!window.localStorage.getItem('lastnotif')) window.localStorage.setItem('lastnotif', 1) //init
                            window.localStorage.setItem('lastnotif', Math.max(parseInt(window.localStorage.getItem('lastnotif')), parseInt(e.id)))
                            switch (e.type) {
                                case 'follow':
                                    s('#timeline').append(n(`<div class="notif"><p>
                                        <a href="#account/${e.account.id}">
                                            <img class="avatar" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> followed you!</p></div>`))
                                    break;
                                case 'reblog':
                                    s('#timeline').append(n(`<div class="notif"><p><a href="#account/${e.account.id}">
                                            <img class="avatar" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> reblogged your status!</p>
                                ${displayStatus(e.status, account)}</div>`))
                                    break;
                                case 'update':
                                    s('#timeline').append(n(`<div class="notif"><p><a href="#account/${e.account.id}">
                                            <img class="avatar" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> updated their status!</p>
                                ${displayStatus(e.status, account)}</div>`))
                                    break;
                                case 'favourite':
                                    s('#timeline').append(n(`<div class="notif"><p><a href="#account/${e.account.id}">
                                            <img class="avatar" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> favourited your status!</p>
                                ${displayStatus(e.status, account)}</div>`))
                                    break;
                                case 'mention':
                                    s('#timeline').append(n(`<div class="notif"><p><a href="#account/${e.account.id}">
                                            <img class="avatar" src="${e.account.avatar}"/>
                                            ${replaceEmojis(e.account.emojis, e.account.display_name)} (${e.account.acct})
                                        </a> mentioned you!</p>
                                ${displayStatus(e.status, account)}</div>`))
                                    break;
                                case 'poll':
                                    s('#timeline').append(n(`<div class="notif"><p>A poll you participated in ended!</p>
                                ${displayStatus(e.status, account)}</div>`))
                                    break;
                                default:
                                    console.log(e)
                                    break;
                            }
                        })
                        // }
                    }
                })
                sa('[href^="#notifications"]').forEach(e => { e.classList.remove('new') })
            }
        }
        function updateStatus(id) {
            var [acct, statusId] = id.split('/')
            console.log([acct, statusId])
            if (acct != account) {//we want to display the toot as seen from the currentAccount
                majax(getInstance(acct) + '/api/v1/statuses/' + statusId, {
                    headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                    success: function (data) {
                        console.log(JSON.parse(data).uri)
                        majax(getInstance(account) + "/api/v2/search?resolve=true&q=" + JSON.parse(data).uri, {
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function (data) {
                                updateStatus(account + '/' + JSON.parse(data).statuses[0].id)
                            }
                        })

                        // updateStatus()
                    }
                })
            } else {
                if (id == lastStatusId) return;
                lastStatusId = id;
                s('#status').innerHTML = '';
                majax(getInstance(acct) + '/api/v1/statuses/' + statusId, {
                    headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                    success: function (data) {
                        // ojax('GET', getInstance(account) + '/api/v1/statuses/' + id, new FormData(), function (e) {
                        //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                        current = JSON.parse(data)
                        majax(getInstance(acct) + '/api/v1/statuses/' + (current.reblog ? current.reblog.id : statusId) + '/context', {
                            headers: { 'Authorization': 'Bearer ' + getAT(acct) },
                            success: function (data) {
                                // ojax('GET', getInstance(acct) + '/api/v1/statuses/' + (current.reblog ? current.reblog.id : statusId) + '/context', new FormData(), function (e) {
                                //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                                i = 0;
                                // data = JSON.parse(this.response)
                                data = JSON.parse(data)
                                data.ancestors.forEach(element => {
                                    s('#status').append(n(displayStatus(element, acct, (i == 0 ? 'top' : 'ancestor'), 't')));
                                    i++
                                });
                                c = current.reblog ? current.reblog : current
                                s('#status').append(n(displayStatus(c, acct, 'focus' + (i == 0 ? ' top' : ''), 't')));

                                data.descendants.forEach(element => {
                                    s('#t' + acct + '-' + element.in_reply_to_id).append(n(displayStatus(element, acct, 'thread', 't')));
                                });
                                tweak();
                                //     }
                                // })
                            }
                        }
                        )
                    }
                })
            }
        }
        function updateAccount(id) {
            if (id == lastAccountId) return;
            lastAccountId = id;
            s('#account').innerHTML = '';
            majax(getInstance(account) + '/api/v1/accounts/' + id, {
                success: function (data) {
                    data = JSON.parse(data)
                    console.log(data)
                    html = `
                    <img class="header" src="${data.header}"/>
                    <img class="avatar" src="${data.avatar}"/>
                    <button id="follow" acct="${data.id}"></button>
                    <div class="dn">${data.display_name}</div>
                    <div class="acct">${data.acct}</div>
                    <div class="note">${data.note}</div>
                    <div class="follows">Follows ${data.following_count}</div>
                    <div class="followed">Followed by ${data.followers_count}</div>
                    <div class="statuses">Statuses ${data.statuses_count}</div>
                    `
                    s('#account').innerHTML = html
                    s('#follow').onclick = function () {
                        ajax('POST', getInstance(account) + '/api/v1/accounts/' + id + `/${this.innerText == 'Follow' ? '' : 'un'}follow`, null, function () {
                            if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                                s('#follow').innerText = s('#follow').innerText == 'Follow' ? 'Unfollow' : 'Follow'
                            }
                        })
                    }
                    majax(getInstance(account) + `/api/v1/accounts/relationships?id[]=${id}`, {
                        headers: { 'Authorization': 'Bearer ' + getAT(account) },
                        success: function (data) {
                            r = JSON.parse(data)
                            // console.log(r)
                            s('#follow').innerText = r[0].following ? 'Unfollow' : 'Follow'
                            if (r[0].followed_by) { s('.follows').append(' including you') }

                        }
                    })
                    // ojax('GET', getInstance(account) + `/api/v1/accounts/relationships?id[]=${id}`, null, function (e) {
                    //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    //     }
                    // })
                }
            })
            // ojax('GET', getInstance(account) + '/api/v1/accounts/' + id, null, function (e) {
            //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {

            //     }
            // })
            majax(getInstance(account) + `/api/v1/accounts/${id}/statuses?limit=40`, {
                success: function (data) {
                    JSON.parse(data).forEach(e => {
                        s('#account').append(n(displayStatus(e, account)))
                    })
                    tweak();
                }
            })
            // ojax('GET', getInstance(account) + `/api/v1/accounts/${id}/statuses?limit=40`, null, function (e) {
            //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
            //     }
            // })
        }
        function fav(statusId, statusUri, from, unfav = false) {
            console.log([statusId, statusUri, from, unfav])
            var [acct, id] = statusId.split('-');
            if (acct != from) {
                console.log('tesst')
                majax(getInstance(from) + "/api/v2/search?resolve=true&q=" + statusUri, {
                    headers: { 'Authorization': 'Bearer ' + getAT(from) },
                    success: function (data) {
                        data = JSON.parse(data)
                        console.log(data)
                        fav(from + '-' + data.statuses[0].id, statusUri, from, unfav)
                    }
                })
            } else {
                console.log('ici')
                majax(getInstance(from) + `/api/v1/statuses/${id}/${unfav ? 'un' : ''}favourite`, {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + getAT(from) },
                    success: function (data) {
                        unfav ? s(`[uri="${statusUri}"`).classList.remove('fav') : s(`[uri="${statusUri}"`).classList.add('fav')
                    }
                })
            }
        }
        function reb(statusId, statusUri, from, unreb = false) {
            var [acct, id] = statusId.split('-');
            if (acct != from) {
                majax(getInstance(from) + "/api/v2/search?resolve=true&q=" + statusUri, {
                    headers: { 'Authorization': 'Bearer ' + getAT(from) },
                    success: function (data) {
                        data = JSON.parse(data)
                        reb(from + '-' + data.statuses[0].id, statusUri, from, unreb)
                    }
                })
            } else {
                majax(getInstance(from) + `/api/v1/statuses/${id}/${unreb ? 'un' : ''}reblog`, {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + getAT(from) },
                    success: function (data) {
                        unreb ? s(`[uri="${statusUri}"`).classList.remove('reb') : s(`[uri="${statusUri}"`).classList.add('reb')
                    }
                })
            }
        }
        function tweak() {
            //activate links
            sa('.actions .fav').forEach(e => {
                e.onclick = function () {
                    st = this.parentNode.parentNode
                    fav(st.getAttribute('id'), st.getAttribute('uri'), account, st.classList.contains('fav'))
                }
            })
            sa('.actions .reb').forEach(e => {
                e.onclick = function () {
                    st = this.parentNode.parentNode
                    reb(st.getAttribute('id'), st.getAttribute('uri'), account, st.classList.contains('reb'))
                }
            })
            // sa('.actions .reb').forEach(e => {
            //     e.onclick = function () {
            //         st = this.parentNode.parentNode
            //         id = this.parentNode.parentNode.getAttribute('id').substring(1);
            //         prefix = this.parentNode.parentNode.classList.contains('reb') ? 'un' : '';
            //         ojax('POST', getInstance(account) + `/api/v1/statuses/${id}/${prefix}reblog`, null, function (e) {
            //             if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
            //                 prefix == 'un' ? st.classList.remove('reb') : st.classList.add('reb')
            //             }
            //         })
            //     }
            // })
            sa('.actions .del').forEach(e => {
                e.onclick = function () {
                    id = this.parentNode.parentNode.getAttribute('id').substring(1);

                    confirm = showModal('Confirmer la suppression?', function () {
                        ajax('DELETE', getInstance(account) + `/api/v1/statuses/${id}`, null, function (e) {
                            if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                                whichTimeline = ''
                                display()
                            }
                        })
                    })
                }
            })

            sa('a.hashtag').forEach(e => { e.removeAttribute('target') })
            sa('.actions .rep, .actions .quo').forEach(e => {
                e.onclick = function () {
                    id = this.parentNode.parentNode.getAttribute('id').substring(1);
                    if (id.split('-')[0] != account) {
                        majax(getInstance(account) + "/api/v2/search?resolve=true&q=" + this.parentNode.parentNode.getAttribute('uri'), {
                            headers: { 'Authorization': 'Bearer ' + getAT(account) },
                            success: function (data) {
                                data = JSON.parse(data)
                                s('#in_reply_to_id').setAttribute('value', data.statuses[0].id)

                                // reb(from + '-' + data.statuses[0].id, statusUri, from, unreb)
                            }
                        })
                    }
                    else {
                        s('#in_reply_to_id').setAttribute('value', id)
                    }
                    this.parentNode.parentNode.append(s('#write'))
                    s('#write').style.display = 'block'
                    s('#write textarea').value = '@' + this.getAttribute('author') + ' ' + this.getAttribute('mentions') + ' '
                    s('#write textarea').focus();
                    end = s('#write textarea').selectionEnd
                    start = s('#write textarea').selectionStart - this.getAttribute('mentions').length
                    s('#write textarea').value += `
${this.getAttribute('tags')}`
                    if (this.classList.contains('quo')) {
                        s('#write textarea').value += `
${this.getAttribute('href')}`
                    }
                    s('#write textarea').style.height = Math.max(s('#write textarea').scrollHeight, 50) + 'px';
                    s('#write textarea').selectionStart = start - 1
                    s('#write textarea').selectionEnd = end - 1
                }
            })
            sa('.vote').forEach(e => {
                e.onclick = function () {
                    poll_id = this.getAttribute('id').split('_')[1]
                    own_votes = Array.from(sa('[name="option_' + poll_id + '[]"]:checked')).map(function (i) { return i.getAttribute('id').split('_')[2] })
                    fd = new FormData()
                    fd.append('choices[]', own_votes)
                    majax(getInstance(account) + `/api/v1/polls/${poll_id}/votes`), {
                        method: 'POST', headers: '',
                        data: { 'choices[]': own_votes },
                        success: function (data) {
                            whichTimeline = ''
                            display()
                        }
                    }
                    // ojax('POST', getInstance(account) + `/api/v1/polls/${poll_id}/votes`, fd, function () {
                    //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    //     }
                    // })
                }
            })
        }
        function vote(statusId, statusUri, from, ownvotes) {
            var [acct, id] = statusId.split('-')
        }
        function ajax(method, url, params, success) {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = success;
            xhttp.open(method, url, true);
            at = JSON.parse(window.localStorage.getItem('accounts') || '[]')[account] ? JSON.parse(window.localStorage.getItem('accounts') || '[]')[account].at : null
            if (at) xhttp.setRequestHeader('Authorization', 'Bearer ' + at)
            if (params)
                xhttp.send(params);
            else
                xhttp.send()
        }
        function majax(url, params) {
            xhr = new XMLHttpRequest()
            xhr.onreadystatechange = function () {
                if (params.success && this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    params.success(this.response, this)
                }
                if (params.wait && this.readyState == XMLHttpRequest.DONE && this.status == 206) {
                    params.wait(this.response, this)
                }
            }
            xhr.open(params.method || 'GET', url, true)
            if (params.headers) {
                Object.keys(params.headers).forEach(k => {
                    xhr.setRequestHeader(k, params.headers[k])
                })
            }
            fd = null
            if (params.data) {
                fd = new FormData()
                Object.keys(params.data).forEach(k => {
                    Array.isArray(params.data[k]) ? params.data[k].forEach(v => { fd.append(k, v) }) : fd.append(k, params.data[k])
                })
            }
            xhr.send(fd || null)
        }
        function convertHTTPtoUri(http){
            var [h,n,i,a] = http.split('/')
            return a.substring(1)+'@'+i
        }
        function displayStatus(el, acct, cssClass = '', id_prefix = 's') {
            console.log(el)
            if (el.reblog) {
                boost = `<a href="#account/${el.account.id}"><img src="${el.account.avatar}"/> ${replaceEmojis(el.account.emojis, el.account.display_name)}</a> boosted`;
                e = el.reblog;
            } else {
                boost = ''
                e = el;
            }
            // e.card ? console.log(e.card) : '';
            // e.poll ? console.log(e.poll) : ''
            return `<div uri="${e.uri}" id="${id_prefix}${acct}-${e.id}" ${e.in_reply_to_id ? `in_reply_to_id="${id_prefix}${acct}-${e.in_reply_to_id}"` : ''} class="status${e.favourited ? ' fav' : ''}${e.reblogged ? ' reb' : ''} ${cssClass}">
            <div class="boost">${boost}</div>
            <div class="reply_to"></div>
            <div class="author"><a href="#account/${e.account.id}"><img src="${e.account.avatar}"/> ${replaceEmojis(e.account.emojis, e.account.display_name)} <span class="account">(${e.account.acct})</span></a></div>
            <div class="actions">
                ${accounts[acct].id == e.account.id ? '<span class="edit"><svg><use href="#pen" /></svg></span>' : ''}
                ${accounts[acct].id == e.account.id ? '<span class="del"><svg><use href="#cancel" /></svg></span>' : ''}
                <span class="link"><a href="#status/${acct}/${e.id}"><svg><use href="#tree" /></svg></a></span> 
                <span class="rep" author="${e.account.acct.indexOf('@')!=-1?e.account.acct:convertHTTPtoUri(e.account.url)}" mentions="${e.mentions.map(function (m) { return `@${m.acct.indexOf('@')!=-1?m.acct:convertHTTPtoUri(m.url)}` }).join(' ')}" 
                tags="${e.tags.map(function (t) { return `#${t.name}` }).join(' ')}"><svg><use href="#rep" /></svg>(${e.replies_count})</span>
                <span class="quo" author="${e.account.acct}" mentions="${e.mentions.map(function (m) { return `@${m.acct}` }).join(' ')}" href="${e.url}"
                tags="${e.tags.map(function (t) { return `#${t.name}` }).join(' ')}"><svg><use href="#quote" /></svg></span>
                <span class="reb"><svg><use href="#reb" /></svg>(${e.reblogs_count})</span> 
                <span class="fav"><svg><use href="#star" /></svg>(${e.favourites_count})</span>
            </div>
            <div class="text">${replaceMentions(e.mentions, replaceEmojis(e.emojis, e.content).replace(/href=\"https:\/\/[\w.\/]+\/tags\/(\w+)/g, `href="#tags/$1/${acct}`), acct)}</div>
            ${e.poll && !e.poll.voted && !e.poll.expired ? '<div class="poll">' + e.poll.options.map(function (o, i) { return `<div><input type="${e.poll.multiple ? 'checkbox' : 'radio'}" name="option_${e.poll.id}[]" id="option_${e.poll.id}_${i}"/><label for="option_${e.poll.id}_${i}">${o.title}</label></div>` }).join('') + `<div><button class="vote" id="poll_${e.poll.id}">Vote!</button></div><div>${e.poll.votes_count} voters</div></div>` : ''}
            ${e.poll && (e.poll.voted || e.poll.expired) ? '<div class="poll">' + e.poll.options.map(function (o, i) { return `<div  class="${e.poll.own_votes.includes(i) ? 'gras' : ''}">${o.title} : ${Math.round(o.votes_count / e.poll.voters_count * 100)}%</div><div style="height:6px;width:${o.votes_count / e.poll.voters_count * 100}%;background-color:var(--highlight)"></div>` }).join('') + `</div><div>${e.poll.votes_count} voters</div>` : ''}
            <div class="media${e.media_attachments.length > 1 ? ' multi' : ''}">${e.media_attachments.map(function (m) {
                if (m.type == 'image') return `<img alt="${m.description}" title="${m.description}" aria-label="${m.description}" src="${m.preview_url}"/>`;
                if (m.type == 'video') return `<video src="${m.url}" poster="${m.preview_url}" controls volume="1" aria-label="${m.description}" title="${m.description}"></video>`
                if (m.type == 'gifv') return `<video src="${m.url}" poster="${m.preview_url}" autoplay loop volume="1" aria-label="${m.description}" title="${m.description}"></video>`
            }).join('')}</div>
            ${e.card ? (e.card.type == 'video' ? `<div class="iframe">${e.card.html}</div>` : `<div class="card"><a href="${e.card.url}">
                ${e.card.image ? `<img src="${e.card.image}"/>` : ''}
                <div class="provider">${e.card.provider_name}</div>
                <div class="title">${e.card.title}</div>
                <div class="desc">${e.card.description}</div>
            </a></div>`) : ''}
        </div>`
        }
        function replaceMentions(array, text, acct) {
            array.forEach(m => {
                text = text.replaceAll(`href="${m.url}"`, `href="#account/${acct}/${m.id}"`).replaceAll('target="_blank"', '')
            })
            return text
        }
        function replaceEmojis(array, text) {
            array.forEach(e => {
                text = text.replaceAll(':' + e.shortcode + ':', '<img class="emoji" alt="' + e.shortcode + '" title="' + e.shortcode + '" src="' + e.url + '"/>')
            })
            return text
        }
        function resize_textarea() {
            this.style.overflow = 'hidden';
            this.style.height = 0;
            this.style.height = Math.max(this.scrollHeight, 300) + 'px';
        }
        sa('textarea').forEach(e => {
            e.onkeyup = resize_textarea;
        })
        s('#bplus').onclick = function () {
            s('#bplus').parentNode.insertBefore(n(`<div class="editthread" attach="0"><div class="post">
                                                    <textarea name="status[]" placeholder="And then..."></textarea>
                                                    <label class="button"><input type="file" accept="image/*"/><svg><use href="#camera" /></svg></label>
                                                    <button class="cancel"><svg><use href="#cancel" /></svg></button>
                                                    </div>
                                                    <div class="media_attachments">
                                                        ${`<div><img class="media" /><textarea class="desc" placeholder="Image description"></textarea>
                                                            <button class="piccancel"><svg>
                                                                    <use href="#cancel" />
                                                                </svg></button>
                                                        </div>`.repeat(4)}
                                                    </div>
                                                   </div>`), s('#bplus'))
            tweakFileInput()
            s('#write div.editthread:last-of-type textarea').focus()
            sa('textarea').forEach(e => {
                e.onkeyup = resize_textarea;
            })
            sa('.cancel').forEach(e => { e.onclick = function () { this.parentNode.remove() } })
        }

        function tweakFileInput() {
            sa('input[type="file"]').forEach(e => {
                e.onchange = function (ev) {
                    if (parseInt(e.parentNode.parentNode.parentNode.getAttribute('attach')) < 4) {
                        var file = this.files[0];
                        t = this
                        var reader = new FileReader();
                        reader.onload = function () {
                            editthread = t.parentNode.parentNode.parentNode
                            attach = parseInt(editthread.getAttribute('attach'))
                            editthread.querySelector(`.media_attachments div:nth-child(${attach + 1}) img.media`).src = this.result; //input=>label>.post>.editthread => .media_attachments
                            editthread.querySelector(`.media_attachments>div:nth-child(${attach + 1})`).style.display = 'block'
                            editthread.setAttribute('attach', attach + 1)
                        };
                        reader.readAsDataURL(file);
                    }
                }
            })
            sa('.piccancel').forEach(b => {
                b.onclick = function () {
                    editthread = this.parentNode.parentNode.parentNode
                    editthread.setAttribute('attach', parseInt(editthread.getAttribute('attach')) - 1)
                    this.parentNode.querySelector('img').src = '';
                    this.parentNode.style.display = 'none';
                    this.parentNode.parentNode.append(this.parentNode)
                }
            })
            sa('.media_attachments img').forEach(i => {
                i.onload = function () {
                    if (this.src.substring(0, 4) == 'http' && this.complete && this.naturalHeight != 1) {
                        textarea = this.parentNode.parentNode.parentNode.querySelector('textarea')
                        t = this
                        src = this.src
                        majax('pj.php?url=' + this.src, {
                            success: function (data, xhr) {
                                textarea.value = textarea.value.replace(src, '') // remove URL from textarea
                                t.src = 'data:' + xhr.getResponseHeader('content-type') + ';base64, ' + data
                                t.parentNode.style.display = 'block'
                                editthread = t.parentNode.parentNode.parentNode //img>div>.media_attachments>.editthread
                                editthread.setAttribute('attach', parseInt(editthread.getAttribute('attach')) + 1)
                            }
                        })
                        // ojax('GET', 'pj.php?url=' + this.src, null, function () {
                        //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                        //     }
                        // })
                    }
                }
            })
            sa('textarea').forEach(e => { //div.bla //paste image directly
                // e.onpaste = function (ev) {
                //     d = ev.clipboardData || window.clipboardData
                //     // console.log(d)
                //     // s('#log').innerHTML += d
                //     for (i = 0; i < d.items.length; i++) {
                //         console.log(d.items[i].type.indexOf('text'))
                //         if (d.items[i].type.indexOf('text') == 0) d.items[i].getAsString(data => {
                //             if (a = new URL(data)) {
                //                 console.log(a)
                //                 // s('#log').innerHTML += a

                //                 e.after(n(`<img id="test" />`))//onload="javascript: s('#log').innerHTML += this.complete && this.naturalHeight"/>`))
                //                 s('#test').onload = function () {
                //                     console.log(this.complete && this.naturalHeight)
                //                     console.log(this.src)
                //                     // s('#log').innerHTML += src

                //                     // var img = new Image();
                //                     // img.src = document.getElementById("test").src;
                //                     // console.log(img)
                //                     // var canvas = document.getElementById("canvas");
                //                     // var context = canvas.getContext("2d");
                //                     // context.drawImage(img, 40, 40);
                //                 }
                //                 s('#test').setAttribute('src', data)
                //                 // ajax('GET', data, null, function () {
                //                 //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                //                 //         console.log(this.response)
                //                 //     }
                //                 // })
                //                 // im = s('#test')
                //                 // console.log(im.complete && im.naturalHeight)
                //             }
                //             i = n(data)
                //             console.log(i)
                //             // e.after(n)
                //         })
                //         // if(d.items[i].type.indexOf('image')==0)  console.log(d.items[i].getAsFile(data=>{console.log(data)}))
                //     }
                // }
                // e.onkeyup = function(){
                //     s('#log').append(n(`<div>${'ici'}</div>`))

                // }
                e.oninput = function (ev) { //paste or inject GIF URL

                    if ((ev.inputType == 'insertText' || ev.inputType == 'insertFromPaste' || ev.inputType == 'insertCompositionText') && ev.data.substring(0, 4) == 'http' && (url = new URL(ev.data))) {
                        attach = parseInt(e.parentNode.parentNode.getAttribute('attach'))
                        e.parentNode.parentNode.querySelector(`.media_attachments div:nth-child(${attach + 1}) img.media`).src = ev.data
                    }
                }
            })

        }
        tweakFileInput()
        const sleep = ms => {
            return new Promise(resolve => setTimeout(resolve, ms))
        }
        const uploadFile = (toot, i) => { //uploads and then checks upload is finished
            return new Promise((resolve, reject) => {
                const file = DataURIToBlob(toot.querySelector(`.media_attachments div:nth-child(${i + 1}) img`).getAttribute('src'))
                // const fd = new FormData();
                // fd.append('file', file, 'test.png')
                // fd.append('description', toot.querySelector(`.media_attachments div:nth-child(${i + 1}) textarea`).value)
                majax(getInstance(account) + '/api/v2/media', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    data: { file: file, description: toot.querySelector(`.media_attachments div:nth-child(${i + 1}) textarea`).value },
                    success: async function (data) {
                        id = await checkUpload(JSON.parse(data).id).then(r => { return r })
                        resolve(JSON.parse(data))
                    }
                })
                // ojax('POST', getInstance(account) + '/api/v2/media', fd, async function () {
                //     if (this.readyState == XMLHttpRequest.DONE && (this.status == 200 || this.status == 202)) {
                //     }
                // })
            })
        }
        async function toot(toots, i, in_reply_to_id = '') { // toots multiple toots in a row
            if (toots.length <= i) {//finished
                cleanUpWrite()
                return
            }

            const uploads = []
            medias = toots[i].querySelectorAll('.media_attachments div')
            toots[i].querySelectorAll('textarea').forEach(t => { t.disabled = true })
            max = parseInt(toots[i].getAttribute('attach'))
            for (j = 0; j < max; j++) { //loop on img
                uploads.push(uploadFile(toots[i], j).then(r => { return r.id }))
            }
            const results = await Promise.all(uploads) //uploads and wait for each to be ready
            fd = new FormData();
            fd.append('status', toots[i].querySelector('.post textarea').value)
            fd.append('visibility', s('#visibility').value.toLowerCase())
            fd.append('language', s('#lang').value)
            results.forEach(r => { fd.append('media_ids[]', r) }) // attach all medias
            if (in_reply_to_id && in_reply_to_id != '') fd.append('in_reply_to_id', in_reply_to_id)

            majax(getInstance(account) + '/api/v1/statuses', {
                method: 'POST',
                data: { status: toots[i].querySelector('.post textarea').value, visibility: s('#visibility').value.toLowerCase(), language: s('#lang').value, 'media_ids[]': results },
                headers: { 'Authorization': 'Bearer ' + getAT(account) },
                success: function (data) {
                    toots[i].style.display = 'none'
                    toot(toots, i + 1, JSON.parse(data).id) // toot next one
                }
            })
            // ojax('POST', getInstance(account) + '/api/v1/statuses', fd, function () {
            //     if (this.readyState == XMLHttpRequest.DONE && (this.status == 200 || this.status == 202)) {
            //     }
            // })
        }
        s('#toob').onclick = function () {
            toots = sa('.editthread')
            //check media descriptions
            t = true
            toots.forEach(toot => {
                texts = toot.querySelectorAll('.media_attachments div[style*="block"] textarea')
                texts.forEach(desc => {
                    if (!desc.value) {
                        t = false
                    }
                })
            })
            if (t) {
                toot(toots, 0, s('#in_reply_to_id').getAttribute('value'))
            }
        }
        sa('nav a').forEach(a => { a.onclick = function () { if (this.classList.contains('active')) window.scrollTo({ top: 0, behavior: 'smooth' }); } })
        function checkUpload(id) {
            return new Promise((resolve, reject) => {
                majax(getInstance(account) + '/api/v1/media/' + id, {
                    headers: { 'Authorization': 'Bearer ' + getAT(account) },
                    success: function (data) {
                        resolve(id);// finished
                    },
                    wait: function (data) {
                        sleep(1000).then(v => { resolve(checkUpload(id)) })
                    }
                })
                // ojax('GET', getInstance(account) + '/api/v1/media/' + id, null, function () {
                //     if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                //     }
                //     if (this.readyState == XMLHttpRequest.DONE && this.status == 206) {
                //     }
                // })
            })
        }
        function cleanUpWrite() {
            sa('#write .editthread:not(:first-child)').forEach(t => { t.remove() }) ///remove additional textareas
            s('#write .editthread').setAttribute('attach', 0)
            s('#write .editthread').style.display = 'block'
            sa('#write img').forEach(i => { i.src = '' }) //reset media attachments
            sa('#write .editthread textarea').forEach(t => { t.value = ''; t.disabled = false })//reset remaining texteareas (alt texts)
            attach = false // reset attachment status
            sa('.media_attachments>div').forEach(d => { d.style.display = 'none' })  //hide media attachments 
            s('#account').after(s('#write'))//move #write back to its place
            whichTimeline = ''
            display()
        }
        function DataURIToBlob(dataURI) {
            const splitDataURI = dataURI.split(',')
            const byteString = splitDataURI[0].indexOf('base64') >= 0 ? atob(splitDataURI[1]) : decodeURI(splitDataURI[1])
            const mimeString = splitDataURI[0].split(':')[1].split(';')[0]

            const ia = new Uint8Array(byteString.length)
            for (let i = 0; i < byteString.length; i++)
                ia[i] = byteString.charCodeAt(i)

            return new Blob([ia], { type: mimeString })
        }

        window.onscroll = function (ev) {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
                wt = whichTimeline.split('/')
                switch (wt[1]) {
                    case 'home':
                        feed = wt[0] + '/' + wt[1]
                        acct = wt[2]
                        break;
                    case 'public':
                        feed = wt[0] + '/' + wt[1]
                        acct = wt[2]
                        break;
                    case 'tag':
                        feed = wt[0] + '/' + wt[1] + '/' + wt[2]
                        acct = wt[3]
                        break;

                    default:
                        break;
                }
                console.log(whichTimeline)
                trend = (timeline == '#trend')
                // feed = trend ? 'timelines/home' : wt[0]+'/'+wt[1]
                if (waitingFor > maxId) {
                    console.log(getInstance(acct) + '/api/v1/' + feed + '?limit=40&max_id=' + maxId)
                    majax(getInstance(acct) + '/api/v1/' + feed + '?limit=40&max_id=' + maxId, {
                        headers: { 'Authorization': 'Bearer ' + getAT(acct) }, success: function (data) {
                            JSON.parse(data).forEach(el => {
                                if (!trend || el.replies_count + el.reblogs_count + el.favourites_count > 0) {
                                    s('#timeline').append(n(displayStatus(el, acct)))
                                    maxId = Math.min(maxId, el.id)
                                    sa('[in_reply_to_id="s' + el.id + '"]').forEach(c => {
                                        s('#s' + el.id).appendChild(c)
                                    })
                                }
                            })
                            tweak();
                        }
                    })
                    // ojax('GET', getInstance(account) + '/api/v1/' + feed + '?limit=40&max_id=' + maxId, null, function () {
                    //     if (this.readyState == 4 && this.status == 200) {
                    //     }
                    // })
                    waitingFor = maxId
                }
            }
        }

        /* TODOS
            CW support
            remote instances public/home timeline and interaction with local account
            compose a poll
            keyboard nav
            edit toot
            modal colors
            column title in topnav
        */
    </script>
</body>

</html>